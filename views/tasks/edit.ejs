<%- include('../partials/header', { title: title }) %>

<div class="row justify-content-center">
    <div class="col-lg-8">
            <!-- 页面标题 -->
            <div class="mb-4">
                <h2>
                    <i class="fas fa-edit me-2 text-primary"></i>
                    编辑任务
                </h2>
                <p class="text-muted mb-0">
                    修改任务信息和分配
                </p>
            </div>

            <!-- 编辑表单 -->
            <div class="card">
                <div class="card-body">
                    <form action="/tasks/<%= task.id %>/edit" method="POST" class="needs-validation" novalidate>
                        <!-- 基本信息 -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="title" class="form-label">任务标题 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="title" name="title" value="<%= task.title %>" required>
                                <div class="invalid-feedback">请输入任务标题</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="description" class="form-label">任务描述 <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="description" name="description" rows="4" required><%= task.description %></textarea>
                                <div class="invalid-feedback">请输入任务描述</div>
                            </div>
                        </div>

                        <!-- 项目信息 -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">所属大陆</label>
                                <div class="form-control-plaintext bg-light border rounded px-3 py-2">
                                    <i class="fas fa-globe me-2 text-primary"></i>
                                    [<%= task.project.key %>] <%= task.project.name %>
                                </div>
                                <div class="form-text">任务所属的探险大陆</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="taskType" class="form-label">任务类型</label>
                                <select class="form-select" id="taskType" name="taskType">
                                    <option value="task" <%= task.taskType === 'task' ? 'selected' : '' %>>探险行动（任务）</option>
                                    <option value="requirement" <%= task.taskType === 'requirement' ? 'selected' : '' %>>探险计划（需求）</option>
                                    <option value="bug" <%= task.taskType === 'bug' ? 'selected' : '' %>>魔物讨伐（Bug）</option>
                                    <option value="epic" <%= task.taskType === 'epic' ? 'selected' : '' %>>史诗委托（史诗）</option>
                                    <option value="story" <%= task.taskType === 'story' ? 'selected' : '' %>>探险委托（故事）</option>
                                </select>
                            </div>
                        </div>

                        <!-- 任务属性 -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="starLevel" class="form-label">星级难度 <span class="text-danger">*</span></label>
                                <select class="form-select" id="starLevel" name="starLevel" required>
                                    <option value="">选择难度</option>
                                    <option value="1" <%= task.starLevel === 1 ? 'selected' : '' %>>⭐ 一星 - 简单任务（半天内）</option>
                                    <option value="2" <%= task.starLevel === 2 ? 'selected' : '' %>>⭐⭐ 二星 - 常规任务（1-2天）</option>
                                    <option value="3" <%= task.starLevel === 3 ? 'selected' : '' %>>⭐⭐⭐ 三星 - 复杂任务（3-5天）</option>
                                    <option value="4" <%= task.starLevel === 4 ? 'selected' : '' %>>⭐⭐⭐⭐ 四星 - 核心任务（1-2周）</option>
                                    <option value="5" <%= task.starLevel === 5 ? 'selected' : '' %>>⭐⭐⭐⭐⭐ 五星 - 关键任务（2周以上）</option>
                                </select>
                                <div class="invalid-feedback">请选择任务难度</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="skillRequired" class="form-label">技能要求 <span class="text-danger">*</span></label>
                                <select class="form-select" id="skillRequired" name="skillRequired" required>
                                    <option value="">选择技能</option>
                                    <option value="novice" <%= task.skillRequired === 'novice' ? 'selected' : '' %>>🔰 新手</option>
                                    <option value="bronze" <%= task.skillRequired === 'bronze' ? 'selected' : '' %>>🥉 铜牌</option>
                                    <option value="silver" <%= task.skillRequired === 'silver' ? 'selected' : '' %>>🥈 银牌</option>
                                    <option value="gold" <%= task.skillRequired === 'gold' ? 'selected' : '' %>>🥇 金牌</option>
                                    <option value="diamond" <%= task.skillRequired === 'diamond' ? 'selected' : '' %>>💎 钻石</option>
                                </select>
                                <div class="invalid-feedback">请选择技能要求</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="urgencyLevel" class="form-label">紧急程度</label>
                                <select class="form-select" id="urgencyLevel" name="urgencyLevel">
                                    <option value="normal" <%= task.urgencyLevel === 'normal' ? 'selected' : '' %>>📅 普通</option>
                                    <option value="important" <%= task.urgencyLevel === 'important' ? 'selected' : '' %>>⚡ 重要</option>
                                    <option value="urgent" <%= task.urgencyLevel === 'urgent' ? 'selected' : '' %>>🔥 紧急</option>
                                    <option value="delayed" <%= task.urgencyLevel === 'delayed' ? 'selected' : '' %>>🕐 延后</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="status" class="form-label">任务状态</label>
                                <select class="form-select" id="status" name="status">
                                    <option value="draft" <%= task.status === 'draft' ? 'selected' : '' %>>
                                        <i class="fas fa-edit"></i> 草稿
                                    </option>
                                    <option value="published" <%= task.status === 'published' ? 'selected' : '' %>>
                                        <i class="fas fa-bullhorn"></i> 已发布
                                    </option>
                                    <option value="bidding" <%= task.status === 'bidding' ? 'selected' : '' %>>
                                        <i class="fas fa-gavel"></i> 竞标中
                                    </option>
                                    <option value="assigned" <%= task.status === 'assigned' ? 'selected' : '' %>>
                                        <i class="fas fa-user-check"></i> 已分配
                                    </option>
                                    <option value="in_progress" <%= task.status === 'in_progress' ? 'selected' : '' %>>
                                        <i class="fas fa-play"></i> 进行中
                                    </option>
                                    <option value="review" <%= task.status === 'review' ? 'selected' : '' %>>
                                        <i class="fas fa-search"></i> 待审核
                                    </option>
                                    <option value="completed" <%= task.status === 'completed' ? 'selected' : '' %>>
                                        <i class="fas fa-check"></i> 已完成
                                    </option>
                                    <option value="cancelled" <%= task.status === 'cancelled' ? 'selected' : '' %>>
                                        <i class="fas fa-times"></i> 已取消
                                    </option>
                                </select>
                                <div class="form-text">根据任务进展选择合适的状态</div>
                            </div>
                        </div>

                        <!-- 奖励设置 -->
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label for="baseReward" class="form-label">基础奖励 <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="baseReward" name="baseReward" min="1" value="<%= task.baseReward %>" required>
                                <div class="invalid-feedback">请输入基础奖励</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="bonusReward" class="form-label">奖励金</label>
                                <input type="number" class="form-control" id="bonusReward" name="bonusReward" min="0" value="<%= task.bonusReward %>">
                                <div class="form-text">按时完成可获得</div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="rewardCurrency" class="form-label">奖励货币</label>
                                <select class="form-select" id="rewardCurrency" name="rewardCurrency">
                                    <option value="gold" <%= task.rewardCurrency === 'gold' ? 'selected' : '' %>>
                                        <i class="fas fa-coins" style="color: #ffd700;"></i> 金币
                                    </option>
                                    <option value="silver" <%= task.rewardCurrency === 'silver' ? 'selected' : '' %>>
                                        <i class="fas fa-coins" style="color: #c0c0c0;"></i> 银币
                                    </option>
                                    <option value="copper" <%= task.rewardCurrency === 'copper' ? 'selected' : '' %>>
                                        <i class="fas fa-coins" style="color: #2d5016;"></i> 铜币
                                    </option>
                                    <option value="diamond" <%= task.rewardCurrency === 'diamond' ? 'selected' : '' %>>
                                        <i class="fas fa-gem" style="color: #00bcd4;"></i> 钻石
                                    </option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">总预算</label>
                                <div class="form-control-plaintext fw-bold" id="totalBudget"><%= task.totalBudget %></div>
                            </div>
                        </div>

                        <!-- 时间设置 -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="estimatedHours" class="form-label">预估工时（小时）</label>
                                <input type="number" class="form-control" id="estimatedHours" name="estimatedHours" min="0.5" step="0.5" value="<%= task.estimatedHours || '' %>">
                                <div class="form-text">用于工时管理和奖励计算</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dueDate" class="form-label">截止日期</label>
                                <input type="date" class="form-control" id="dueDate" name="dueDate" value="<%= task.dueDate ? new Date(task.dueDate).toISOString().split('T')[0] : '' %>">
                            </div>
                        </div>

                        <!-- 人员分配 -->
                        <% if (projectMembers && projectMembers.length > 0) { %>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <h6 class="text-primary">
                                        <i class="fas fa-users me-2"></i>人员分配
                                    </h6>
                                    <div class="form-text mb-3">为任务分配负责人、协助人员和审核人员</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="assigneeId" class="form-label">负责人</label>
                                    <select class="form-select" id="assigneeId" name="assigneeId">
                                        <option value="">选择负责人</option>
                                        <% projectMembers.forEach(member => { %>
                                            <option value="<%= member.user.id %>" <%= task.assigneeId === member.user.id ? 'selected' : '' %>>
                                                <%= member.user.firstName %> <%= member.user.lastName %>
                                                <% if (member.user.role === 'product_manager') { %>（产品经理）
                                                <% } else if (member.user.role === 'developer') { %>（开发者）
                                                <% } else if (member.user.role === 'tester') { %>（测试工程师）
                                                <% } else if (member.user.role === 'ui_designer') { %>（UI设计师）
                                                <% } else if (member.user.role === 'devops') { %>（运维工程师）
                                                <% } else if (member.user.role === 'client') { %>（客户）
                                                <% } else { %>（<%= member.user.role %>）<% } %>
                                            </option>
                                        <% }); %>
                                    </select>
                                    <div class="form-text">主要负责任务执行的人员</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="assistantIds" class="form-label">协助人员</label>
                                    <select class="form-select" id="assistantIds" name="assistantIds" multiple>
                                        <% projectMembers.forEach(member => { %>
                                            <option value="<%= member.user.id %>" <%= task.assistantIds && task.assistantIds.includes(member.user.id) ? 'selected' : '' %>>
                                                <%= member.user.firstName %> <%= member.user.lastName %>
                                                <% if (member.user.role === 'product_manager') { %>（产品经理）
                                                <% } else if (member.user.role === 'developer') { %>（开发者）
                                                <% } else if (member.user.role === 'tester') { %>（测试工程师）
                                                <% } else if (member.user.role === 'ui_designer') { %>（UI设计师）
                                                <% } else if (member.user.role === 'devops') { %>（运维工程师）
                                                <% } else if (member.user.role === 'client') { %>（客户）
                                                <% } else { %>（<%= member.user.role %>）<% } %>
                                            </option>
                                        <% }); %>
                                    </select>
                                    <div class="form-text">协助完成任务的人员（可多选）</div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="reviewerId" class="form-label">审核人员</label>
                                    <select class="form-select" id="reviewerId" name="reviewerId">
                                        <option value="">选择审核人员</option>
                                        <% projectMembers.forEach(member => { %>
                                            <option value="<%= member.user.id %>" <%= task.reviewerId === member.user.id ? 'selected' : '' %>>
                                                <%= member.user.firstName %> <%= member.user.lastName %>
                                                <% if (member.user.role === 'product_manager') { %>（产品经理）
                                                <% } else if (member.user.role === 'developer') { %>（开发者）
                                                <% } else if (member.user.role === 'tester') { %>（测试工程师）
                                                <% } else if (member.user.role === 'ui_designer') { %>（UI设计师）
                                                <% } else if (member.user.role === 'devops') { %>（运维工程师）
                                                <% } else if (member.user.role === 'client') { %>（客户）
                                                <% } else { %>（<%= member.user.role %>）<% } %>
                                            </option>
                                        <% }); %>
                                    </select>
                                    <div class="form-text">负责审核任务完成情况的人员</div>
                                </div>
                            </div>
                        <% } %>

                        <!-- 提交按钮 -->
                        <div class="row">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-between">
                                    <a href="/tasks/<%= task.id %>" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left me-2"></i>返回
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save me-2"></i>
                                        保存修改
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 计算总预算
    function updateTotalBudget() {
        const baseReward = parseInt($('#baseReward').val()) || 0;
        const bonusReward = parseInt($('#bonusReward').val()) || 0;
        const total = baseReward + bonusReward;
        $('#totalBudget').text(total.toLocaleString());
    }

    // 监听奖励输入变化
    $('#baseReward, #bonusReward').on('input', updateTotalBudget);

    // 表单验证
    $('form').on('submit', function(e) {
        const form = this;
        if (!form.checkValidity()) {
            e.preventDefault();
            e.stopPropagation();
        }
        form.classList.add('was-validated');
    });

    // 初始化总预算显示
    updateTotalBudget();
});
</script>

<%- include('../partials/footer') %>

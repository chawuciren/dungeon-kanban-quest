<%- include('../partials/header', { title: title }) %>

<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-beer me-2 text-primary"></i>
                    ä»»åŠ¡
                </h2>
                <p class="text-muted mb-0">
                    <% if (selectedProject) { %>
                        å½“å‰é¡¹ç›®ï¼š[<%= selectedProject.key %>] <%= selectedProject.name %> çš„ä»»åŠ¡å§”æ‰˜
                    <% } else { %>
                        å‘ç°é€‚åˆæ‚¨æŠ€èƒ½ç­‰çº§çš„èµé‡‘ä»»åŠ¡
                    <% } %>
                </p>
            </div>
            <div class="btn-group">
                <%
                    const currentQuery = new URLSearchParams();
                    Object.keys(filters).forEach(key => {
                        if (filters[key] && filters[key] !== '') {
                            currentQuery.set(key, filters[key]);
                        }
                    });
                    const queryString = currentQuery.toString();
                    const queryPrefix = queryString ? '?' + queryString : '';
                %>
                <a href="/tasks<%= queryPrefix %>" class="btn btn-primary active">
                    <i class="fas fa-list me-1"></i>åˆ—è¡¨è§†å›¾
                </a>
                <a href="/tasks/tree<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-sitemap me-1"></i>æ ‘å½¢è§†å›¾
                </a>
                <a href="/tasks/kanban<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-columns me-1"></i>çœ‹æ¿è§†å›¾
                </a>
                <a href="/tasks/gantt<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-chart-gantt me-1"></i>ç”˜ç‰¹è§†å›¾
                </a>
            </div>
            <a href="/tasks/create<%= queryPrefix ? queryPrefix + '&' : '?' %>view=list" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                å‘å¸ƒä»»åŠ¡
            </a>
        </div>
    </div>
</div>

<!-- ç­›é€‰å™¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="/tasks" id="filterForm">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">æ˜Ÿçº§éš¾åº¦</label>
                            <select class="form-select" name="starLevel">
                                <option value="">å…¨éƒ¨æ˜Ÿçº§</option>
                                <option value="1" <%= filters.starLevel == '1' ? 'selected' : '' %>>â­ ä¸€æ˜Ÿä»»åŠ¡</option>
                                <option value="2" <%= filters.starLevel == '2' ? 'selected' : '' %>>â­â­ äºŒæ˜Ÿä»»åŠ¡</option>
                                <option value="3" <%= filters.starLevel == '3' ? 'selected' : '' %>>â­â­â­ ä¸‰æ˜Ÿä»»åŠ¡</option>
                                <option value="4" <%= filters.starLevel == '4' ? 'selected' : '' %>>â­â­â­â­ å››æ˜Ÿä»»åŠ¡</option>
                                <option value="5" <%= filters.starLevel == '5' ? 'selected' : '' %>>â­â­â­â­â­ äº”æ˜Ÿä»»åŠ¡</option>
                            </select>
                        </div>

                        <div class="col-md-3">
                            <label class="form-label">ç´§æ€¥ç¨‹åº¦</label>
                            <select class="form-select" name="urgencyLevel">
                                <option value="">å…¨éƒ¨ç¨‹åº¦</option>
                                <option value="urgent" <%= filters.urgencyLevel == 'urgent' ? 'selected' : '' %>>ğŸ”¥ ç´§æ€¥</option>
                                <option value="important" <%= filters.urgencyLevel == 'important' ? 'selected' : '' %>>âš¡ é‡è¦</option>
                                <option value="normal" <%= filters.urgencyLevel == 'normal' ? 'selected' : '' %>>ğŸ“… æ™®é€š</option>
                                <option value="delayed" <%= filters.urgencyLevel == 'delayed' ? 'selected' : '' %>>ğŸ• å»¶å</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">ä»»åŠ¡çŠ¶æ€</label>
                            <select class="form-select" name="status">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="draft" <%= filters.status == 'draft' ? 'selected' : '' %>>è‰ç¨¿</option>
                                <option value="published" <%= filters.status == 'published' ? 'selected' : '' %>>å·²å‘å¸ƒ</option>
                                <option value="bidding" <%= filters.status == 'bidding' ? 'selected' : '' %>>ç«æ ‡ä¸­</option>
                                <option value="assigned" <%= filters.status == 'assigned' ? 'selected' : '' %>>å·²åˆ†é…</option>
                                <option value="in_progress" <%= filters.status == 'in_progress' ? 'selected' : '' %>>è¿›è¡Œä¸­</option>
                                <option value="review" <%= filters.status == 'review' ? 'selected' : '' %>>å¾…å®¡æ ¸</option>
                                <option value="completed" <%= filters.status == 'completed' ? 'selected' : '' %>>å·²å®Œæˆ</option>
                                <option value="cancelled" <%= filters.status == 'cancelled' ? 'selected' : '' %>>å·²å–æ¶ˆ</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">å¥–åŠ±è´§å¸</label>
                            <select class="form-select" name="rewardCurrency">
                                <option value="">å…¨éƒ¨è´§å¸</option>
                                <option value="diamond" <%= filters.rewardCurrency == 'diamond' ? 'selected' : '' %>>
                                    <i class="fas fa-gem" style="color: #00bcd4;"></i> é’»çŸ³
                                </option>
                                <option value="gold" <%= filters.rewardCurrency == 'gold' ? 'selected' : '' %>>
                                    <i class="fas fa-coins" style="color: #ffd700;"></i> é‡‘å¸
                                </option>
                                <option value="silver" <%= filters.rewardCurrency == 'silver' ? 'selected' : '' %>>
                                    <i class="fas fa-coins" style="color: #c0c0c0;"></i> é“¶å¸
                                </option>
                                <option value="copper" <%= filters.rewardCurrency == 'copper' ? 'selected' : '' %>>
                                    <i class="fas fa-coins" style="color: #2d5016;"></i> é“œå¸
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label class="form-label">æœç´¢å…³é”®è¯</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="search" value="<%= filters.search || '' %>" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜æˆ–æè¿°...">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-end">
                            <div class="btn-group" role="group">
                                <%
                                    function buildQueryString(params) {
                                        const queryParts = [];
                                        Object.keys(params).forEach(key => {
                                            if (params[key] && params[key] !== '') {
                                                queryParts.push(encodeURIComponent(key) + '=' + encodeURIComponent(params[key]));
                                            }
                                        });
                                        return queryParts.join('&');
                                    }

                                    const sortParams = {...filters};
                                    delete sortParams.sort;
                                %>
                                <a href="?<%= buildQueryString(sortParams) %>"
                                   class="btn btn-outline-primary <%= !filters.sort || filters.sort === '' ? 'active' : '' %>">
                                    <i class="fas fa-clock me-1"></i>æœ€æ–°
                                </a>
                                <a href="?<%= buildQueryString({...sortParams, sort: 'reward'}) %>"
                                   class="btn btn-outline-primary <%= filters.sort === 'reward' ? 'active' : '' %>">
                                    <i class="fas fa-coins me-1"></i>å¥–åŠ±
                                </a>
                                <a href="?<%= buildQueryString({...sortParams, sort: 'deadline'}) %>"
                                   class="btn btn-outline-primary <%= filters.sort === 'deadline' ? 'active' : '' %>">
                                    <i class="fas fa-calendar me-1"></i>æˆªæ­¢
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-filter me-1"></i>åº”ç”¨ç­›é€‰
                            </button>
                            <a href="/tasks" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-1"></i>æ¸…é™¤ç­›é€‰
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div id="tasksList">
            <% if (tasks && tasks.length > 0) { %>
                <% tasks.forEach(function(task) { %>
                    <div class="card mb-3 task-card">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="card-title mb-0"><%= task.title %></h5>
                                        <div class="task-meta">
                                            <span class="badge bg-warning me-1">
                                                <% for(let i = 0; i < task.starLevel; i++) { %>â­<% } %>
                                            </span>
                                            <%
                                            const statusConfig = {
                                                'draft': { text: 'è‰ç¨¿', class: 'secondary', icon: 'fas fa-edit' },
                                                'published': { text: 'å·²å‘å¸ƒ', class: 'primary', icon: 'fas fa-bullhorn' },
                                                'bidding': { text: 'ç«æ ‡ä¸­', class: 'info', icon: 'fas fa-gavel' },
                                                'assigned': { text: 'å·²åˆ†é…', class: 'warning', icon: 'fas fa-user-check' },
                                                'in_progress': { text: 'è¿›è¡Œä¸­', class: 'warning', icon: 'fas fa-play' },
                                                'review': { text: 'å¾…å®¡æ ¸', class: 'info', icon: 'fas fa-search' },
                                                'completed': { text: 'å·²å®Œæˆ', class: 'success', icon: 'fas fa-check' },
                                                'cancelled': { text: 'å·²å–æ¶ˆ', class: 'danger', icon: 'fas fa-times' }
                                            };
                                            const currentStatus = statusConfig[task.status] || statusConfig['draft'];
                                            %>

                                        </div>
                                    </div>

                                    <!-- å¯ç¼–è¾‘å­—æ®µåŒºåŸŸ -->
                                    <div class="row mb-2">
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted">çŠ¶æ€</label>
                                            <select class="form-select form-select-sm quick-edit-field"
                                                    data-task-id="<%= task.id %>"
                                                    data-field="status">
                                                <option value="draft" <%= task.status === 'draft' ? 'selected' : '' %>>è‰ç¨¿</option>
                                                <option value="published" <%= task.status === 'published' ? 'selected' : '' %>>å·²å‘å¸ƒ</option>
                                                <option value="bidding" <%= task.status === 'bidding' ? 'selected' : '' %>>ç«æ ‡ä¸­</option>
                                                <option value="assigned" <%= task.status === 'assigned' ? 'selected' : '' %>>å·²åˆ†é…</option>
                                                <option value="in_progress" <%= task.status === 'in_progress' ? 'selected' : '' %>>è¿›è¡Œä¸­</option>
                                                <option value="review" <%= task.status === 'review' ? 'selected' : '' %>>å¾…å®¡æ ¸</option>
                                                <option value="completed" <%= task.status === 'completed' ? 'selected' : '' %>>å·²å®Œæˆ</option>
                                                <option value="cancelled" <%= task.status === 'cancelled' ? 'selected' : '' %>>å·²å–æ¶ˆ</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted">è´Ÿè´£äºº</label>
                                            <select class="form-select form-select-sm quick-edit-field"
                                                    data-task-id="<%= task.id %>"
                                                    data-field="assigneeId">
                                                <option value="">æœªåˆ†é…</option>
                                                <% if (task.project && task.project.members) { %>
                                                    <% task.project.members.forEach(function(member) { %>
                                                        <option value="<%= member.id %>" <%= task.assigneeId === member.id ? 'selected' : '' %>>
                                                            <%= (member.firstName + ' ' + member.lastName).trim() || member.username %>
                                                        </option>
                                                    <% }); %>
                                                <% } %>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted">ä¼˜å…ˆçº§</label>
                                            <select class="form-select form-select-sm quick-edit-field"
                                                    data-task-id="<%= task.id %>"
                                                    data-field="urgencyLevel">
                                                <option value="urgent" <%= task.urgencyLevel === 'urgent' ? 'selected' : '' %>>ğŸ”¥ ç´§æ€¥</option>
                                                <option value="important" <%= task.urgencyLevel === 'important' ? 'selected' : '' %>>âš¡ é‡è¦</option>
                                                <option value="normal" <%= task.urgencyLevel === 'normal' ? 'selected' : '' %>>ğŸ“… æ™®é€š</option>
                                                <option value="delayed" <%= task.urgencyLevel === 'delayed' ? 'selected' : '' %>>ğŸ• å»¶æœŸ</option>
                                                <option value="frozen" <%= task.urgencyLevel === 'frozen' ? 'selected' : '' %>>â„ï¸ å†»ç»“</option>
                                            </select>
                                        </div>
                                    </div>
                                    <p class="card-text text-muted"><%= task.description %></p>
                                    <div class="task-footer">
                                        <small class="text-muted">
                                            <i class="fas fa-user me-1"></i>å‘å¸ƒè€…ï¼š<%= task.publisher ? (task.publisher.firstName + ' ' + task.publisher.lastName) : 'æœªçŸ¥' %>
                                            <% if (task.estimatedHours) { %>
                                                <i class="fas fa-clock ms-3 me-1"></i>é¢„ä¼°ï¼š<%= task.estimatedHours %>å°æ—¶
                                            <% } %>
                                            <% if (task.dueDate) { %>
                                                <i class="fas fa-calendar ms-3 me-1"></i>æˆªæ­¢ï¼š<%= new Date(task.dueDate).toLocaleDateString('zh-CN') %>
                                            <% } %>
                                            <% if (task.project) { %>
                                                <i class="fas fa-project-diagram ms-3 me-1"></i>é¡¹ç›®ï¼š<%= task.project.name %>
                                            <% } %>
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="reward-info mb-3">
                                        <div class="h4 mb-1">
                                            <% if (task.rewardCurrency === 'diamond') { %>
                                                <i class="fas fa-gem me-1" style="color: #00bcd4;"></i>
                                            <% } else if (task.rewardCurrency === 'gold') { %>
                                                <i class="fas fa-coins me-1" style="color: #ffd700;"></i>
                                            <% } else if (task.rewardCurrency === 'silver') { %>
                                                <i class="fas fa-coins me-1" style="color: #c0c0c0;"></i>
                                            <% } else if (task.rewardCurrency === 'copper') { %>
                                                <i class="fas fa-coins me-1" style="color: #2d5016;"></i>
                                            <% } %>
                                            <%= (task.baseReward || 0) + (task.bonusReward || 0) %>
                                        </div>
                                        <small class="text-muted">
                                            åŸºç¡€ <%= task.baseReward || 0 %> + å¥–åŠ± <%= task.bonusReward || 0 %>
                                        </small>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <div class="btn-group" role="group">
                                            <a href="/tasks/<%= task.id %>" class="btn btn-outline-secondary btn-sm">
                                                <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                                            </a>
                                            <% if (user && (user.role === 'admin' || task.publisherId === user.id)) { %>
                                                <a href="/tasks/<%= task.id %>/edit" class="btn btn-outline-primary btn-sm">
                                                    <i class="fas fa-edit me-1"></i>ç¼–è¾‘
                                                </a>
                                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteTask('<%= task.id %>', '<%= task.title %>')">
                                                    <i class="fas fa-trash me-1"></i>åˆ é™¤
                                                </button>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                <% }); %>
            <% } else { %>
                <div class="text-center py-5">
                    <i class="fas fa-tasks fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">æš‚æ— ä»»åŠ¡</h5>
                    <p class="text-muted mb-3">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡</p>
                    <a href="/tasks" class="btn btn-outline-primary">
                        <i class="fas fa-refresh me-2"></i>æŸ¥çœ‹æ‰€æœ‰ä»»åŠ¡
                    </a>
                </div>
            <% } %>
        </div>

        <!-- åˆ†é¡µ -->
        <% if (pagination && pagination.totalPages > 1) { %>
            <nav aria-label="ä»»åŠ¡åˆ†é¡µ" class="mt-4">
                <ul class="pagination justify-content-center">
                    <% if (pagination.hasPrev) { %>
                        <li class="page-item">
                            <a class="page-link" href="?<%= buildQueryString({...filters, page: pagination.page - 1}) %>">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                    <% } %>

                    <% for (let i = Math.max(1, pagination.page - 2); i <= Math.min(pagination.totalPages, pagination.page + 2); i++) { %>
                        <li class="page-item <%= i === pagination.page ? 'active' : '' %>">
                            <a class="page-link" href="?<%= buildQueryString({...filters, page: i}) %>">
                                <%= i %>
                            </a>
                        </li>
                    <% } %>

                    <% if (pagination.hasNext) { %>
                        <li class="page-item">
                            <a class="page-link" href="?<%= buildQueryString({...filters, page: pagination.page + 1}) %>">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    <% } %>
                </ul>

                <div class="text-center mt-2">
                    <small class="text-muted">
                        ç¬¬ <%= pagination.page %> é¡µï¼Œå…± <%= pagination.totalPages %> é¡µï¼Œæ€»è®¡ <%= pagination.total %> ä¸ªä»»åŠ¡
                    </small>
                </div>
            </nav>
        <% } %>
    </div>
</div>



<script>
$(document).ready(function() {
    // ç­›é€‰è¡¨å•è‡ªåŠ¨æäº¤ï¼ˆå½“é€‰æ‹©æ¡†æ”¹å˜æ—¶ï¼‰
    $('#filterForm select').change(function() {
        $('#filterForm').submit();
    });

    // åˆå§‹åŒ–å¿«é€Ÿç¼–è¾‘å­—æ®µï¼Œä¿å­˜åŸå§‹å€¼
    $('.quick-edit-field').each(function() {
        const $select = $(this);
        $select.data('original-value', $select.val());
    });

    // å¿«é€Ÿç¼–è¾‘å­—æ®µå¤„ç†
    $('.quick-edit-field').change(function() {
        const $select = $(this);
        const taskId = $select.data('task-id');
        const field = $select.data('field');
        const value = $select.val();
        const originalValue = $select.data('original-value');

        // ç¦ç”¨é€‰æ‹©æ¡†å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $select.prop('disabled', true);
        $select.addClass('loading');

        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: `/tasks/${taskId}/quick-update`,
            method: 'POST',
            data: {
                field: field,
                value: value
            },
            success: function(response) {
                if (response.success) {
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast('success', response.message);
                    // æ›´æ–°åŸå§‹å€¼
                    $select.data('original-value', value);
                } else {
                    // æ¢å¤åŸå§‹å€¼
                    $select.val($select.data('original-value'));
                    showToast('error', response.message || 'æ›´æ–°å¤±è´¥');
                }
            },
            error: function(xhr) {
                // æ¢å¤åŸå§‹å€¼
                $select.val($select.data('original-value'));
                const errorMsg = xhr.responseJSON?.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
                showToast('error', errorMsg);
            },
            complete: function() {
                // æ¢å¤é€‰æ‹©æ¡†çŠ¶æ€
                $select.prop('disabled', false);
                $select.removeClass('loading');
            }
        });
    });
});

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(type, message) {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `);

    // æ·»åŠ åˆ°é¡µé¢
    let toastContainer = $('#toast-container');
    if (toastContainer.length === 0) {
        toastContainer = $('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>');
        $('body').append(toastContainer);
    }

    toastContainer.append(toast);

    // æ˜¾ç¤ºæç¤º
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();

    // è‡ªåŠ¨ç§»é™¤
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

// åˆ é™¤ä»»åŠ¡å‡½æ•°
function deleteTask(taskId, taskTitle) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${taskTitle}"å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä»»åŠ¡çš„æ‰€æœ‰ç›¸å…³æ•°æ®éƒ½å°†è¢«åˆ é™¤ã€‚`)) {
        // åˆ›å»ºè¡¨å•å¹¶æäº¤
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/tasks/${taskId}/delete`;

        // æ·»åŠ CSRF tokenï¼ˆå¦‚æœéœ€è¦ï¼‰
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}
</script>

<style>
.quick-edit-field.loading {
    opacity: 0.6;
    pointer-events: none;
}

.quick-edit-field.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 10px;
    width: 16px;
    height: 16px;
    margin-top: -8px;
    border: 2px solid #ccc;
    border-top-color: #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.task-card {
    transition: box-shadow 0.2s ease;
}

.task-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
</style>

<%- include('../partials/footer') %>

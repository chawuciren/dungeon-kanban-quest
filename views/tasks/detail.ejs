<%- include('../partials/header', { title: title }) %>

<%
// ç»Ÿä¸€çš„çŠ¶æ€é…ç½®
const statusConfig = {
    'draft': { text: 'è‰ç¨¿', class: 'secondary', icon: 'fas fa-edit' },
    'published': { text: 'å·²å‘å¸ƒ', class: 'primary', icon: 'fas fa-bullhorn' },
    'in_progress': { text: 'è¿›è¡Œä¸­', class: 'warning', icon: 'fas fa-play' },
    'review': { text: 'å¾…å®¡æ ¸', class: 'info', icon: 'fas fa-search' },
    'completed': { text: 'å·²å®Œæˆ', class: 'success', icon: 'fas fa-check' },
    'cancelled': { text: 'å·²å–æ¶ˆ', class: 'danger', icon: 'fas fa-times' }
};
const currentStatus = statusConfig[task.status] || statusConfig['draft'];
%>

<div class="row">
        <!-- ä¸»è¦å†…å®¹ -->
        <div class="col-lg-8">
            <!-- ä»»åŠ¡æ ‡é¢˜å’ŒåŸºæœ¬ä¿¡æ¯ -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- é¢åŒ…å±‘å¯¼èˆª -->
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/tasks">ä»»åŠ¡å¸‚åœº</a></li>
                            <% if (task.project) { %>
                                <li class="breadcrumb-item"><a href="/projects/<%= task.project.id %>"><%= task.project.name %></a></li>
                            <% } %>
                            <% if (task.parentTask) { %>
                                <li class="breadcrumb-item"><a href="/tasks/<%= task.parentTask.id %>"><%= task.parentTask.title %></a></li>
                            <% } %>
                            <li class="breadcrumb-item active"><%= task.title %></li>
                        </ol>
                    </nav>

                    <!-- è¿”å›æŒ‰é’® -->
                    <div class="mb-3">
                        <a href="/tasks" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>è¿”å›ä»»åŠ¡åˆ—è¡¨
                        </a>
                    </div>

                    <!-- ä»»åŠ¡æ ‡é¢˜ -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h2 class="mb-0">
                            <span class="me-2">
                                <%= task.taskType === 'requirement' ? 'ğŸ“‹' :
                                    task.taskType === 'epic' ? 'ğŸ°' :
                                    task.taskType === 'story' ? 'ğŸ“–' :
                                    task.taskType === 'dev_task' ? 'âš”ï¸' :
                                    task.taskType === 'design_task' ? 'ğŸ¨' :
                                    task.taskType === 'test_task' ? 'ğŸ¹' :
                                    task.taskType === 'devops_task' ? 'âš™ï¸' :
                                    task.taskType === 'bug' ? 'ğŸ›' : 'ğŸ“' %>
                            </span>
                            <%= task.title %>
                        </h2>
                        <div class="task-actions">
                            <!-- æ¥å•æŒ‰é’® -->
                            <% if (canBid) { %>
                                <form action="/tasks/<%= task.id %>/bid" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-hand-paper me-2"></i>æ¥å•
                                    </button>
                                </form>
                            <% } %>

                            <!-- çŠ¶æ€æ“ä½œæŒ‰é’® -->
                            <% if (user && (task.assigneeId === user.id || task.reviewerId === user.id || user.role === 'admin' || task.publisherId === user.id)) { %>
                                <% if (task.status === 'assigned' && task.assigneeId === user.id) { %>
                                    <form action="/tasks/<%= task.id %>/start" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-play me-2"></i>å¼€å§‹ä»»åŠ¡
                                        </button>
                                    </form>
                                <% } %>

                                <% if (['assigned', 'in_progress'].includes(task.status) && task.assigneeId === user.id) { %>
                                    <button type="button" class="btn btn-warning" onclick="showCompleteModal()">
                                        <i class="fas fa-check me-2"></i>å®Œæˆä»»åŠ¡
                                    </button>
                                <% } %>

                                <% if (task.status === 'review' && task.reviewerId === user.id) { %>
                                    <button type="button" class="btn btn-success" onclick="approveTask()">
                                        <i class="fas fa-check-circle me-2"></i>å®¡æ ¸é€šè¿‡
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="rejectTask()">
                                        <i class="fas fa-times-circle me-2"></i>å®¡æ ¸æ‹’ç»
                                    </button>
                                <% } %>
                            <% } %>

                            <!-- ç®¡ç†æŒ‰é’® -->
                            <%
                                // æ£€æŸ¥å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰ç¼–è¾‘æƒé™
                                let canEdit = false;
                                if (user) {
                                    // ç®¡ç†å‘˜å§‹ç»ˆæœ‰æƒé™
                                    if (user.role === 'admin') {
                                        canEdit = true;
                                    }
                                    // æˆ‘åˆ›å»ºçš„ä»»åŠ¡
                                    else if (task.publisherId === user.id) {
                                        canEdit = true;
                                    }
                                    // æˆ‘è´Ÿè´£çš„ä»»åŠ¡
                                    else if (task.assigneeId === user.id) {
                                        canEdit = true;
                                    }
                                    // æˆ‘å®¡æ ¸çš„ä»»åŠ¡
                                    else if (task.reviewerId === user.id) {
                                        canEdit = true;
                                    }
                                }
                            %>
                            <% if (canEdit) { %>
                                <a href="/tasks/<%= task.id %>/edit" class="btn btn-outline-primary">
                                    <i class="fas fa-edit me-2"></i>ç¼–è¾‘ä»»åŠ¡
                                </a>
                            <% } %>

                            <% if (task.level < 3) { %>
                                <a href="/tasks/create?parent=<%= task.id %>" class="btn btn-outline-secondary">
                                    <i class="fas fa-plus me-2"></i>æ·»åŠ å­ä»»åŠ¡
                                </a>
                            <% } %>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡å…ƒä¿¡æ¯ -->
                    <div class="row g-3 mb-4">
                        <div class="col-auto">
                            <span class="badge bg-warning fs-6">
                                <%= 'â­'.repeat(task.starLevel) %>
                            </span>
                        </div>

                        <div class="col-auto">
                            <span class="badge bg-info fs-6">
                                <% if (task.urgencyLevel === 'urgent') { %>ğŸ”¥ ç´§æ€¥
                                <% } else if (task.urgencyLevel === 'important') { %>âš¡ é‡è¦
                                <% } else if (task.urgencyLevel === 'normal') { %>ğŸ“… æ™®é€š
                                <% } else if (task.urgencyLevel === 'delayed') { %>ğŸ• å»¶å
                                <% } else if (task.urgencyLevel === 'frozen') { %>â„ï¸ å†»ç»“
                                <% } %>
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-<%= currentStatus.class %> fs-6">
                                <i class="<%= currentStatus.icon %> me-1"></i>
                                <%= currentStatus.text %>
                            </span>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡æè¿° -->
                    <div class="mb-4">
                        <h5>ä»»åŠ¡æè¿°</h5>
                        <div class="border rounded p-3 bg-light rich-text-content">
                            <%- task.description %>
                        </div>
                    </div>

                    <!-- ä»»åŠ¡å…³ç³» -->
                    <% if (task.parentTask || (subtasks && subtasks.length > 0) || (siblingTasks && siblingTasks.length > 0)) { %>
                        <div class="mb-4">
                            <h5><i class="fas fa-sitemap me-2"></i>ä»»åŠ¡å…³ç³»</h5>

                            <!-- çˆ¶ä»»åŠ¡ä¿¡æ¯ -->
                            <% if (task.parentTask) { %>
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-level-up-alt me-2"></i>çˆ¶ä»»åŠ¡
                                        </h6>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <a href="/tasks/<%= task.parentTask.id %>" class="text-decoration-none">
                                                    <strong><%= task.parentTask.title %></strong>
                                                </a>
                                                <% if (task.parentTask.status) { %>
                                                    <%
                                                    const parentStatus = statusConfig[task.parentTask.status] || statusConfig['draft'];
                                                    %>
                                                    <span class="badge bg-<%= parentStatus.class %> ms-2">
                                                        <%= parentStatus.text %>
                                                    </span>
                                                <% } %>
                                            </div>
                                            <a href="/tasks/<%= task.parentTask.id %>" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            <% } %>

                            <!-- åŒçº§ä»»åŠ¡ -->
                            <% if (siblingTasks && siblingTasks.length > 0) { %>
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-equals me-2"></i>åŒçº§ä»»åŠ¡ (<%= siblingTasks.length %>)
                                        </h6>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row g-2">
                                            <% siblingTasks.forEach(sibling => { %>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center py-1">
                                                        <div>
                                                            <a href="/tasks/<%= sibling.id %>" class="text-decoration-none">
                                                                <%= sibling.title %>
                                                            </a>
                                                            <%
                                                            const siblingStatus = statusConfig[sibling.status] || statusConfig['draft'];
                                                            %>
                                                            <span class="badge bg-<%= siblingStatus.class %> ms-2">
                                                                <%= siblingStatus.text %>
                                                            </span>
                                                        </div>
                                                        <small class="text-muted">
                                                            <%= 'â­'.repeat(sibling.starLevel) %>
                                                        </small>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                            <% } %>

                            <!-- å­ä»»åŠ¡æ¦‚è§ˆ -->
                            <% if (subtasks && subtasks.length > 0) { %>
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-level-down-alt me-2"></i>å­ä»»åŠ¡ (<%= subtasks.length %>)
                                            </h6>
                                            <% if (task.level < 3) { %>
                                                <a href="/tasks/create?parent=<%= task.id %>" class="btn btn-outline-success btn-sm">
                                                    <i class="fas fa-plus me-1"></i>æ·»åŠ å­ä»»åŠ¡
                                                </a>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        <!-- å­ä»»åŠ¡çŠ¶æ€ç»Ÿè®¡ -->
                                        <%
                                        const subtaskStats = {};
                                        subtasks.forEach(subtask => {
                                            const status = subtask.status || 'draft';
                                            subtaskStats[status] = (subtaskStats[status] || 0) + 1;
                                        });
                                        %>
                                        <div class="row g-2 mb-3">
                                            <% Object.keys(subtaskStats).forEach(status => { %>
                                                <%
                                                const statusInfo = statusConfig[status] || statusConfig['draft'];
                                                %>
                                                <div class="col-auto">
                                                    <span class="badge bg-<%= statusInfo.class %>">
                                                        <%= statusInfo.text %>: <%= subtaskStats[status] %>
                                                    </span>
                                                </div>
                                            <% }) %>
                                        </div>

                                        <!-- å­ä»»åŠ¡åˆ—è¡¨ -->
                                        <div class="list-group list-group-flush">
                                            <% subtasks.forEach(subtask => { %>
                                                <div class="list-group-item px-0 py-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="flex-grow-1">
                                                            <a href="/tasks/<%= subtask.id %>" class="text-decoration-none">
                                                                <strong><%= subtask.title %></strong>
                                                            </a>
                                                            <div class="mt-1">
                                                                <small class="text-muted">
                                                                    <%= 'â­'.repeat(subtask.starLevel) %>
                                                                    <% if (subtask.assignee) { %>
                                                                        | è´Ÿè´£äºº: <%= subtask.assignee.firstName %> <%= subtask.assignee.lastName %>
                                                                    <% } %>
                                                                    <% if (subtask.dueDate) { %>
                                                                        | æˆªæ­¢: <%= new Date(subtask.dueDate).toLocaleDateString('zh-CN') %>
                                                                    <% } %>
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <%
                                                            const subtaskStatus = statusConfig[subtask.status] || statusConfig['draft'];
                                                            %>
                                                            <span class="badge bg-<%= subtaskStatus.class %>">
                                                                <%= subtaskStatus.text %>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    <% } %>

                    <!-- è¯„è®ºåŒºå— -->
                    <div class="mb-4">
                        <h5 class="d-flex align-items-center justify-content-between">
                            <span>
                                <i class="fas fa-comments me-2"></i>
                                è¯„è®º (<%= totalComments || 0 %>)
                            </span>
                            <% if (commentsPagination && commentsPagination.totalPages > 1) { %>
                                <small class="text-muted">
                                    ç¬¬ <%= commentsPagination.page %> é¡µï¼Œå…± <%= commentsPagination.totalPages %> é¡µ
                                </small>
                            <% } %>
                        </h5>

                        <!-- æ–°å¢è¯„è®ºç¼–è¾‘å™¨ -->
                        <% if (user) { %>
                            <%- include('../partials/comment-editor', {
                                taskId: task.id,
                                editorId: 'mainCommentEditor',
                                placeholder: 'å†™ä¸‹æ‚¨çš„è¯„è®º...',
                                submitText: 'å‘å¸ƒè¯„è®º',
                                projectMembers: projectMembers || [],
                                parentCommentId: null,
                                replyToUserId: null,
                                replyToUser: null
                            }) %>
                        <% } else { %>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                è¯·å…ˆç™»å½•åå†å‘è¡¨è¯„è®º
                            </div>
                        <% } %>

                        <!-- è¯„è®ºåˆ—è¡¨ -->
                        <%- include('../partials/comment-list', {
                            comments: comments || [],
                            user: user
                        }) %>

                        <!-- è¯„è®ºåˆ†é¡µ -->
                        <% if (commentsPagination && commentsPagination.totalPages > 1) { %>
                            <nav aria-label="è¯„è®ºåˆ†é¡µ" class="mt-4">
                                <ul class="pagination justify-content-center">
                                    <% if (commentsPagination.hasPrev) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?commentsPage=<%= commentsPagination.page - 1 %>#comments">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                    <% } %>

                                    <% for (let i = Math.max(1, commentsPagination.page - 2); i <= Math.min(commentsPagination.totalPages, commentsPagination.page + 2); i++) { %>
                                        <li class="page-item <%= i === commentsPagination.page ? 'active' : '' %>">
                                            <a class="page-link" href="?commentsPage=<%= i %>#comments"><%= i %></a>
                                        </li>
                                    <% } %>

                                    <% if (commentsPagination.hasNext) { %>
                                        <li class="page-item">
                                            <a class="page-link" href="?commentsPage=<%= commentsPagination.page + 1 %>#comments">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    <% } %>
                                </ul>
                            </nav>
                        <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- ä¾§è¾¹æ  -->
        <div class="col-lg-4">
            <!-- å·¥æ—¶ä¿¡æ¯ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>å·¥æ—¶ä¿¡æ¯
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 fw-bold text-info">
                            <i class="fas fa-clock me-2"></i>
                            <%= task.estimatedHours || 0 %>
                        </div>
                        <small class="text-muted">é¢„ä¼°å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</small>
                    </div>

                    <% if (task.actualHours) { %>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="fw-bold text-success"><%= task.actualHours %></div>
                                <small class="text-muted">å®é™…å·¥æ—¶</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold <%= task.actualHours <= task.estimatedHours ? 'text-success' : 'text-warning' %>">
                                <%= task.estimatedHours > 0 ? Math.round((task.estimatedHours / task.actualHours) * 100) : 0 %>%
                            </div>
                            <small class="text-muted">å·¥æ—¶æ•ˆç‡</small>
                        </div>
                    </div>

                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        å·¥æ—¶æ•ˆç‡ = é¢„ä¼°å·¥æ—¶ / å®é™…å·¥æ—¶ Ã— 100%
                    </small>
                    <% } else { %>
                    <div class="text-center text-muted">
                        <i class="fas fa-hourglass-start fa-2x mb-2"></i>
                        <p class="mb-0">ä»»åŠ¡è¿›è¡Œä¸­ï¼Œæš‚æ— å®é™…å·¥æ—¶æ•°æ®</p>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- ä»»åŠ¡ä¿¡æ¯ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>ä»»åŠ¡ä¿¡æ¯
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <strong>ä»»åŠ¡ç±»å‹ï¼š</strong>
                            <span class="ms-2">
                                <span class="badge bg-<%=
                                    task.taskType === 'requirement' ? 'info' :
                                    task.taskType === 'epic' ? 'purple' :
                                    task.taskType === 'story' ? 'primary' :
                                    task.taskType === 'dev_task' ? 'primary' :
                                    task.taskType === 'design_task' ? 'success' :
                                    task.taskType === 'test_task' ? 'warning' :
                                    task.taskType === 'devops_task' ? 'dark' :
                                    task.taskType === 'bug' ? 'danger' : 'secondary'
                                %>">
                                    <%= task.taskType === 'requirement' ? 'ğŸ“‹ éœ€æ±‚' :
                                        task.taskType === 'epic' ? 'ğŸ° å²è¯—' :
                                        task.taskType === 'story' ? 'ğŸ“– ç”¨æˆ·æ•…äº‹' :
                                        task.taskType === 'dev_task' ? 'âš”ï¸ å¼€å‘ä»»åŠ¡' :
                                        task.taskType === 'design_task' ? 'ğŸ¨ è®¾è®¡ä»»åŠ¡' :
                                        task.taskType === 'test_task' ? 'ğŸ¹ æµ‹è¯•ä»»åŠ¡' :
                                        task.taskType === 'devops_task' ? 'âš™ï¸ è¿ç»´ä»»åŠ¡' :
                                        task.taskType === 'bug' ? 'ğŸ› ç¼ºé™·' : 'ğŸ“ é€šç”¨ä»»åŠ¡' %>
                                </span>
                            </span>
                        </div>
                        <div class="col-12">
                            <strong>å‘å¸ƒè€…ï¼š</strong>
                            <span class="ms-2"><%= task.publisher.firstName %> <%= task.publisher.lastName %></span>
                        </div>
                        <% if (task.assignee) { %>
                            <div class="col-12">
                                <strong>è´Ÿè´£äººï¼š</strong>
                                <span class="ms-2"><%= task.assignee.firstName %> <%= task.assignee.lastName %></span>
                            </div>
                        <% } %>
                        <% if (assistants && assistants.length > 0) { %>
                            <div class="col-12">
                                <strong>ååŠ©äººå‘˜ï¼š</strong>
                                <span class="ms-2">
                                    <% assistants.forEach((assistant, index) => { %>
                                        <%= assistant.firstName %> <%= assistant.lastName %><% if (index < assistants.length - 1) { %>ã€<% } %>
                                    <% }); %>
                                </span>
                            </div>
                        <% } %>
                        <% if (task.reviewer) { %>
                            <div class="col-12">
                                <strong>å®¡æ ¸äººå‘˜ï¼š</strong>
                                <span class="ms-2"><%= task.reviewer.firstName %> <%= task.reviewer.lastName %></span>
                            </div>
                        <% } %>
                        <% if (task.estimatedHours) { %>
                            <div class="col-12">
                                <strong>é¢„ä¼°å·¥æ—¶ï¼š</strong>
                                <span class="ms-2"><%= task.estimatedHours %> å°æ—¶</span>
                            </div>
                        <% } %>
                        <% if (task.dueDate) { %>
                            <div class="col-12">
                                <strong>æˆªæ­¢æ—¥æœŸï¼š</strong>
                                <span class="ms-2"><%= new Date(task.dueDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>ä»»åŠ¡çŠ¶æ€ï¼š</strong>
                            <span class="ms-2">
                                <span class="badge bg-<%= currentStatus.class %>">
                                    <i class="<%= currentStatus.icon %> me-1"></i>
                                    <%= currentStatus.text %>
                                </span>
                            </span>
                        </div>
                        <% if (task.startDate) { %>
                            <div class="col-12">
                                <strong>å¼€å§‹æ—¶é—´ï¼š</strong>
                                <span class="ms-2"><%= new Date(task.startDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <% if (task.completedAt) { %>
                            <div class="col-12">
                                <strong>å®Œæˆæ—¶é—´ï¼š</strong>
                                <span class="ms-2"><%= new Date(task.completedAt).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>åˆ›å»ºæ—¶é—´ï¼š</strong>
                            <span class="ms-2"><%= new Date(task.createdAt).toLocaleDateString('zh-CN') %></span>
                        </div>
                        <% if (task.level > 0) { %>
                            <div class="col-12">
                                <strong>ä»»åŠ¡å±‚çº§ï¼š</strong>
                                <span class="ms-2">ç¬¬ <%= task.level + 1 %> çº§</span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- é¡¹ç›®ä¿¡æ¯ -->
            <% if (task.project) { %>
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>æ‰€å±é¡¹ç›®
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6><%= task.project.name %></h6>
                        <p class="text-muted mb-2"><%= task.project.description || 'æš‚æ— æè¿°' %></p>
                        <a href="/projects/<%= task.project.id %>" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹é¡¹ç›®
                        </a>
                    </div>
                </div>
            <% } %>
    </div>
</div>

<!-- å®Œæˆä»»åŠ¡æ¨¡æ€æ¡† -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å®Œæˆä»»åŠ¡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/tasks/<%= task.id %>/complete" method="POST">
                <div class="modal-body">
                    <p>è¯·ç¡®è®¤ä»»åŠ¡å·²å®Œæˆï¼Œå¹¶å¡«å†™å®é™…å·¥æ—¶ï¼š</p>

                    <div class="mb-3">
                        <label for="actualHours" class="form-label">å®é™…å·¥æ—¶ï¼ˆå°æ—¶ï¼‰</label>
                        <input type="number" class="form-control" id="actualHours" name="actualHours"
                               min="0.5" step="0.5" placeholder="è¯·è¾“å…¥å®é™…å·¥æ—¶">
                        <div class="form-text">
                            <% if (task.estimatedHours) { %>
                                é¢„ä¼°å·¥æ—¶ï¼š<%= task.estimatedHours %> å°æ—¶
                            <% } else { %>
                                å¡«å†™å®é™…å·¥æ—¶æœ‰åŠ©äºé¡¹ç›®ç®¡ç†å’Œå¥–åŠ±è®¡ç®—
                            <% } %>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <% if (task.reviewerId) { %>
                            å®Œæˆåä»»åŠ¡å°†æäº¤ç»™å®¡æ ¸äººå‘˜è¿›è¡Œå®¡æ ¸ã€‚
                        <% } else { %>
                            å®Œæˆåä»»åŠ¡å°†ç›´æ¥æ ‡è®°ä¸ºå·²å®Œæˆã€‚
                        <% } %>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ç¡®è®¤å®Œæˆ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // é¡µé¢åˆå§‹åŒ–
    initCommentSystem();
});

// åˆå§‹åŒ–è¯„è®ºç³»ç»Ÿ
function initCommentSystem() {
    // åˆå§‹åŒ–æ‰€æœ‰è¯„è®ºç¼–è¾‘å™¨
    $('.comment-editor').each(function() {
        initCommentEditor($(this));
    });

    // ç»‘å®šå›å¤æŒ‰é’®äº‹ä»¶
    $(document).on('click', '.reply-btn', function() {
        const commentId = $(this).data('comment-id');
        const userId = $(this).data('user-id');
        const username = $(this).data('username');
        showReplyEditor(commentId, userId, username);
    });

    // ç»‘å®šç¼–è¾‘è¯„è®ºæŒ‰é’®äº‹ä»¶
    $(document).on('click', '.edit-comment-btn', function() {
        const commentId = $(this).data('comment-id');
        editComment(commentId);
    });

    // ç»‘å®šåˆ é™¤è¯„è®ºæŒ‰é’®äº‹ä»¶
    $(document).on('click', '.delete-comment-btn', function() {
        const commentId = $(this).data('comment-id');
        deleteComment(commentId);
    });

    // ç»‘å®šåŠ è½½æ›´å¤šå›å¤æŒ‰é’®äº‹ä»¶
    $(document).on('click', '.load-more-replies-btn', function() {
        const commentId = $(this).data('comment-id');
        loadMoreReplies(commentId);
    });
}

// åˆå§‹åŒ–è¯„è®ºç¼–è¾‘å™¨
function initCommentEditor($editor) {
    const $form = $editor.find('.comment-form');
    const $richEditor = $editor.find('.rich-editor-content');
    const $textarea = $editor.find('.comment-content');
    const $toolbar = $editor.find('.rich-editor-toolbar');
    const $imageUpload = $editor.find('.image-upload');
    const $mentionDropdown = $editor.find('.mention-dropdown');

    // åŒæ­¥å†…å®¹åˆ°éšè—çš„textarea
    function syncContent() {
        $textarea.val($richEditor.html());
    }

    // ç›‘å¬å†…å®¹å˜åŒ–
    $richEditor.on('input paste', function() {
        setTimeout(syncContent, 10);
    });

    // å·¥å…·æ æŒ‰é’®äº‹ä»¶
    $toolbar.on('click', '.rich-editor-btn', function(e) {
        e.preventDefault();
        const command = $(this).data('command');

        if (command) {
            if (command === 'createLink') {
                const url = prompt('è¯·è¾“å…¥é“¾æ¥åœ°å€:');
                if (url) {
                    document.execCommand(command, false, url);
                }
            } else {
                document.execCommand(command, false, null);
            }
            updateToolbarState($toolbar);
            syncContent();
        }
    });

    // æ’å…¥å›¾ç‰‡æŒ‰é’®
    $toolbar.on('click', '.insert-image-btn', function(e) {
        e.preventDefault();
        $imageUpload.click();
    });

    // @æé†’æŒ‰é’®
    $toolbar.on('click', '.mention-btn', function(e) {
        e.preventDefault();
        insertMention($richEditor, $mentionDropdown);
    });

    // å›¾ç‰‡ä¸Šä¼ å¤„ç†
    $imageUpload.on('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            uploadImage(file, $richEditor);
            $(this).val(''); // æ¸…ç©ºæ–‡ä»¶è¾“å…¥
        }
    });

    // @ç”¨æˆ·é€‰æ‹©
    $mentionDropdown.on('click', '.mention-item', function() {
        const username = $(this).data('username');
        const userId = $(this).data('user-id');
        insertUserMention($richEditor, username, userId);
        $mentionDropdown.hide();
    });

    // è¡¨å•æäº¤
    $form.on('submit', function(e) {
        e.preventDefault();
        submitComment($form);
    });

    // å–æ¶ˆæŒ‰é’®
    $editor.on('click', '.cancel-comment, .cancel-reply', function() {
        if ($editor.attr('id') === 'mainCommentEditor') {
            // ä¸»ç¼–è¾‘å™¨åªæ¸…ç©ºå†…å®¹
            $richEditor.html('');
            syncContent();
        } else {
            // å›å¤ç¼–è¾‘å™¨ç›´æ¥éšè—
            $editor.hide();
        }
    });

    // æ›´æ–°å·¥å…·æ çŠ¶æ€
    $richEditor.on('mouseup keyup', function() {
        updateToolbarState($toolbar);
    });

    // åˆå§‹åŒæ­¥
    syncContent();
}

// æ›´æ–°å·¥å…·æ æŒ‰é’®çŠ¶æ€
function updateToolbarState($toolbar) {
    $toolbar.find('.rich-editor-btn[data-command]').each(function() {
        const command = $(this).data('command');
        if (document.queryCommandState(command)) {
            $(this).addClass('active');
        } else {
            $(this).removeClass('active');
        }
    });
}

// æ˜¾ç¤ºå›å¤ç¼–è¾‘å™¨
function showReplyEditor(parentCommentId, replyToUserId, replyToUsername) {
    // éšè—å…¶ä»–å›å¤ç¼–è¾‘å™¨
    $('.reply-editor-container').hide().empty();

    // åˆ›å»ºå›å¤ç¼–è¾‘å™¨HTML
    const editorHtml = `
        <div class="comment-editor mt-3" id="replyEditor_${parentCommentId}">
            <div class="card">
                <div class="card-body">
                    <form class="comment-form" data-task-id="<%= task.id %>" data-parent-id="${parentCommentId}" data-reply-to="${replyToUserId}">
                        <div class="reply-indicator mb-2">
                            <small class="text-muted">
                                <i class="fas fa-reply me-1"></i>
                                å›å¤ <strong>${replyToUsername}</strong>
                                <button type="button" class="btn btn-link btn-sm p-0 ms-2 cancel-reply">
                                    <i class="fas fa-times"></i>
                                </button>
                            </small>
                        </div>
                        <div class="rich-editor mb-3">
                            <div class="rich-editor-toolbar">
                                <button type="button" class="rich-editor-btn" data-command="bold" title="ç²—ä½“">
                                    <i class="fas fa-bold"></i>
                                </button>
                                <button type="button" class="rich-editor-btn" data-command="italic" title="æ–œä½“">
                                    <i class="fas fa-italic"></i>
                                </button>
                                <button type="button" class="rich-editor-btn" data-command="underline" title="ä¸‹åˆ’çº¿">
                                    <i class="fas fa-underline"></i>
                                </button>
                                <span class="rich-editor-separator"></span>
                                <button type="button" class="rich-editor-btn mention-btn" title="@æé†’">
                                    <i class="fas fa-at"></i>
                                </button>
                                <button type="button" class="rich-editor-btn" data-command="removeFormat" title="æ¸…é™¤æ ¼å¼">
                                    <i class="fas fa-remove-format"></i>
                                </button>
                            </div>
                            <div class="rich-editor-content" contenteditable="true" placeholder="å†™ä¸‹æ‚¨çš„å›å¤...">
                                @${replyToUsername}
                            </div>
                        </div>
                        <textarea class="form-control d-none comment-content" name="content" required></textarea>
                        <input type="file" class="image-upload" accept="image/*" style="display: none;">
                        <div class="mention-dropdown" style="display: none;">
                            <div class="dropdown-menu show">
                                <% if (projectMembers && projectMembers.length > 0) { %>
                                    <% projectMembers.forEach(member => { %>
                                        <button type="button" class="dropdown-item mention-item"
                                                data-user-id="<%= member.id %>"
                                                data-username="<%= member.firstName %><%= member.lastName %>">
                                            <div class="d-flex align-items-center">
                                                <div class="flex-grow-1">
                                                    <div class="fw-medium"><%= member.firstName %> <%= member.lastName %></div>
                                                    <small class="text-muted"><%= member.role %></small>
                                                </div>
                                            </div>
                                        </button>
                                    <% }); %>
                                <% } %>
                            </div>
                        </div>
                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-outline-secondary btn-sm cancel-reply me-2">
                                <i class="fas fa-times me-1"></i>å–æ¶ˆ
                            </button>
                            <button type="submit" class="btn btn-primary btn-sm submit-comment">
                                <i class="fas fa-paper-plane me-1"></i>å‘å¸ƒå›å¤
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `;

    // æ’å…¥åˆ°å¯¹åº”è¯„è®ºçš„å›å¤å®¹å™¨ä¸­
    const $container = $(`.comment-item[data-comment-id="${parentCommentId}"] .reply-editor-container`);
    $container.html(editorHtml).show();

    // åˆå§‹åŒ–æ–°åˆ›å»ºçš„ç¼–è¾‘å™¨
    initCommentEditor($container.find('.comment-editor'));

    // èšç„¦åˆ°ç¼–è¾‘å™¨
    $container.find('.rich-editor-content').focus();
}

// æäº¤è¯„è®º
function submitComment($form) {
    const taskId = $form.data('task-id');
    const parentCommentId = $form.data('parent-id') || null;
    const replyToUserId = $form.data('reply-to') || null;
    const content = $form.find('.comment-content').val().trim();

    if (!content) {
        KanbanApp.showAlert('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
        return;
    }

    const $submitBtn = $form.find('.submit-comment');
    const originalText = $submitBtn.html();

    // ç¦ç”¨æäº¤æŒ‰é’®
    $submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>å‘å¸ƒä¸­...');

    $.ajax({
        url: `/tasks/${taskId}/comments`,
        method: 'POST',
        data: {
            content: content,
            parentCommentId: parentCommentId,
            replyToUserId: replyToUserId
        },
        success: function(response) {
            if (response.success) {
                KanbanApp.showAlert('è¯„è®ºå‘å¸ƒæˆåŠŸ', 'success');
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæ–°è¯„è®º
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                KanbanApp.showAlert(response.message || 'è¯„è®ºå‘å¸ƒå¤±è´¥', 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            KanbanApp.showAlert(response?.message || 'è¯„è®ºå‘å¸ƒå¤±è´¥', 'danger');
        },
        complete: function() {
            // æ¢å¤æäº¤æŒ‰é’®
            $submitBtn.prop('disabled', false).html(originalText);
        }
    });
}

// ç¼–è¾‘è¯„è®º
function editComment(commentId) {
    // è·å–è¯„è®ºå†…å®¹
    const $commentItem = $(`.comment-item[data-comment-id="${commentId}"], .comment-reply[data-comment-id="${commentId}"]`);
    const $contentDiv = $commentItem.find('.comment-content').first();
    const originalContent = $contentDiv.html();

    // åˆ›å»ºç¼–è¾‘è¡¨å•
    const editFormHtml = `
        <div class="edit-comment-form">
            <div class="rich-editor mb-3">
                <div class="rich-editor-toolbar">
                    <button type="button" class="rich-editor-btn" data-command="bold" title="ç²—ä½“">
                        <i class="fas fa-bold"></i>
                    </button>
                    <button type="button" class="rich-editor-btn" data-command="italic" title="æ–œä½“">
                        <i class="fas fa-italic"></i>
                    </button>
                    <button type="button" class="rich-editor-btn" data-command="underline" title="ä¸‹åˆ’çº¿">
                        <i class="fas fa-underline"></i>
                    </button>
                    <span class="rich-editor-separator"></span>
                    <button type="button" class="rich-editor-btn" data-command="removeFormat" title="æ¸…é™¤æ ¼å¼">
                        <i class="fas fa-remove-format"></i>
                    </button>
                </div>
                <div class="rich-editor-content" contenteditable="true">${originalContent}</div>
            </div>
            <textarea class="form-control d-none edit-content" required></textarea>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-outline-secondary btn-sm cancel-edit me-2">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary btn-sm save-edit" data-comment-id="${commentId}">
                    <i class="fas fa-save me-1"></i>ä¿å­˜
                </button>
            </div>
        </div>
    `;

    // æ›¿æ¢å†…å®¹åŒºåŸŸ
    $contentDiv.hide().after(editFormHtml);

    // åˆå§‹åŒ–ç¼–è¾‘å™¨
    const $editForm = $commentItem.find('.edit-comment-form');
    const $richEditor = $editForm.find('.rich-editor-content');
    const $textarea = $editForm.find('.edit-content');

    // åŒæ­¥å†…å®¹
    function syncEditContent() {
        $textarea.val($richEditor.html());
    }

    $richEditor.on('input', syncEditContent);
    syncEditContent();

    // å–æ¶ˆç¼–è¾‘
    $editForm.on('click', '.cancel-edit', function() {
        $editForm.remove();
        $contentDiv.show();
    });

    // ä¿å­˜ç¼–è¾‘
    $editForm.on('click', '.save-edit', function() {
        const content = $textarea.val().trim();
        if (!content) {
            KanbanApp.showAlert('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'warning');
            return;
        }

        const $saveBtn = $(this);
        const originalText = $saveBtn.html();
        $saveBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...');

        $.ajax({
            url: `/tasks/<%= task.id %>/comments/${commentId}`,
            method: 'PUT',
            data: { content: content },
            success: function(response) {
                if (response.success) {
                    KanbanApp.showAlert('è¯„è®ºæ›´æ–°æˆåŠŸ', 'success');
                    // æ›´æ–°æ˜¾ç¤ºå†…å®¹
                    $contentDiv.html(content);
                    $editForm.remove();
                    $contentDiv.show();

                    // æ·»åŠ ç¼–è¾‘æ ‡è®°
                    const $header = $commentItem.find('.comment-header .comment-time').first();
                    if (!$header.find('.fa-edit').length) {
                        $header.find('small').append(' <span class="ms-1" title="å·²ç¼–è¾‘"><i class="fas fa-edit"></i></span>');
                    }
                } else {
                    KanbanApp.showAlert(response.message || 'è¯„è®ºæ›´æ–°å¤±è´¥', 'danger');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                KanbanApp.showAlert(response?.message || 'è¯„è®ºæ›´æ–°å¤±è´¥', 'danger');
            },
            complete: function() {
                $saveBtn.prop('disabled', false).html(originalText);
            }
        });
    });

    // èšç„¦åˆ°ç¼–è¾‘å™¨
    $richEditor.focus();
}

// åˆ é™¤è¯„è®º
function deleteComment(commentId) {
    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        return;
    }

    $.ajax({
        url: `/tasks/<%= task.id %>/comments/${commentId}`,
        method: 'DELETE',
        success: function(response) {
            if (response.success) {
                KanbanApp.showAlert('è¯„è®ºåˆ é™¤æˆåŠŸ', 'success');
                // ç§»é™¤è¯„è®ºå…ƒç´ 
                $(`.comment-item[data-comment-id="${commentId}"], .comment-reply[data-comment-id="${commentId}"]`).fadeOut(300, function() {
                    $(this).remove();
                    // æ›´æ–°è¯„è®ºè®¡æ•°
                    updateCommentCount();
                });
            } else {
                KanbanApp.showAlert(response.message || 'è¯„è®ºåˆ é™¤å¤±è´¥', 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            KanbanApp.showAlert(response?.message || 'è¯„è®ºåˆ é™¤å¤±è´¥', 'danger');
        }
    });
}

// åŠ è½½æ›´å¤šå›å¤
function loadMoreReplies(commentId) {
    const $btn = $(`.load-more-replies-btn[data-comment-id="${commentId}"]`);
    const originalText = $btn.html();

    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>åŠ è½½ä¸­...');

    $.ajax({
        url: `/tasks/<%= task.id %>/comments/${commentId}/replies`,
        method: 'GET',
        data: { page: 2, limit: 10 }, // åŠ è½½ç¬¬2é¡µå¼€å§‹çš„å›å¤
        success: function(response) {
            if (response.success && response.data.length > 0) {
                // è¿™é‡Œéœ€è¦æ¸²æŸ“æ›´å¤šå›å¤ï¼Œç®€åŒ–å¤„ç†ç›´æ¥åˆ·æ–°é¡µé¢
                window.location.reload();
            } else {
                $btn.hide();
            }
        },
        error: function() {
            KanbanApp.showAlert('åŠ è½½å›å¤å¤±è´¥', 'danger');
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalText);
        }
    });
}

// æ›´æ–°è¯„è®ºè®¡æ•°
function updateCommentCount() {
    const totalComments = $('.comment-item, .comment-reply').length;
    $('.comments-section h5 span').html(`<i class="fas fa-comments me-2"></i>è¯„è®º (${totalComments})`);
}

// ä¸Šä¼ å›¾ç‰‡
function uploadImage(file, $richEditor) {
    const formData = new FormData();
    formData.append('taskImage', file);

    $.ajax({
        url: '/tasks/upload-image',
        method: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                // æ’å…¥å›¾ç‰‡åˆ°ç¼–è¾‘å™¨
                const img = document.createElement('img');
                img.src = response.location;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';

                // è·å–å½“å‰é€‰æ‹©æˆ–å…‰æ ‡ä½ç½®
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    range.insertNode(img);
                    range.collapse(false);
                } else {
                    $richEditor[0].appendChild(img);
                }
            } else {
                KanbanApp.showAlert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + (response.error || 'æœªçŸ¥é”™è¯¯'), 'danger');
            }
        },
        error: function() {
            KanbanApp.showAlert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥', 'danger');
        }
    });
}

// æ’å…¥@æé†’
function insertMention($richEditor, $mentionDropdown) {
    // ç®€åŒ–å®ç°ï¼šç›´æ¥æ˜¾ç¤ºç”¨æˆ·åˆ—è¡¨
    const rect = $richEditor[0].getBoundingClientRect();
    $mentionDropdown.css({
        position: 'absolute',
        top: rect.bottom + 'px',
        left: rect.left + 'px'
    }).show();
}

// æ’å…¥ç”¨æˆ·æé†’
function insertUserMention($richEditor, username, userId) {
    const mention = `@${username} `;

    // è·å–å½“å‰é€‰æ‹©æˆ–å…‰æ ‡ä½ç½®
    const selection = window.getSelection();
    if (selection.rangeCount > 0) {
        const range = selection.getRangeAt(0);
        const textNode = document.createTextNode(mention);
        range.insertNode(textNode);
        range.setStartAfter(textNode);
        range.collapse(true);
        selection.removeAllRanges();
        selection.addRange(range);
    } else {
        $richEditor.append(mention);
    }

    $richEditor.focus();
}</script>

// æ˜¾ç¤ºå®Œæˆä»»åŠ¡æ¨¡æ€æ¡†
function showCompleteModal() {
    $('#completeModal').modal('show');
}

// å®¡æ ¸é€šè¿‡
function approveTask() {
    if (confirm('ç¡®å®šè¦å®¡æ ¸é€šè¿‡æ­¤ä»»åŠ¡å—ï¼Ÿ')) {
        updateTaskStatus('completed', 'å®¡æ ¸é€šè¿‡ï¼Œä»»åŠ¡å·²å®Œæˆï¼');
    }
}

// å®¡æ ¸æ‹’ç»
function rejectTask() {
    if (confirm('ç¡®å®šè¦æ‹’ç»æ­¤ä»»åŠ¡å—ï¼Ÿä»»åŠ¡å°†è¿”å›ç»™è´Ÿè´£äººé‡æ–°å¤„ç†ã€‚')) {
        updateTaskStatus('in_progress', 'å®¡æ ¸æ‹’ç»ï¼Œä»»åŠ¡å·²è¿”å›ç»™è´Ÿè´£äºº');
    }
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€
function updateTaskStatus(newStatus, message) {
    const taskId = '<%= task.id %>';

    $.ajax({
        url: `/tasks/${taskId}/status`,
        method: 'POST',
        data: { status: newStatus },
        success: function(response) {
            if (response.success) {
                KanbanApp.showAlert(message || response.message, 'success');
                // åˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºæœ€æ–°çŠ¶æ€
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                KanbanApp.showAlert(response.message, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            KanbanApp.showAlert(response?.message || 'æ“ä½œå¤±è´¥', 'danger');
        }
    });
}
</script>

<style>
/* å¯Œæ–‡æœ¬å†…å®¹æ ·å¼ */
.rich-text-content {
    line-height: 1.6;
}

.rich-text-content img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 10px 0;
}

.rich-text-content p {
    margin-bottom: 1rem;
}

.rich-text-content ul, .rich-text-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.rich-text-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #6c757d;
}

.rich-text-content code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.rich-text-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
}

.rich-text-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.rich-text-content table th,
.rich-text-content table td {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    text-align: left;
}

.rich-text-content table th {
    background-color: #f8f9fa;
    font-weight: 600;
}

/* è¯„è®ºç³»ç»Ÿæ ·å¼ */
.comments-section {
    margin-top: 2rem;
}

.comment-item {
    margin-bottom: 1.5rem;
}

.comment-main {
    background-color: #fff;
    border: 1px solid #e1e5e9;
    border-radius: 0.5rem;
    padding: 1rem;
}

.comment-header {
    display: flex;
    justify-content: between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.comment-author {
    display: flex;
    align-items: center;
    flex-grow: 1;
}

.comment-role .badge {
    font-size: 0.7rem;
}

.comment-time {
    color: #6c757d;
    font-size: 0.875rem;
}

.comment-content {
    margin-bottom: 0.75rem;
    color: #333;
}

.comment-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.comment-buttons .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
    color: #6c757d;
    text-decoration: none;
}

.comment-buttons .btn:hover {
    color: #007bff;
    text-decoration: none;
}

.comment-buttons .btn.text-danger:hover {
    color: #dc3545 !important;
}

/* å›å¤æ ·å¼ */
.comment-replies {
    margin-top: 1rem;
    margin-left: 40px;
    border-left: 2px solid #e1e5e9;
    padding-left: 20px;
    position: relative;
}

.comment-reply {
    margin-bottom: 1rem;
    position: relative;
}

.reply-connector {
    position: absolute;
    left: -22px;
    top: 1rem;
    width: 20px;
    height: 2px;
    background-color: #e1e5e9;
}

.reply-content {
    background-color: #f8f9fa;
    border: 1px solid #e1e5e9;
    border-radius: 0.375rem;
    padding: 0.75rem;
}

.reply-to {
    color: #007bff;
    font-size: 0.875rem;
}

.load-more-replies {
    margin-top: 0.5rem;
    text-align: center;
}

.load-more-replies .btn {
    color: #6c757d;
    font-size: 0.875rem;
}

/* æ— è¯„è®ºçŠ¶æ€ */
.no-comments {
    color: #6c757d;
    padding: 3rem 1rem;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .comment-replies {
        margin-left: 20px;
        padding-left: 15px;
    }

    .comment-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .comment-actions {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
}

@media (max-width: 576px) {
    .comment-replies {
        margin-left: 15px;
        padding-left: 10px;
    }

    .comment-main,
    .reply-content {
        padding: 0.75rem;
    }
}

/* ç´«è‰²å¾½ç« æ ·å¼ */
.badge.bg-purple {
    background-color: #6f42c1 !important;
}
</style>

<%- include('../partials/footer') %>

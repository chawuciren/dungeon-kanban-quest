<%- include('../partials/header', { title: title }) %>

<%
// Áªü‰∏ÄÁöÑÁä∂ÊÄÅÈÖçÁΩÆ
const statusConfig = {
    'draft': { text: 'ËçâÁ®ø', class: 'secondary', icon: 'fas fa-edit' },
    'published': { text: 'Â∑≤ÂèëÂ∏É', class: 'primary', icon: 'fas fa-bullhorn' },
    'in_progress': { text: 'ËøõË°å‰∏≠', class: 'warning', icon: 'fas fa-play' },
    'review': { text: 'ÂæÖÂÆ°Ê†∏', class: 'info', icon: 'fas fa-search' },
    'completed': { text: 'Â∑≤ÂÆåÊàê', class: 'success', icon: 'fas fa-check' },
    'cancelled': { text: 'Â∑≤ÂèñÊ∂à', class: 'danger', icon: 'fas fa-times' }
};
const currentStatus = statusConfig[task.status] || statusConfig['draft'];
%>

<div class="row">
        <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
        <div class="col-lg-8">
            <!-- ‰ªªÂä°Ê†áÈ¢òÂíåÂü∫Êú¨‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/tasks">‰ªªÂä°Â∏ÇÂú∫</a></li>
                            <% if (task.project) { %>
                                <li class="breadcrumb-item"><a href="/projects/<%= task.project.id %>"><%= task.project.name %></a></li>
                            <% } %>
                            <% if (task.parentTask) { %>
                                <li class="breadcrumb-item"><a href="/tasks/<%= task.parentTask.id %>"><%= task.parentTask.title %></a></li>
                            <% } %>
                            <li class="breadcrumb-item active"><%= task.title %></li>
                        </ol>
                    </nav>

                    <!-- ËøîÂõûÊåâÈíÆ -->
                    <div class="mb-3">
                        <a href="/tasks" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>ËøîÂõû‰ªªÂä°ÂàóË°®
                        </a>
                    </div>

                    <!-- ‰ªªÂä°Ê†áÈ¢ò -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h2 class="mb-0">
                            <span class="me-2">
                                <%= task.taskType === 'requirement' ? 'üìã' :
                                    task.taskType === 'epic' ? 'üè∞' :
                                    task.taskType === 'story' ? 'üìñ' :
                                    task.taskType === 'dev_task' ? '‚öîÔ∏è' :
                                    task.taskType === 'design_task' ? 'üé®' :
                                    task.taskType === 'test_task' ? 'üèπ' :
                                    task.taskType === 'devops_task' ? '‚öôÔ∏è' :
                                    task.taskType === 'bug' ? 'üêõ' : 'üìù' %>
                            </span>
                            <%= task.title %>
                        </h2>
                        <div class="task-actions">
                            <!-- Êé•ÂçïÊåâÈíÆ -->
                            <% if (canBid) { %>
                                <form action="/tasks/<%= task.id %>/bid" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-hand-paper me-2"></i>Êé•Âçï
                                    </button>
                                </form>
                            <% } %>

                            <!-- Áä∂ÊÄÅÊìç‰ΩúÊåâÈíÆ -->
                            <% if (user && (task.assigneeId === user.id || task.reviewerId === user.id || user.role === 'admin' || task.publisherId === user.id)) { %>
                                <% if (task.status === 'assigned' && task.assigneeId === user.id) { %>
                                    <form action="/tasks/<%= task.id %>/start" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-play me-2"></i>ÂºÄÂßã‰ªªÂä°
                                        </button>
                                    </form>
                                <% } %>

                                <% if (['assigned', 'in_progress'].includes(task.status) && task.assigneeId === user.id) { %>
                                    <button type="button" class="btn btn-warning" onclick="showCompleteModal()">
                                        <i class="fas fa-check me-2"></i>ÂÆåÊàê‰ªªÂä°
                                    </button>
                                <% } %>

                                <% if (task.status === 'review' && task.reviewerId === user.id) { %>
                                    <button type="button" class="btn btn-success" onclick="approveTask()">
                                        <i class="fas fa-check-circle me-2"></i>ÂÆ°Ê†∏ÈÄöËøá
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="rejectTask()">
                                        <i class="fas fa-times-circle me-2"></i>ÂÆ°Ê†∏ÊãíÁªù
                                    </button>
                                <% } %>
                            <% } %>

                            <!-- ÁÆ°ÁêÜÊåâÈíÆ -->
                            <%
                                // Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶ÊúâÁºñËæëÊùÉÈôê
                                let canEdit = false;
                                if (user) {
                                    // ÁÆ°ÁêÜÂëòÂßãÁªàÊúâÊùÉÈôê
                                    if (user.role === 'admin') {
                                        canEdit = true;
                                    }
                                    // ÊàëÂàõÂª∫ÁöÑ‰ªªÂä°
                                    else if (task.publisherId === user.id) {
                                        canEdit = true;
                                    }
                                    // ÊàëË¥üË¥£ÁöÑ‰ªªÂä°
                                    else if (task.assigneeId === user.id) {
                                        canEdit = true;
                                    }
                                    // ÊàëÂÆ°Ê†∏ÁöÑ‰ªªÂä°
                                    else if (task.reviewerId === user.id) {
                                        canEdit = true;
                                    }
                                }
                            %>
                            <% if (canEdit) { %>
                                <a href="/tasks/<%= task.id %>/edit" class="btn btn-outline-primary">
                                    <i class="fas fa-edit me-2"></i>ÁºñËæë‰ªªÂä°
                                </a>
                            <% } %>

                            <% if (task.level < 3) { %>
                                <a href="/tasks/create?parent=<%= task.id %>" class="btn btn-outline-secondary">
                                    <i class="fas fa-plus me-2"></i>Ê∑ªÂä†Â≠ê‰ªªÂä°
                                </a>
                            <% } %>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°ÂÖÉ‰ø°ÊÅØ -->
                    <div class="row g-3 mb-4">
                        <div class="col-auto">
                            <span class="badge bg-warning fs-6">
                                <%= '‚≠ê'.repeat(task.starLevel) %>
                            </span>
                        </div>

                        <div class="col-auto">
                            <span class="badge bg-info fs-6">
                                <% if (task.urgencyLevel === 'urgent') { %>üî• Á¥ßÊÄ•
                                <% } else if (task.urgencyLevel === 'important') { %>‚ö° ÈáçË¶Å
                                <% } else if (task.urgencyLevel === 'normal') { %>üìÖ ÊôÆÈÄö
                                <% } else if (task.urgencyLevel === 'delayed') { %>üïê Âª∂Âêé
                                <% } else if (task.urgencyLevel === 'frozen') { %>‚ùÑÔ∏è ÂÜªÁªì
                                <% } %>
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-<%= currentStatus.class %> fs-6">
                                <i class="<%= currentStatus.icon %> me-1"></i>
                                <%= currentStatus.text %>
                            </span>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°ÊèèËø∞ -->
                    <div class="mb-4">
                        <h5>‰ªªÂä°ÊèèËø∞</h5>
                        <div class="border rounded p-3 bg-light rich-text-content">
                            <%- task.description %>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°ÂÖ≥Á≥ª -->
                    <% if (task.parentTask || (subtasks && subtasks.length > 0) || (siblingTasks && siblingTasks.length > 0)) { %>
                        <div class="mb-4">
                            <h5><i class="fas fa-sitemap me-2"></i>‰ªªÂä°ÂÖ≥Á≥ª</h5>

                            <!-- Áà∂‰ªªÂä°‰ø°ÊÅØ -->
                            <% if (task.parentTask) { %>
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-level-up-alt me-2"></i>Áà∂‰ªªÂä°
                                        </h6>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <a href="/tasks/<%= task.parentTask.id %>" class="text-decoration-none">
                                                    <strong><%= task.parentTask.title %></strong>
                                                </a>
                                                <% if (task.parentTask.status) { %>
                                                    <%
                                                    const parentStatus = statusConfig[task.parentTask.status] || statusConfig['draft'];
                                                    %>
                                                    <span class="badge bg-<%= parentStatus.class %> ms-2">
                                                        <%= parentStatus.text %>
                                                    </span>
                                                <% } %>
                                            </div>
                                            <a href="/tasks/<%= task.parentTask.id %>" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-external-link-alt me-1"></i>Êü•Áúã
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            <% } %>

                            <!-- ÂêåÁ∫ß‰ªªÂä° -->
                            <% if (siblingTasks && siblingTasks.length > 0) { %>
                                <div class="card mb-3">
                                    <div class="card-header bg-light">
                                        <h6 class="mb-0">
                                            <i class="fas fa-equals me-2"></i>ÂêåÁ∫ß‰ªªÂä° (<%= siblingTasks.length %>)
                                        </h6>
                                    </div>
                                    <div class="card-body py-2">
                                        <div class="row g-2">
                                            <% siblingTasks.forEach(sibling => { %>
                                                <div class="col-12">
                                                    <div class="d-flex justify-content-between align-items-center py-1">
                                                        <div>
                                                            <a href="/tasks/<%= sibling.id %>" class="text-decoration-none">
                                                                <%= sibling.title %>
                                                            </a>
                                                            <%
                                                            const siblingStatus = statusConfig[sibling.status] || statusConfig['draft'];
                                                            %>
                                                            <span class="badge bg-<%= siblingStatus.class %> ms-2">
                                                                <%= siblingStatus.text %>
                                                            </span>
                                                        </div>
                                                        <small class="text-muted">
                                                            <%= '‚≠ê'.repeat(sibling.starLevel) %>
                                                        </small>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                            <% } %>

                            <!-- Â≠ê‰ªªÂä°Ê¶ÇËßà -->
                            <% if (subtasks && subtasks.length > 0) { %>
                                <div class="card">
                                    <div class="card-header bg-light">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">
                                                <i class="fas fa-level-down-alt me-2"></i>Â≠ê‰ªªÂä° (<%= subtasks.length %>)
                                            </h6>
                                            <% if (task.level < 3) { %>
                                                <a href="/tasks/create?parent=<%= task.id %>" class="btn btn-outline-success btn-sm">
                                                    <i class="fas fa-plus me-1"></i>Ê∑ªÂä†Â≠ê‰ªªÂä°
                                                </a>
                                            <% } %>
                                        </div>
                                    </div>
                                    <div class="card-body py-2">
                                        <!-- Â≠ê‰ªªÂä°Áä∂ÊÄÅÁªüËÆ° -->
                                        <%
                                        const subtaskStats = {};
                                        subtasks.forEach(subtask => {
                                            const status = subtask.status || 'draft';
                                            subtaskStats[status] = (subtaskStats[status] || 0) + 1;
                                        });
                                        %>
                                        <div class="row g-2 mb-3">
                                            <% Object.keys(subtaskStats).forEach(status => { %>
                                                <%
                                                const statusInfo = statusConfig[status] || statusConfig['draft'];
                                                %>
                                                <div class="col-auto">
                                                    <span class="badge bg-<%= statusInfo.class %>">
                                                        <%= statusInfo.text %>: <%= subtaskStats[status] %>
                                                    </span>
                                                </div>
                                            <% }) %>
                                        </div>

                                        <!-- Â≠ê‰ªªÂä°ÂàóË°® -->
                                        <div class="list-group list-group-flush">
                                            <% subtasks.forEach(subtask => { %>
                                                <div class="list-group-item px-0 py-2">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <div class="flex-grow-1">
                                                            <a href="/tasks/<%= subtask.id %>" class="text-decoration-none">
                                                                <strong><%= subtask.title %></strong>
                                                            </a>
                                                            <div class="mt-1">
                                                                <small class="text-muted">
                                                                    <%= '‚≠ê'.repeat(subtask.starLevel) %>
                                                                    <% if (subtask.assignee) { %>
                                                                        | Ë¥üË¥£‰∫∫: <%= subtask.assignee.firstName %> <%= subtask.assignee.lastName %>
                                                                    <% } %>
                                                                    <% if (subtask.dueDate) { %>
                                                                        | Êà™Ê≠¢: <%= new Date(subtask.dueDate).toLocaleDateString('zh-CN') %>
                                                                    <% } %>
                                                                </small>
                                                            </div>
                                                        </div>
                                                        <div class="text-end">
                                                            <%
                                                            const subtaskStatus = statusConfig[subtask.status] || statusConfig['draft'];
                                                            %>
                                                            <span class="badge bg-<%= subtaskStatus.class %>">
                                                                <%= subtaskStatus.text %>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                            <% } %>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ‰æßËæπÊ†è -->
        <div class="col-lg-4">
            <!-- Â∑•Êó∂‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Â∑•Êó∂‰ø°ÊÅØ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 fw-bold text-info">
                            <i class="fas fa-clock me-2"></i>
                            <%= task.estimatedHours || 0 %>
                        </div>
                        <small class="text-muted">È¢Ñ‰º∞Â∑•Êó∂ÔºàÂ∞èÊó∂Ôºâ</small>
                    </div>

                    <% if (task.actualHours) { %>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="fw-bold text-success"><%= task.actualHours %></div>
                                <small class="text-muted">ÂÆûÈôÖÂ∑•Êó∂</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold <%= task.actualHours <= task.estimatedHours ? 'text-success' : 'text-warning' %>">
                                <%= task.estimatedHours > 0 ? Math.round((task.estimatedHours / task.actualHours) * 100) : 0 %>%
                            </div>
                            <small class="text-muted">Â∑•Êó∂ÊïàÁéá</small>
                        </div>
                    </div>

                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Â∑•Êó∂ÊïàÁéá = È¢Ñ‰º∞Â∑•Êó∂ / ÂÆûÈôÖÂ∑•Êó∂ √ó 100%
                    </small>
                    <% } else { %>
                    <div class="text-center text-muted">
                        <i class="fas fa-hourglass-start fa-2x mb-2"></i>
                        <p class="mb-0">‰ªªÂä°ËøõË°å‰∏≠ÔºåÊöÇÊó†ÂÆûÈôÖÂ∑•Êó∂Êï∞ÊçÆ</p>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- ‰ªªÂä°‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>‰ªªÂä°‰ø°ÊÅØ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <strong>‰ªªÂä°Á±ªÂûãÔºö</strong>
                            <span class="ms-2">
                                <span class="badge bg-<%=
                                    task.taskType === 'requirement' ? 'info' :
                                    task.taskType === 'epic' ? 'purple' :
                                    task.taskType === 'story' ? 'primary' :
                                    task.taskType === 'dev_task' ? 'primary' :
                                    task.taskType === 'design_task' ? 'success' :
                                    task.taskType === 'test_task' ? 'warning' :
                                    task.taskType === 'devops_task' ? 'dark' :
                                    task.taskType === 'bug' ? 'danger' : 'secondary'
                                %>">
                                    <%= task.taskType === 'requirement' ? 'üìã ÈúÄÊ±Ç' :
                                        task.taskType === 'epic' ? 'üè∞ Âè≤ËØó' :
                                        task.taskType === 'story' ? 'üìñ Áî®Êà∑ÊïÖ‰∫ã' :
                                        task.taskType === 'dev_task' ? '‚öîÔ∏è ÂºÄÂèë‰ªªÂä°' :
                                        task.taskType === 'design_task' ? 'üé® ËÆæËÆ°‰ªªÂä°' :
                                        task.taskType === 'test_task' ? 'üèπ ÊµãËØï‰ªªÂä°' :
                                        task.taskType === 'devops_task' ? '‚öôÔ∏è ËøêÁª¥‰ªªÂä°' :
                                        task.taskType === 'bug' ? 'üêõ Áº∫Èô∑' : 'üìù ÈÄöÁî®‰ªªÂä°' %>
                                </span>
                            </span>
                        </div>
                        <div class="col-12">
                            <strong>ÂèëÂ∏ÉËÄÖÔºö</strong>
                            <span class="ms-2"><%= task.publisher.firstName %> <%= task.publisher.lastName %></span>
                        </div>
                        <% if (task.assignee) { %>
                            <div class="col-12">
                                <strong>Ë¥üË¥£‰∫∫Ôºö</strong>
                                <span class="ms-2"><%= task.assignee.firstName %> <%= task.assignee.lastName %></span>
                            </div>
                        <% } %>
                        <% if (assistants && assistants.length > 0) { %>
                            <div class="col-12">
                                <strong>ÂçèÂä©‰∫∫ÂëòÔºö</strong>
                                <span class="ms-2">
                                    <% assistants.forEach((assistant, index) => { %>
                                        <%= assistant.firstName %> <%= assistant.lastName %><% if (index < assistants.length - 1) { %>„ÄÅ<% } %>
                                    <% }); %>
                                </span>
                            </div>
                        <% } %>
                        <% if (task.reviewer) { %>
                            <div class="col-12">
                                <strong>ÂÆ°Ê†∏‰∫∫ÂëòÔºö</strong>
                                <span class="ms-2"><%= task.reviewer.firstName %> <%= task.reviewer.lastName %></span>
                            </div>
                        <% } %>
                        <% if (task.estimatedHours) { %>
                            <div class="col-12">
                                <strong>È¢Ñ‰º∞Â∑•Êó∂Ôºö</strong>
                                <span class="ms-2"><%= task.estimatedHours %> Â∞èÊó∂</span>
                            </div>
                        <% } %>
                        <% if (task.dueDate) { %>
                            <div class="col-12">
                                <strong>Êà™Ê≠¢Êó•ÊúüÔºö</strong>
                                <span class="ms-2"><%= new Date(task.dueDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>‰ªªÂä°Áä∂ÊÄÅÔºö</strong>
                            <span class="ms-2">
                                <span class="badge bg-<%= currentStatus.class %>">
                                    <i class="<%= currentStatus.icon %> me-1"></i>
                                    <%= currentStatus.text %>
                                </span>
                            </span>
                        </div>
                        <% if (task.startDate) { %>
                            <div class="col-12">
                                <strong>ÂºÄÂßãÊó∂Èó¥Ôºö</strong>
                                <span class="ms-2"><%= new Date(task.startDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <% if (task.completedAt) { %>
                            <div class="col-12">
                                <strong>ÂÆåÊàêÊó∂Èó¥Ôºö</strong>
                                <span class="ms-2"><%= new Date(task.completedAt).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>ÂàõÂª∫Êó∂Èó¥Ôºö</strong>
                            <span class="ms-2"><%= new Date(task.createdAt).toLocaleDateString('zh-CN') %></span>
                        </div>
                        <% if (task.level > 0) { %>
                            <div class="col-12">
                                <strong>‰ªªÂä°Â±ÇÁ∫ßÔºö</strong>
                                <span class="ms-2">Á¨¨ <%= task.level + 1 %> Á∫ß</span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- È°πÁõÆ‰ø°ÊÅØ -->
            <% if (task.project) { %>
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>ÊâÄÂ±ûÈ°πÁõÆ
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6><%= task.project.name %></h6>
                        <p class="text-muted mb-2"><%= task.project.description || 'ÊöÇÊó†ÊèèËø∞' %></p>
                        <a href="/projects/<%= task.project.id %>" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Êü•ÁúãÈ°πÁõÆ
                        </a>
                    </div>
                </div>
            <% } %>
    </div>
</div>

<!-- ÂÆåÊàê‰ªªÂä°Ê®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ÂÆåÊàê‰ªªÂä°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/tasks/<%= task.id %>/complete" method="POST">
                <div class="modal-body">
                    <p>ËØ∑Á°ÆËÆ§‰ªªÂä°Â∑≤ÂÆåÊàêÔºåÂπ∂Â°´ÂÜôÂÆûÈôÖÂ∑•Êó∂Ôºö</p>

                    <div class="mb-3">
                        <label for="actualHours" class="form-label">ÂÆûÈôÖÂ∑•Êó∂ÔºàÂ∞èÊó∂Ôºâ</label>
                        <input type="number" class="form-control" id="actualHours" name="actualHours"
                               min="0.5" step="0.5" placeholder="ËØ∑ËæìÂÖ•ÂÆûÈôÖÂ∑•Êó∂">
                        <div class="form-text">
                            <% if (task.estimatedHours) { %>
                                È¢Ñ‰º∞Â∑•Êó∂Ôºö<%= task.estimatedHours %> Â∞èÊó∂
                            <% } else { %>
                                Â°´ÂÜôÂÆûÈôÖÂ∑•Êó∂ÊúâÂä©‰∫éÈ°πÁõÆÁÆ°ÁêÜÂíåÂ•ñÂä±ËÆ°ÁÆó
                            <% } %>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <% if (task.reviewerId) { %>
                            ÂÆåÊàêÂêé‰ªªÂä°Â∞ÜÊèê‰∫§ÁªôÂÆ°Ê†∏‰∫∫ÂëòËøõË°åÂÆ°Ê†∏„ÄÇ
                        <% } else { %>
                            ÂÆåÊàêÂêé‰ªªÂä°Â∞ÜÁõ¥Êé•Ê†áËÆ∞‰∏∫Â∑≤ÂÆåÊàê„ÄÇ
                        <% } %>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">Á°ÆËÆ§ÂÆåÊàê</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // È°µÈù¢ÂàùÂßãÂåñ
});

// ÊòæÁ§∫ÂÆåÊàê‰ªªÂä°Ê®°ÊÄÅÊ°Ü
function showCompleteModal() {
    $('#completeModal').modal('show');
}

// ÂÆ°Ê†∏ÈÄöËøá
function approveTask() {
    if (confirm('Á°ÆÂÆöË¶ÅÂÆ°Ê†∏ÈÄöËøáÊ≠§‰ªªÂä°ÂêóÔºü')) {
        updateTaskStatus('completed', 'ÂÆ°Ê†∏ÈÄöËøáÔºå‰ªªÂä°Â∑≤ÂÆåÊàêÔºÅ');
    }
}

// ÂÆ°Ê†∏ÊãíÁªù
function rejectTask() {
    if (confirm('Á°ÆÂÆöË¶ÅÊãíÁªùÊ≠§‰ªªÂä°ÂêóÔºü‰ªªÂä°Â∞ÜËøîÂõûÁªôË¥üË¥£‰∫∫ÈáçÊñ∞Â§ÑÁêÜ„ÄÇ')) {
        updateTaskStatus('in_progress', 'ÂÆ°Ê†∏ÊãíÁªùÔºå‰ªªÂä°Â∑≤ËøîÂõûÁªôË¥üË¥£‰∫∫');
    }
}

// Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
function updateTaskStatus(newStatus, message) {
    const taskId = '<%= task.id %>';

    $.ajax({
        url: `/tasks/${taskId}/status`,
        method: 'POST',
        data: { status: newStatus },
        success: function(response) {
            if (response.success) {
                KanbanApp.showAlert(message || response.message, 'success');
                // Âà∑Êñ∞È°µÈù¢‰ª•ÊòæÁ§∫ÊúÄÊñ∞Áä∂ÊÄÅ
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                KanbanApp.showAlert(response.message, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            KanbanApp.showAlert(response?.message || 'Êìç‰ΩúÂ§±Ë¥•', 'danger');
        }
    });
}
</script>

<style>
/* ÂØåÊñáÊú¨ÂÜÖÂÆπÊ†∑Âºè */
.rich-text-content {
    line-height: 1.6;
}

.rich-text-content img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    margin: 10px 0;
}

.rich-text-content p {
    margin-bottom: 1rem;
}

.rich-text-content ul, .rich-text-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.rich-text-content blockquote {
    border-left: 4px solid #007bff;
    padding-left: 1rem;
    margin: 1rem 0;
    font-style: italic;
    color: #6c757d;
}

.rich-text-content code {
    background-color: #f8f9fa;
    padding: 2px 4px;
    border-radius: 3px;
    font-family: 'Courier New', monospace;
}

.rich-text-content pre {
    background-color: #f8f9fa;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
}

.rich-text-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 1rem 0;
}

.rich-text-content table th,
.rich-text-content table td {
    border: 1px solid #dee2e6;
    padding: 8px 12px;
    text-align: left;
}

.rich-text-content table th {
    background-color: #f8f9fa;
    font-weight: 600;
}
</style>

<%- include('../partials/footer') %>

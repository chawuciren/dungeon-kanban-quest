<%- include('../partials/header', { title: title }) %>

<div class="row">
        <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
        <div class="col-lg-8">
            <!-- ‰ªªÂä°Ê†áÈ¢òÂíåÂü∫Êú¨‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/tasks">‰ªªÂä°Â∏ÇÂú∫</a></li>
                            <% if (task.project) { %>
                                <li class="breadcrumb-item"><a href="/projects/<%= task.project.id %>"><%= task.project.name %></a></li>
                            <% } %>
                            <% if (task.parentTask) { %>
                                <li class="breadcrumb-item"><a href="/tasks/<%= task.parentTask.id %>"><%= task.parentTask.title %></a></li>
                            <% } %>
                            <li class="breadcrumb-item active"><%= task.title %></li>
                        </ol>
                    </nav>

                    <!-- ‰ªªÂä°Ê†áÈ¢ò -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h2 class="mb-0"><%= task.title %></h2>
                        <div class="task-actions">
                            <% if (canBid) { %>
                                <button class="btn btn-primary" id="bidTaskBtn">
                                    <i class="fas fa-hand-paper me-2"></i>Êé•Âçï
                                </button>
                            <% } %>
                            <% if (task.level < 3) { %>
                                <a href="/tasks/create?parent=<%= task.id %>" class="btn btn-outline-primary">
                                    <i class="fas fa-plus me-2"></i>Ê∑ªÂä†Â≠ê‰ªªÂä°
                                </a>
                            <% } %>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°ÂÖÉ‰ø°ÊÅØ -->
                    <div class="row g-3 mb-4">
                        <div class="col-auto">
                            <span class="badge bg-warning fs-6">
                                <%= '‚≠ê'.repeat(task.starLevel) %>
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-secondary fs-6">
                                <% if (task.skillRequired === 'novice') { %>üî∞ Êñ∞Êâã
                                <% } else if (task.skillRequired === 'bronze') { %>ü•â ÈìúÁâå
                                <% } else if (task.skillRequired === 'silver') { %>ü•à Èì∂Áâå
                                <% } else if (task.skillRequired === 'gold') { %>ü•á ÈáëÁâå
                                <% } else if (task.skillRequired === 'diamond') { %>üíé ÈíªÁü≥
                                <% } %>
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-info fs-6">
                                <% if (task.urgencyLevel === 'urgent') { %>üî• Á¥ßÊÄ•
                                <% } else if (task.urgencyLevel === 'important') { %>‚ö° ÈáçË¶Å
                                <% } else if (task.urgencyLevel === 'normal') { %>üìÖ ÊôÆÈÄö
                                <% } else if (task.urgencyLevel === 'delayed') { %>üïê Âª∂Âêé
                                <% } else if (task.urgencyLevel === 'frozen') { %>‚ùÑÔ∏è ÂÜªÁªì
                                <% } %>
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-<%= task.status === 'published' ? 'success' : task.status === 'assigned' ? 'primary' : 'dark' %> fs-6">
                                <% if (task.status === 'published') { %>ÂèØÊé•Âçï
                                <% } else if (task.status === 'assigned') { %>ËøõË°å‰∏≠
                                <% } else if (task.status === 'completed') { %>Â∑≤ÂÆåÊàê
                                <% } else { %><%= task.status %>
                                <% } %>
                            </span>
                        </div>
                    </div>

                    <!-- ‰ªªÂä°ÊèèËø∞ -->
                    <div class="mb-4">
                        <h5>‰ªªÂä°ÊèèËø∞</h5>
                        <div class="border rounded p-3 bg-light">
                            <%= task.description %>
                        </div>
                    </div>

                    <!-- Â≠ê‰ªªÂä°ÂàóË°® -->
                    <% if (subtasks && subtasks.length > 0) { %>
                        <div class="mb-4">
                            <h5>Â≠ê‰ªªÂä° (<%= subtasks.length %>)</h5>
                            <div class="list-group">
                                <% subtasks.forEach(subtask => { %>
                                    <a href="/tasks/<%= subtask.id %>" class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1"><%= subtask.title %></h6>
                                                <small class="text-muted">
                                                    <%= '‚≠ê'.repeat(subtask.starLevel) %> ‚Ä¢
                                                    <% if (subtask.skillRequired === 'novice') { %>üî∞
                                                    <% } else if (subtask.skillRequired === 'bronze') { %>ü•â
                                                    <% } else if (subtask.skillRequired === 'silver') { %>ü•à
                                                    <% } else if (subtask.skillRequired === 'gold') { %>ü•á
                                                    <% } else if (subtask.skillRequired === 'diamond') { %>üíé
                                                    <% } %>
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <span class="badge bg-<%= subtask.status === 'published' ? 'success' : subtask.status === 'assigned' ? 'primary' : 'dark' %>">
                                                    <% if (subtask.status === 'published') { %>ÂèØÊé•Âçï
                                                    <% } else if (subtask.status === 'assigned') { %>ËøõË°å‰∏≠
                                                    <% } else if (subtask.status === 'completed') { %>Â∑≤ÂÆåÊàê
                                                    <% } else { %><%= subtask.status %>
                                                    <% } %>
                                                </span>
                                                <div class="mt-1">
                                                    <small class="text-muted">
                                                        <% if (subtask.rewardCurrency === 'diamond') { %>üíé
                                                        <% } else if (subtask.rewardCurrency === 'gold') { %>ü•á
                                                        <% } else if (subtask.rewardCurrency === 'silver') { %>ü•à
                                                        <% } else { %>ü•â<% } %>
                                                        <%= subtask.totalBudget %>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ‰æßËæπÊ†è -->
        <div class="col-lg-4">
            <!-- Â•ñÂä±‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-coins me-2"></i>Â•ñÂä±‰ø°ÊÅØ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 fw-bold text-primary">
                            <% if (task.rewardCurrency === 'diamond') { %>üíé
                            <% } else if (task.rewardCurrency === 'gold') { %>ü•á
                            <% } else if (task.rewardCurrency === 'silver') { %>ü•à
                            <% } else { %>ü•â<% } %>
                            <%= task.totalBudget.toLocaleString() %>
                        </div>
                        <small class="text-muted">ÊÄªÂ•ñÂä±</small>
                    </div>

                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="fw-bold"><%= task.baseReward.toLocaleString() %></div>
                                <small class="text-muted">Âü∫Á°ÄÂ•ñÂä±</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold"><%= task.bonusReward.toLocaleString() %></div>
                            <small class="text-muted">Â•ñÂä±Èáë</small>
                        </div>
                    </div>

                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        ÊåâÊó∂ÂÆåÊàêÂèØËé∑ÂæóÂÖ®È¢ùÂ•ñÂä±ÔºåË∂ÖÊó∂Â∞ÜÊåâÊØî‰æãÊâ£Èô§Â•ñÂä±Èáë
                    </small>
                </div>
            </div>

            <!-- ‰ªªÂä°‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>‰ªªÂä°‰ø°ÊÅØ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <strong>ÂèëÂ∏ÉËÄÖÔºö</strong>
                            <span class="ms-2"><%= task.publisher.firstName %> <%= task.publisher.lastName %></span>
                        </div>
                        <% if (task.assignee) { %>
                            <div class="col-12">
                                <strong>Êé•ÂçïËÄÖÔºö</strong>
                                <span class="ms-2"><%= task.assignee.firstName %> <%= task.assignee.lastName %></span>
                            </div>
                        <% } %>
                        <% if (task.estimatedHours) { %>
                            <div class="col-12">
                                <strong>È¢Ñ‰º∞Â∑•Êó∂Ôºö</strong>
                                <span class="ms-2"><%= task.estimatedHours %> Â∞èÊó∂</span>
                            </div>
                        <% } %>
                        <% if (task.dueDate) { %>
                            <div class="col-12">
                                <strong>Êà™Ê≠¢Êó•ÊúüÔºö</strong>
                                <span class="ms-2"><%= new Date(task.dueDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>ÂàõÂª∫Êó∂Èó¥Ôºö</strong>
                            <span class="ms-2"><%= new Date(task.createdAt).toLocaleDateString('zh-CN') %></span>
                        </div>
                        <% if (task.level > 0) { %>
                            <div class="col-12">
                                <strong>‰ªªÂä°Â±ÇÁ∫ßÔºö</strong>
                                <span class="ms-2">Á¨¨ <%= task.level + 1 %> Á∫ß</span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- È°πÁõÆ‰ø°ÊÅØ -->
            <% if (task.project) { %>
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>ÊâÄÂ±ûÈ°πÁõÆ
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6><%= task.project.name %></h6>
                        <p class="text-muted mb-2"><%= task.project.description || 'ÊöÇÊó†ÊèèËø∞' %></p>
                        <a href="/projects/<%= task.project.id %>" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Êü•ÁúãÈ°πÁõÆ
                        </a>
                    </div>
                </div>
            <% } %>
    </div>
</div>

<!-- Êé•ÂçïÁ°ÆËÆ§Ê®°ÊÄÅÊ°Ü -->
<div class="modal fade" id="bidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Á°ÆËÆ§Êé•Âçï</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ÊÇ®Á°ÆÂÆöË¶ÅÊé•Ëøô‰∏™‰ªªÂä°ÂêóÔºü</p>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Êé•ÂçïÂêéÔºåÁ≥ªÁªüÂ∞ÜÂÜªÁªìÁõ∏Â∫îÁöÑ‰øùËØÅÈáë„ÄÇËØ∑Á°Æ‰øùÊÇ®ÊúâË∂≥Â§üÁöÑÊó∂Èó¥ÂíåËÉΩÂäõÂÆåÊàêÊ≠§‰ªªÂä°„ÄÇ
                </div>
                <div class="task-summary">
                    <h6>‰ªªÂä°ÊëòË¶ÅÔºö</h6>
                    <ul class="list-unstyled">
                        <li><strong>ÈöæÂ∫¶Ôºö</strong><%= '‚≠ê'.repeat(task.starLevel) %></li>
                        <li><strong>Â•ñÂä±Ôºö</strong>
                            <% if (task.rewardCurrency === 'diamond') { %>üíé
                            <% } else if (task.rewardCurrency === 'gold') { %>ü•á
                            <% } else if (task.rewardCurrency === 'silver') { %>ü•à
                            <% } else { %>ü•â<% } %>
                            <%= task.totalBudget.toLocaleString() %>
                        </li>
                        <% if (task.estimatedHours) { %>
                            <li><strong>È¢Ñ‰º∞Â∑•Êó∂Ôºö</strong><%= task.estimatedHours %> Â∞èÊó∂</li>
                        <% } %>
                        <% if (task.dueDate) { %>
                            <li><strong>Êà™Ê≠¢Êó•ÊúüÔºö</strong><%= new Date(task.dueDate).toLocaleDateString('zh-CN') %></li>
                        <% } %>
                    </ul>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ÂèñÊ∂à</button>
                <button type="button" class="btn btn-primary" id="confirmBid">Á°ÆËÆ§Êé•Âçï</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Êé•ÂçïÊåâÈíÆÁÇπÂáª
    $('#bidTaskBtn').click(function() {
        $('#bidModal').modal('show');
    });

    // Á°ÆËÆ§Êé•Âçï
    $('#confirmBid').click(function() {
        const btn = $(this);
        KanbanApp.setLoading(btn, true);

        // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®Êé•ÂçïAPI
        setTimeout(() => {
            KanbanApp.setLoading(btn, false);
            $('#bidModal').modal('hide');
            KanbanApp.showAlert('Êé•ÂçïÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'info');
        }, 1000);
    });
});
</script>

<%- include('../partials/footer') %>

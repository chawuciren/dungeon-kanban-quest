<%- include('../partials/header', { title: title }) %>

<%
// 统一的状态配置
const statusConfig = {
    'draft': { text: '草稿', class: 'secondary', icon: 'fas fa-edit' },
    'assigned': { text: '已分配', class: 'warning', icon: 'fas fa-user-check' },
    'in_progress': { text: '进行中', class: 'primary', icon: 'fas fa-play' },
    'review': { text: '待审核', class: 'info', icon: 'fas fa-search' },
    'completed': { text: '已完成', class: 'success', icon: 'fas fa-check' },
    'cancelled': { text: '已取消', class: 'danger', icon: 'fas fa-times' }
};
const currentStatus = statusConfig[task.status] || statusConfig['draft'];
%>

<div class="row">
        <!-- 主要内容 -->
        <div class="col-lg-8">
            <!-- 任务标题和基本信息 -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- 面包屑导航 -->
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/tasks">任务市场</a></li>
                            <% if (task.project) { %>
                                <li class="breadcrumb-item"><a href="/projects/<%= task.project.id %>"><%= task.project.name %></a></li>
                            <% } %>
                            <% if (task.parentTask) { %>
                                <li class="breadcrumb-item"><a href="/tasks/<%= task.parentTask.id %>"><%= task.parentTask.title %></a></li>
                            <% } %>
                            <li class="breadcrumb-item active"><%= task.title %></li>
                        </ol>
                    </nav>

                    <!-- 返回按钮 -->
                    <div class="mb-3">
                        <a href="/tasks" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>返回任务列表
                        </a>
                    </div>

                    <!-- 任务标题 -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h2 class="mb-0"><%= task.title %></h2>
                        <div class="task-actions">
                            <!-- 接单按钮 -->
                            <% if (canBid) { %>
                                <form action="/tasks/<%= task.id %>/bid" method="POST" style="display: inline;">
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-hand-paper me-2"></i>接单
                                    </button>
                                </form>
                            <% } %>

                            <!-- 状态操作按钮 -->
                            <% if (user && (task.assigneeId === user.id || task.reviewerId === user.id || user.role === 'admin' || task.publisherId === user.id)) { %>
                                <% if (task.status === 'assigned' && task.assigneeId === user.id) { %>
                                    <form action="/tasks/<%= task.id %>/start" method="POST" style="display: inline;">
                                        <button type="submit" class="btn btn-success">
                                            <i class="fas fa-play me-2"></i>开始任务
                                        </button>
                                    </form>
                                <% } %>

                                <% if (['assigned', 'in_progress'].includes(task.status) && task.assigneeId === user.id) { %>
                                    <button type="button" class="btn btn-warning" onclick="showCompleteModal()">
                                        <i class="fas fa-check me-2"></i>完成任务
                                    </button>
                                <% } %>

                                <% if (task.status === 'review' && task.reviewerId === user.id) { %>
                                    <button type="button" class="btn btn-success" onclick="approveTask()">
                                        <i class="fas fa-check-circle me-2"></i>审核通过
                                    </button>
                                    <button type="button" class="btn btn-danger" onclick="rejectTask()">
                                        <i class="fas fa-times-circle me-2"></i>审核拒绝
                                    </button>
                                <% } %>
                            <% } %>

                            <!-- 管理按钮 -->
                            <% if (user && (user.role === 'admin' || task.publisherId === user.id)) { %>
                                <a href="/tasks/<%= task.id %>/edit" class="btn btn-outline-primary">
                                    <i class="fas fa-edit me-2"></i>编辑任务
                                </a>
                            <% } %>

                            <% if (task.level < 3) { %>
                                <a href="/tasks/create?parent=<%= task.id %>" class="btn btn-outline-secondary">
                                    <i class="fas fa-plus me-2"></i>添加子任务
                                </a>
                            <% } %>
                        </div>
                    </div>

                    <!-- 任务元信息 -->
                    <div class="row g-3 mb-4">
                        <div class="col-auto">
                            <span class="badge bg-warning fs-6">
                                <%= '⭐'.repeat(task.starLevel) %>
                            </span>
                        </div>

                        <div class="col-auto">
                            <span class="badge bg-info fs-6">
                                <% if (task.urgencyLevel === 'urgent') { %>🔥 紧急
                                <% } else if (task.urgencyLevel === 'important') { %>⚡ 重要
                                <% } else if (task.urgencyLevel === 'normal') { %>📅 普通
                                <% } else if (task.urgencyLevel === 'delayed') { %>🕐 延后
                                <% } else if (task.urgencyLevel === 'frozen') { %>❄️ 冻结
                                <% } %>
                            </span>
                        </div>
                        <div class="col-auto">
                            <span class="badge bg-<%= currentStatus.class %> fs-6">
                                <i class="<%= currentStatus.icon %> me-1"></i>
                                <%= currentStatus.text %>
                            </span>
                        </div>
                    </div>

                    <!-- 任务描述 -->
                    <div class="mb-4">
                        <h5>任务描述</h5>
                        <div class="border rounded p-3 bg-light">
                            <%= task.description %>
                        </div>
                    </div>

                    <!-- 子任务列表 -->
                    <% if (subtasks && subtasks.length > 0) { %>
                        <div class="mb-4">
                            <h5>子任务 (<%= subtasks.length %>)</h5>
                            <div class="list-group">
                                <% subtasks.forEach(subtask => { %>
                                    <a href="/tasks/<%= subtask.id %>" class="list-group-item list-group-item-action">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <h6 class="mb-1"><%= subtask.title %></h6>
                                                <small class="text-muted">
                                                    <%= '⭐'.repeat(subtask.starLevel) %>
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <%
                                                const subtaskStatus = statusConfig[subtask.status] || statusConfig['draft'];
                                                %>
                                                <span class="badge bg-<%= subtaskStatus.class %>">
                                                    <%= subtaskStatus.text %>
                                                </span>
                                                <div class="mt-1">
                                                    <small class="text-muted">
                                                        <% if (subtask.rewardCurrency === 'diamond') { %>💎
                                                        <% } else if (subtask.rewardCurrency === 'gold') { %>🥇
                                                        <% } else if (subtask.rewardCurrency === 'silver') { %>🥈
                                                        <% } else { %>🥉<% } %>
                                                        <%= subtask.totalBudget %>
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </a>
                                <% }) %>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- 侧边栏 -->
        <div class="col-lg-4">
            <!-- 工时信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>工时信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-3">
                        <div class="display-6 fw-bold text-info">
                            <i class="fas fa-clock me-2"></i>
                            <%= task.estimatedHours || 0 %>
                        </div>
                        <small class="text-muted">预估工时（小时）</small>
                    </div>

                    <% if (task.actualHours) { %>
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border-end">
                                <div class="fw-bold text-success"><%= task.actualHours %></div>
                                <small class="text-muted">实际工时</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold <%= task.actualHours <= task.estimatedHours ? 'text-success' : 'text-warning' %>">
                                <%= task.estimatedHours > 0 ? Math.round((task.estimatedHours / task.actualHours) * 100) : 0 %>%
                            </div>
                            <small class="text-muted">工时效率</small>
                        </div>
                    </div>

                    <hr>
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        工时效率 = 预估工时 / 实际工时 × 100%
                    </small>
                    <% } else { %>
                    <div class="text-center text-muted">
                        <i class="fas fa-hourglass-start fa-2x mb-2"></i>
                        <p class="mb-0">任务进行中，暂无实际工时数据</p>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- 任务信息 -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>任务信息
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <strong>发布者：</strong>
                            <span class="ms-2"><%= task.publisher.firstName %> <%= task.publisher.lastName %></span>
                        </div>
                        <% if (task.assignee) { %>
                            <div class="col-12">
                                <strong>负责人：</strong>
                                <span class="ms-2"><%= task.assignee.firstName %> <%= task.assignee.lastName %></span>
                            </div>
                        <% } %>
                        <% if (assistants && assistants.length > 0) { %>
                            <div class="col-12">
                                <strong>协助人员：</strong>
                                <span class="ms-2">
                                    <% assistants.forEach((assistant, index) => { %>
                                        <%= assistant.firstName %> <%= assistant.lastName %><% if (index < assistants.length - 1) { %>、<% } %>
                                    <% }); %>
                                </span>
                            </div>
                        <% } %>
                        <% if (task.reviewer) { %>
                            <div class="col-12">
                                <strong>审核人员：</strong>
                                <span class="ms-2"><%= task.reviewer.firstName %> <%= task.reviewer.lastName %></span>
                            </div>
                        <% } %>
                        <% if (task.estimatedHours) { %>
                            <div class="col-12">
                                <strong>预估工时：</strong>
                                <span class="ms-2"><%= task.estimatedHours %> 小时</span>
                            </div>
                        <% } %>
                        <% if (task.dueDate) { %>
                            <div class="col-12">
                                <strong>截止日期：</strong>
                                <span class="ms-2"><%= new Date(task.dueDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>任务状态：</strong>
                            <span class="ms-2">
                                <span class="badge bg-<%= currentStatus.class %>">
                                    <i class="<%= currentStatus.icon %> me-1"></i>
                                    <%= currentStatus.text %>
                                </span>
                            </span>
                        </div>
                        <% if (task.startDate) { %>
                            <div class="col-12">
                                <strong>开始时间：</strong>
                                <span class="ms-2"><%= new Date(task.startDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <% if (task.completedAt) { %>
                            <div class="col-12">
                                <strong>完成时间：</strong>
                                <span class="ms-2"><%= new Date(task.completedAt).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>创建时间：</strong>
                            <span class="ms-2"><%= new Date(task.createdAt).toLocaleDateString('zh-CN') %></span>
                        </div>
                        <% if (task.level > 0) { %>
                            <div class="col-12">
                                <strong>任务层级：</strong>
                                <span class="ms-2">第 <%= task.level + 1 %> 级</span>
                            </div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- 项目信息 -->
            <% if (task.project) { %>
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-project-diagram me-2"></i>所属项目
                        </h5>
                    </div>
                    <div class="card-body">
                        <h6><%= task.project.name %></h6>
                        <p class="text-muted mb-2"><%= task.project.description || '暂无描述' %></p>
                        <a href="/projects/<%= task.project.id %>" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>查看项目
                        </a>
                    </div>
                </div>
            <% } %>
    </div>
</div>

<!-- 完成任务模态框 -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">完成任务</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form action="/tasks/<%= task.id %>/complete" method="POST">
                <div class="modal-body">
                    <p>请确认任务已完成，并填写实际工时：</p>

                    <div class="mb-3">
                        <label for="actualHours" class="form-label">实际工时（小时）</label>
                        <input type="number" class="form-control" id="actualHours" name="actualHours"
                               min="0.5" step="0.5" placeholder="请输入实际工时">
                        <div class="form-text">
                            <% if (task.estimatedHours) { %>
                                预估工时：<%= task.estimatedHours %> 小时
                            <% } else { %>
                                填写实际工时有助于项目管理和奖励计算
                            <% } %>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <% if (task.reviewerId) { %>
                            完成后任务将提交给审核人员进行审核。
                        <% } else { %>
                            完成后任务将直接标记为已完成。
                        <% } %>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-success">确认完成</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 页面初始化
});

// 显示完成任务模态框
function showCompleteModal() {
    $('#completeModal').modal('show');
}

// 审核通过
function approveTask() {
    if (confirm('确定要审核通过此任务吗？')) {
        updateTaskStatus('completed', '审核通过，任务已完成！');
    }
}

// 审核拒绝
function rejectTask() {
    if (confirm('确定要拒绝此任务吗？任务将返回给负责人重新处理。')) {
        updateTaskStatus('in_progress', '审核拒绝，任务已返回给负责人');
    }
}

// 更新任务状态
function updateTaskStatus(newStatus, message) {
    const taskId = '<%= task.id %>';

    $.ajax({
        url: `/tasks/${taskId}/status`,
        method: 'POST',
        data: { status: newStatus },
        success: function(response) {
            if (response.success) {
                KanbanApp.showAlert(message || response.message, 'success');
                // 刷新页面以显示最新状态
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            } else {
                KanbanApp.showAlert(response.message, 'danger');
            }
        },
        error: function(xhr) {
            const response = xhr.responseJSON;
            KanbanApp.showAlert(response?.message || '操作失败', 'danger');
        }
    });
}
</script>

<%- include('../partials/footer') %>

<%- include('../partials/header', { title: title }) %>

<!-- é¡µé¢æ ‡é¢˜å’Œæ§åˆ¶æ  -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-columns me-2 text-primary"></i>
                    ä»»åŠ¡çœ‹æ¿
                </h2>
                <p class="text-muted mb-0">å¯è§†åŒ–ä»»åŠ¡æµç¨‹å’ŒçŠ¶æ€ç®¡ç†</p>
            </div>
            <div class="btn-group">
                <%
                    const currentQuery = new URLSearchParams();
                    if (projectId) currentQuery.set('projectId', projectId);
                    const queryString = currentQuery.toString();
                    const queryPrefix = queryString ? '?' + queryString : '';
                %>
                <a href="/tasks<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-list me-1"></i>åˆ—è¡¨è§†å›¾
                </a>
                <a href="/tasks/tree<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-sitemap me-1"></i>æ ‘å½¢è§†å›¾
                </a>
                <a href="/tasks/kanban<%= queryPrefix %>" class="btn btn-primary active">
                    <i class="fas fa-columns me-1"></i>çœ‹æ¿è§†å›¾
                </a>
                <a href="/tasks/gantt<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-chart-gantt me-1"></i>ç”˜ç‰¹è§†å›¾
                </a>
            </div>
            <a href="/tasks/create<%= queryPrefix ? queryPrefix + '&' : '?' %>view=kanban" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                å‘å¸ƒä»»åŠ¡
            </a>
        </div>
    </div>
</div>

<!-- çœ‹æ¿åˆ— -->
<div class="row kanban-board">
    <% Object.keys(kanbanColumns).forEach(status => { %>
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="kanban-column">
                <div class="kanban-header bg-<%= kanbanColumns[status].color %> text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-circle me-2"></i>
                        <%= kanbanColumns[status].title %>
                        <span class="badge bg-light text-dark ms-2">
                            <%= kanbanColumns[status].tasks.length %>
                        </span>
                    </h5>
                </div>
                <div class="kanban-body" data-status="<%= status %>">
                    <% if (kanbanColumns[status].tasks.length > 0) { %>
                        <% kanbanColumns[status].tasks.forEach(task => { %>
                            <div class="kanban-card" data-task-id="<%= task.id %>">
                                <div class="card mb-3">
                                    <div class="card-body p-3">
                                        <!-- ä»»åŠ¡æ ‡é¢˜ -->
                                        <h6 class="card-title mb-2">
                                            <a href="/tasks/<%= task.id %>" class="text-decoration-none">
                                                <%= task.title %>
                                            </a>
                                        </h6>

                                        <!-- ä»»åŠ¡å…ƒä¿¡æ¯ -->
                                        <div class="task-meta mb-2">
                                            <span class="badge bg-warning me-1">
                                                <% for(let i = 0; i < task.starLevel; i++) { %>â­<% } %>
                                            </span>
                                            <span class="badge bg-secondary me-1">
                                                <% if (task.skillRequired === 'novice') { %>ğŸ”°
                                                <% } else if (task.skillRequired === 'bronze') { %>ğŸ¥‰
                                                <% } else if (task.skillRequired === 'silver') { %>ğŸ¥ˆ
                                                <% } else if (task.skillRequired === 'gold') { %>ğŸ¥‡
                                                <% } else if (task.skillRequired === 'diamond') { %>ğŸ’<% } %>
                                            </span>
                                            <span class="badge bg-info">
                                                <% if (task.urgencyLevel === 'urgent') { %>ğŸ”¥
                                                <% } else if (task.urgencyLevel === 'important') { %>âš¡
                                                <% } else if (task.urgencyLevel === 'normal') { %>ğŸ“…
                                                <% } else if (task.urgencyLevel === 'delayed') { %>ğŸ•<% } %>
                                            </span>
                                        </div>

                                        <!-- ä»»åŠ¡æè¿° -->
                                        <% if (task.description) { %>
                                            <p class="card-text text-muted small mb-2">
                                                <%= task.description.length > 60 ?
                                                    task.description.substring(0, 60) + '...' :
                                                    task.description %>
                                            </p>
                                        <% } %>

                                        <!-- å·¥æ—¶ä¿¡æ¯ -->
                                        <div class="time-info mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i>
                                                <%= task.estimatedHours || 0 %>h
                                            </small>
                                        </div>

                                        <!-- ä»»åŠ¡ä¿¡æ¯ -->
                                        <div class="task-info">
                                            <% if (task.assignee) { %>
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-user text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= task.assignee.firstName + ' ' + task.assignee.lastName %>
                                                    </small>
                                                </div>
                                            <% } %>
                                            <% if (task.dueDate) { %>
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-calendar text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= new Date(task.dueDate).toLocaleDateString('zh-CN') %>
                                                    </small>
                                                </div>
                                            <% } %>
                                            <% if (task.project) { %>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-project-diagram text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= task.project.name %>
                                                    </small>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-column text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">æš‚æ— ä»»åŠ¡</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    <% }); %>
</div>

<style>
.kanban-board {
    min-height: 600px;
}

.kanban-column {
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    height: fit-content;
    min-height: 500px;
}

.kanban-header {
    padding: 15px;
    border-radius: 8px 8px 0 0;
}

.kanban-body {
    padding: 15px;
    min-height: 450px;
}

.kanban-card {
    cursor: move;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.kanban-card .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kanban-card .card:hover {
    border-color: #007bff;
}

.empty-column {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin: 10px 0;
}

.task-meta .badge {
    font-size: 0.7em;
}

.reward-info {
    font-weight: 500;
}

.task-info {
    font-size: 0.8em;
}

/* æ‹–æ‹½æ ·å¼ */
.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.kanban-body.drag-over {
    background-color: #e3f2fd;
    border: 2px dashed #2196f3;
}
</style>

<script>
$(document).ready(function() {
    // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    initDragAndDrop();

    // ä»»åŠ¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶
    $('.kanban-card').click(function(e) {
        if (!$(e.target).closest('a').length) {
            const taskId = $(this).data('task-id');
            window.location.href = `/tasks/${taskId}`;
        }
    });
});

// åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
function initDragAndDrop() {
    // ä½¿ä»»åŠ¡å¡ç‰‡å¯æ‹–æ‹½
    $('.kanban-card').attr('draggable', true);

    // æ‹–æ‹½å¼€å§‹
    $(document).on('dragstart', '.kanban-card', function(e) {
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.setData('text/plain', $(this).data('task-id'));
    });

    // æ‹–æ‹½ç»“æŸ
    $(document).on('dragend', '.kanban-card', function(e) {
        $(this).removeClass('dragging');
        $('.kanban-body').removeClass('drag-over');
    });

    // æ‹–æ‹½è¿›å…¥åˆ—
    $(document).on('dragover', '.kanban-body', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
    });

    // æ‹–æ‹½ç¦»å¼€åˆ—
    $(document).on('dragleave', '.kanban-body', function(e) {
        $(this).removeClass('drag-over');
    });

    // æ”¾ç½®ä»»åŠ¡
    $(document).on('drop', '.kanban-body', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');

        const taskId = e.originalEvent.dataTransfer.getData('text/plain');
        const newStatus = $(this).data('status');
        const $taskCard = $(`.kanban-card[data-task-id="${taskId}"]`);

        // ç§»åŠ¨å¡ç‰‡åˆ°æ–°åˆ—
        $taskCard.appendTo(this);

        // è¿™é‡Œåº”è¯¥è°ƒç”¨APIæ›´æ–°ä»»åŠ¡çŠ¶æ€
        updateTaskStatus(taskId, newStatus);
    });
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€
function updateTaskStatus(taskId, newStatus) {
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    KanbanApp.showAlert('æ­£åœ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€...', 'info');

    // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„API
    setTimeout(() => {
        KanbanApp.showAlert('ä»»åŠ¡çŠ¶æ€æ›´æ–°åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'warning');
    }, 1000);
}
</script>

<%- include('../partials/footer') %>

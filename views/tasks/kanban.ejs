<%- include('../partials/header', { title: title }) %>

<%- include('../partials/task-header', {
    pageTitle: '‰ªªÂä°ÁúãÊùø',
    currentView: 'kanban',
    currentPath: '/tasks/kanban',
    filters: filters,
    projectMembers: projectMembers
}) %>

<!-- ÁúãÊùøÂàó -->
<div class="row kanban-board">
    <% Object.keys(kanbanColumns).forEach(status => { %>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-4">
            <div class="kanban-column">
                <div class="kanban-header bg-<%= kanbanColumns[status].color %> text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-circle me-2"></i>
                        <%= kanbanColumns[status].title %>
                        <span class="badge bg-light text-dark ms-2">
                            <%= kanbanColumns[status].tasks.length %>
                        </span>
                    </h5>
                </div>
                <div class="kanban-body" data-status="<%= status %>">
                    <% if (kanbanColumns[status].tasks.length > 0) { %>
                        <% kanbanColumns[status].tasks.forEach(task => { %>
                            <div class="kanban-card" data-task-id="<%= task.id %>">
                                <div class="card mb-3">
                                    <div class="card-body p-3">
                                        <!-- ‰ªªÂä°Á±ªÂûãÊ†áÁ≠æ -->
                                        <div class="mb-2">
                                            <span class="badge bg-<%=
                                                task.taskType === 'requirement' ? 'info' :
                                                task.taskType === 'epic' ? 'purple' :
                                                task.taskType === 'story' ? 'primary' :
                                                task.taskType === 'dev_task' ? 'primary' :
                                                task.taskType === 'design_task' ? 'success' :
                                                task.taskType === 'test_task' ? 'warning' :
                                                task.taskType === 'devops_task' ? 'dark' :
                                                task.taskType === 'bug' ? 'danger' : 'secondary'
                                            %> task-type-badge-kanban">
                                                <%= task.taskType === 'requirement' ? 'üìã ÈúÄÊ±Ç' :
                                                    task.taskType === 'epic' ? 'üè∞ Âè≤ËØó' :
                                                    task.taskType === 'story' ? 'üìñ ÊïÖ‰∫ã' :
                                                    task.taskType === 'dev_task' ? '‚öîÔ∏è ÂºÄÂèë' :
                                                    task.taskType === 'design_task' ? 'üé® ËÆæËÆ°' :
                                                    task.taskType === 'test_task' ? 'üèπ ÊµãËØï' :
                                                    task.taskType === 'devops_task' ? '‚öôÔ∏è ËøêÁª¥' :
                                                    task.taskType === 'bug' ? 'üêõ Áº∫Èô∑' : 'üìù ‰ªªÂä°' %>
                                            </span>
                                        </div>

                                        <!-- ‰ªªÂä°Ê†áÈ¢ò -->
                                        <h6 class="card-title mb-2">
                                            <a href="/tasks/<%= task.id %>" class="text-decoration-none">
                                                <%= task.title %>
                                            </a>
                                        </h6>

                                        <!-- ‰ªªÂä°ÂÖÉ‰ø°ÊÅØ -->
                                        <div class="task-meta mb-2">
                                            <span class="badge bg-warning me-1">
                                                <% for(let i = 0; i < task.starLevel; i++) { %>‚≠ê<% } %>
                                            </span>

                                            <span class="badge bg-info">
                                                <% if (task.urgencyLevel === 'urgent') { %>üî•
                                                <% } else if (task.urgencyLevel === 'important') { %>‚ö°
                                                <% } else if (task.urgencyLevel === 'normal') { %>üìÖ
                                                <% } else if (task.urgencyLevel === 'delayed') { %>üïê<% } %>
                                            </span>
                                        </div>

                                        <!-- ‰ªªÂä°ÊèèËø∞ -->
                                        <% if (task.description) { %>
                                            <p class="card-text text-muted small mb-2">
                                                <%= task.description.length > 60 ?
                                                    task.description.substring(0, 60) + '...' :
                                                    task.description %>
                                            </p>
                                        <% } %>

                                        <!-- Â∑•Êó∂‰ø°ÊÅØ -->
                                        <div class="time-info mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i>
                                                <%= task.estimatedHours || 0 %>h
                                            </small>
                                        </div>

                                        <!-- ‰ªªÂä°‰ø°ÊÅØ -->
                                        <div class="task-info">
                                            <% if (task.assignee) { %>
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-user text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= task.assignee.firstName + ' ' + task.assignee.lastName %>
                                                    </small>
                                                </div>
                                            <% } %>
                                            <% if (task.dueDate) { %>
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-calendar text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= new Date(task.dueDate).toLocaleDateString('zh-CN') %>
                                                    </small>
                                                </div>
                                            <% } %>
                                            <% if (task.project) { %>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-project-diagram text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= task.project.name %>
                                                    </small>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-column text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">ÊöÇÊó†‰ªªÂä°</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    <% }); %>
</div>

<style>
.kanban-board {
    min-height: 600px;
    overflow-x: auto;
    padding-bottom: 20px;
}

.kanban-column {
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    height: fit-content;
    min-height: 500px;
    min-width: 280px;
}

/* Âú®Â∞èÂ±èÂπï‰∏äÁ°Æ‰øùÁúãÊùøÂàó‰∏ç‰ºöÂ§™Á™Ñ */
@media (max-width: 1200px) {
    .kanban-board .col-lg-2 {
        flex: 0 0 280px;
        max-width: 280px;
    }
}

.kanban-header {
    padding: 15px;
    border-radius: 8px 8px 0 0;
}

.kanban-body {
    padding: 15px;
    min-height: 450px;
}

.kanban-card {
    cursor: move;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.kanban-card .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kanban-card .card:hover {
    border-color: #007bff;
}

.empty-column {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin: 10px 0;
}

.task-meta .badge {
    font-size: 0.7em;
}

.reward-info {
    font-weight: 500;
}

.task-info {
    font-size: 0.8em;
}

.task-type-badge-kanban {
    font-size: 0.75em !important;
    padding: 0.4em 0.6em !important;
    font-weight: 500 !important;
    display: block;
    width: fit-content;
}

/* Ëá™ÂÆö‰πâÁ¥´Ëâ≤ËÉåÊôØ */
.bg-purple {
    background-color: #6f42c1 !important;
    color: white !important;
}

/* ÊãñÊãΩÊ†∑Âºè */
.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.kanban-body.drag-over {
    background-color: #e3f2fd;
    border: 2px dashed #2196f3;
}
</style>

<script>
$(document).ready(function() {
    // ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
    initDragAndDrop();

    // ‰ªªÂä°Âç°ÁâáÁÇπÂáª‰∫ã‰ª∂
    $('.kanban-card').click(function(e) {
        if (!$(e.target).closest('a').length) {
            const taskId = $(this).data('task-id');
            window.location.href = `/tasks/${taskId}`;
        }
    });
});

// ÂàùÂßãÂåñÊãñÊãΩÂäüËÉΩ
function initDragAndDrop() {
    // ‰Ωø‰ªªÂä°Âç°ÁâáÂèØÊãñÊãΩ
    $('.kanban-card').attr('draggable', true);

    // ÊãñÊãΩÂºÄÂßã
    $(document).on('dragstart', '.kanban-card', function(e) {
        $(this).addClass('dragging');
        e.originalEvent.dataTransfer.setData('text/plain', $(this).data('task-id'));
    });

    // ÊãñÊãΩÁªìÊùü
    $(document).on('dragend', '.kanban-card', function(e) {
        $(this).removeClass('dragging');
        $('.kanban-body').removeClass('drag-over');
    });

    // ÊãñÊãΩËøõÂÖ•Âàó
    $(document).on('dragover', '.kanban-body', function(e) {
        e.preventDefault();
        $(this).addClass('drag-over');
    });

    // ÊãñÊãΩÁ¶ªÂºÄÂàó
    $(document).on('dragleave', '.kanban-body', function(e) {
        $(this).removeClass('drag-over');
    });

    // ÊîæÁΩÆ‰ªªÂä°
    $(document).on('drop', '.kanban-body', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');

        const taskId = e.originalEvent.dataTransfer.getData('text/plain');
        const newStatus = $(this).data('status');
        const $taskCard = $(`.kanban-card[data-task-id="${taskId}"]`);

        // ÁßªÂä®Âç°ÁâáÂà∞Êñ∞Âàó
        $taskCard.appendTo(this);

        // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®APIÊõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
        updateTaskStatus(taskId, newStatus);
    });
}

// Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ
function updateTaskStatus(taskId, newStatus) {
    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    KanbanApp.showAlert('Ê≠£Âú®Êõ¥Êñ∞‰ªªÂä°Áä∂ÊÄÅ...', 'info');

    // ËøôÈáåÂ∫îËØ•Ë∞ÉÁî®ÂÆûÈôÖÁöÑAPI
    setTimeout(() => {
        KanbanApp.showAlert('‰ªªÂä°Áä∂ÊÄÅÊõ¥Êñ∞ÂäüËÉΩÊ≠£Âú®ÂºÄÂèë‰∏≠...', 'warning');
    }, 1000);
}
</script>

<%- include('../partials/footer') %>

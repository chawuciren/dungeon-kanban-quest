<%- include('../partials/header', { title: title }) %>

<%- include('../partials/task-header', {
    pageTitle: 'ä»»åŠ¡çœ‹æ¿',
    currentView: 'kanban',
    currentPath: '/tasks/kanban',
    filters: filters,
    projectMembers: projectMembers
}) %>

<!-- çœ‹æ¿åˆ— -->
<div class="row kanban-board">
    <% Object.keys(kanbanColumns).forEach(status => { %>
        <div class="col-xl-2 col-lg-4 col-md-6 mb-4">
            <div class="kanban-column">
                <div class="kanban-header bg-<%= kanbanColumns[status].color %> text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-circle me-2"></i>
                        <%= kanbanColumns[status].title %>
                        <span class="badge bg-light text-dark ms-2">
                            <%= kanbanColumns[status].tasks.length %>
                        </span>
                    </h5>
                </div>
                <div class="kanban-body" data-status="<%= status %>">
                    <% if (kanbanColumns[status].tasks.length > 0) { %>
                        <% kanbanColumns[status].tasks.forEach(task => { %>
                            <div class="kanban-card" data-task-id="<%= task.id %>">
                                <div class="card mb-3">
                                    <div class="card-body p-3">
                                        <!-- ä»»åŠ¡ç±»å‹æ ‡ç­¾ -->
                                        <div class="mb-2">
                                            <span class="badge bg-<%=
                                                task.taskType === 'requirement' ? 'info' :
                                                task.taskType === 'epic' ? 'purple' :
                                                task.taskType === 'story' ? 'primary' :
                                                task.taskType === 'dev_task' ? 'primary' :
                                                task.taskType === 'design_task' ? 'success' :
                                                task.taskType === 'test_task' ? 'warning' :
                                                task.taskType === 'devops_task' ? 'dark' :
                                                task.taskType === 'bug' ? 'danger' : 'secondary'
                                            %> task-type-badge-kanban">
                                                <%= task.taskType === 'requirement' ? 'ğŸ“‹ éœ€æ±‚' :
                                                    task.taskType === 'epic' ? 'ğŸ° å²è¯—' :
                                                    task.taskType === 'story' ? 'ğŸ“– æ•…äº‹' :
                                                    task.taskType === 'dev_task' ? 'âš”ï¸ å¼€å‘' :
                                                    task.taskType === 'design_task' ? 'ğŸ¨ è®¾è®¡' :
                                                    task.taskType === 'test_task' ? 'ğŸ¹ æµ‹è¯•' :
                                                    task.taskType === 'devops_task' ? 'âš™ï¸ è¿ç»´' :
                                                    task.taskType === 'bug' ? 'ğŸ› ç¼ºé™·' : 'ğŸ“ ä»»åŠ¡' %>
                                            </span>
                                        </div>

                                        <!-- ä»»åŠ¡æ ‡é¢˜ -->
                                        <h6 class="card-title mb-2">
                                            <a href="/tasks/<%= task.id %>" class="text-decoration-none">
                                                <%= task.title %>
                                            </a>
                                        </h6>

                                        <!-- ä»»åŠ¡å…ƒä¿¡æ¯ -->
                                        <div class="task-meta mb-2">
                                            <span class="badge bg-warning me-1">
                                                <% for(let i = 0; i < task.starLevel; i++) { %>â­<% } %>
                                            </span>

                                            <span class="badge bg-info">
                                                <% if (task.urgencyLevel === 'urgent') { %>ğŸ”¥
                                                <% } else if (task.urgencyLevel === 'important') { %>âš¡
                                                <% } else if (task.urgencyLevel === 'normal') { %>ğŸ“…
                                                <% } else if (task.urgencyLevel === 'delayed') { %>ğŸ•<% } %>
                                            </span>
                                        </div>

                                        <!-- ä»»åŠ¡æè¿° -->
                                        <% if (task.description) { %>
                                            <p class="card-text text-muted small mb-2">
                                                <%= task.description.length > 60 ?
                                                    task.description.substring(0, 60) + '...' :
                                                    task.description %>
                                            </p>
                                        <% } %>

                                        <!-- å·¥æ—¶ä¿¡æ¯ -->
                                        <div class="time-info mb-2">
                                            <small class="text-muted">
                                                <i class="fas fa-clock"></i>
                                                <%= task.estimatedHours || 0 %>h
                                            </small>
                                        </div>

                                        <!-- ä»»åŠ¡ä¿¡æ¯ -->
                                        <div class="task-info">
                                            <% if (task.assignee) { %>
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-user text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= task.assignee.firstName + ' ' + task.assignee.lastName %>
                                                    </small>
                                                </div>
                                            <% } %>
                                            <% if (task.dueDate) { %>
                                                <div class="d-flex align-items-center mb-1">
                                                    <i class="fas fa-calendar text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= new Date(task.dueDate).toLocaleDateString('zh-CN') %>
                                                    </small>
                                                </div>
                                            <% } %>
                                            <% if (task.project) { %>
                                                <div class="d-flex align-items-center">
                                                    <i class="fas fa-project-diagram text-muted me-1" style="font-size: 12px;"></i>
                                                    <small class="text-muted">
                                                        <%= task.project.name %>
                                                    </small>
                                                </div>
                                            <% } %>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div class="empty-column text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">æš‚æ— ä»»åŠ¡</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    <% }); %>
</div>

<style>
.kanban-board {
    min-height: 600px;
    overflow-x: auto;
    padding-bottom: 20px;
}

.kanban-column {
    background: #f8f9fa;
    border-radius: 8px;
    overflow: hidden;
    height: fit-content;
    min-height: 500px;
    min-width: 280px;
}

/* åœ¨å°å±å¹•ä¸Šç¡®ä¿çœ‹æ¿åˆ—ä¸ä¼šå¤ªçª„ */
@media (max-width: 1200px) {
    .kanban-board .col-lg-2 {
        flex: 0 0 280px;
        max-width: 280px;
    }
}

.kanban-header {
    padding: 15px;
    border-radius: 8px 8px 0 0;
}

.kanban-body {
    padding: 15px;
    min-height: 450px;
}

.kanban-card {
    cursor: move;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.kanban-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.kanban-card .card {
    border: 1px solid #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.kanban-card .card:hover {
    border-color: #007bff;
}

.empty-column {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    margin: 10px 0;
}

.task-meta .badge {
    font-size: 0.7em;
}

.reward-info {
    font-weight: 500;
}

.task-info {
    font-size: 0.8em;
}

.task-type-badge-kanban {
    font-size: 0.75em !important;
    padding: 0.4em 0.6em !important;
    font-weight: 500 !important;
    display: block;
    width: fit-content;
}

/* è‡ªå®šä¹‰ç´«è‰²èƒŒæ™¯ */
.bg-purple {
    background-color: #6f42c1 !important;
    color: white !important;
}

/* æ‹–æ‹½æ ·å¼ */
.kanban-card.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
    z-index: 1000;
}

.kanban-body.drag-over {
    background-color: #e3f2fd;
    border: 2px dashed #2196f3;
    border-radius: 8px;
}

/* æ›´æ–°ä¸­çš„ä»»åŠ¡å¡ç‰‡æ ·å¼ */
.kanban-card.updating {
    opacity: 0.7;
    pointer-events: none;
    position: relative;
}

.kanban-card.updating::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 123, 255, 0.1);
    border: 2px solid #007bff;
    border-radius: 8px;
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { opacity: 0.3; }
    50% { opacity: 0.7; }
    100% { opacity: 0.3; }
}

/* æ‹–æ‹½æ—¶çš„åˆ—é«˜äº® */
.kanban-body.drag-over::before {
    content: 'æ”¾ç½®ä»»åŠ¡åˆ°æ­¤åˆ—';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(33, 150, 243, 0.9);
    color: white;
    padding: 8px 16px;
    border-radius: 4px;
    font-size: 14px;
    font-weight: 500;
    z-index: 10;
    pointer-events: none;
}
</style>

<script>
$(document).ready(function() {
    // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
    initDragAndDrop();

    // ä»»åŠ¡å¡ç‰‡ç‚¹å‡»äº‹ä»¶
    $('.kanban-card').click(function(e) {
        if (!$(e.target).closest('a').length) {
            const taskId = $(this).data('task-id');
            window.location.href = `/tasks/${taskId}`;
        }
    });
});

// åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
function initDragAndDrop() {
    // ä½¿ä»»åŠ¡å¡ç‰‡å¯æ‹–æ‹½
    $('.kanban-card').attr('draggable', true);

    // æ‹–æ‹½å¼€å§‹
    $(document).on('dragstart', '.kanban-card', function(e) {
        const $card = $(this);
        $card.addClass('dragging');

        // è®¾ç½®æ‹–æ‹½æ•°æ®
        const taskId = $card.data('task-id');
        const taskTitle = $card.find('.card-title a').text().trim();

        e.originalEvent.dataTransfer.setData('text/plain', taskId);
        e.originalEvent.dataTransfer.effectAllowed = 'move';

        // è®¾ç½®æ‹–æ‹½å›¾åƒï¼ˆå¯é€‰ï¼‰
        const dragImage = $card.clone().css({
            'transform': 'rotate(5deg)',
            'opacity': '0.8'
        })[0];

        // å­˜å‚¨åŸå§‹ä½ç½®ä¿¡æ¯ï¼Œç”¨äºå¯èƒ½çš„å›æ»š
        $card.data('original-column', $card.parent());

        console.log(`å¼€å§‹æ‹–æ‹½ä»»åŠ¡: ${taskTitle} (ID: ${taskId})`);
    });

    // æ‹–æ‹½ç»“æŸ
    $(document).on('dragend', '.kanban-card', function(e) {
        const $card = $(this);
        $card.removeClass('dragging');
        $('.kanban-body').removeClass('drag-over');

        // æ¸…ç†æ‹–æ‹½çŠ¶æ€
        setTimeout(() => {
            $card.removeData('original-column');
        }, 1000);
    });

    // æ‹–æ‹½è¿›å…¥åˆ—
    $(document).on('dragover', '.kanban-body', function(e) {
        e.preventDefault();
        e.originalEvent.dataTransfer.dropEffect = 'move';

        const $body = $(this);
        if (!$body.hasClass('drag-over')) {
            $body.addClass('drag-over');

            // è·å–çŠ¶æ€ä¿¡æ¯æ˜¾ç¤ºæç¤º
            const status = $body.data('status');
            const statusTitle = $body.parent().find('.kanban-header h5').text().trim();
            console.log(`æ‹–æ‹½æ‚¬åœåœ¨: ${statusTitle}`);
        }
    });

    // æ‹–æ‹½ç¦»å¼€åˆ—
    $(document).on('dragleave', '.kanban-body', function(e) {
        const $body = $(this);

        // æ£€æŸ¥æ˜¯å¦çœŸçš„ç¦»å¼€äº†åˆ—ï¼ˆè€Œä¸æ˜¯è¿›å…¥å­å…ƒç´ ï¼‰
        const rect = this.getBoundingClientRect();
        const x = e.originalEvent.clientX;
        const y = e.originalEvent.clientY;

        if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
            $body.removeClass('drag-over');
        }
    });

    // æ”¾ç½®ä»»åŠ¡
    $(document).on('drop', '.kanban-body', function(e) {
        e.preventDefault();
        $(this).removeClass('drag-over');

        const taskId = e.originalEvent.dataTransfer.getData('text/plain');
        const newStatus = $(this).data('status');
        const $taskCard = $(`.kanban-card[data-task-id="${taskId}"]`);
        const currentStatus = $taskCard.parent().data('status');

        // æ£€æŸ¥æ˜¯å¦çœŸçš„éœ€è¦ç§»åŠ¨ï¼ˆçŠ¶æ€æ˜¯å¦æ”¹å˜ï¼‰
        if (currentStatus === newStatus) {
            showToast('info', 'ä»»åŠ¡å·²åœ¨æ­¤çŠ¶æ€åˆ—ä¸­');
            return;
        }

        // ç§»åŠ¨å¡ç‰‡åˆ°æ–°åˆ—
        $taskCard.appendTo(this);

        // è°ƒç”¨APIæ›´æ–°ä»»åŠ¡çŠ¶æ€
        updateTaskStatus(taskId, newStatus);
    });
}

// æ›´æ–°ä»»åŠ¡çŠ¶æ€
function updateTaskStatus(taskId, newStatus) {
    const $taskCard = $(`.kanban-card[data-task-id="${taskId}"]`);
    const originalColumn = $taskCard.parent();

    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    $taskCard.addClass('updating');
    showToast('info', 'æ­£åœ¨æ›´æ–°ä»»åŠ¡çŠ¶æ€...');

    // è°ƒç”¨APIæ›´æ–°ä»»åŠ¡çŠ¶æ€
    $.ajax({
        url: `/tasks/${taskId}/status`,
        method: 'POST',
        data: { status: newStatus },
        success: function(response) {
            if (response.success) {
                showToast('success', 'ä»»åŠ¡çŠ¶æ€æ›´æ–°æˆåŠŸï¼');

                // æ›´æ–°ä»»åŠ¡è®¡æ•°
                updateTaskCounts();

                // ç§»é™¤åŠ è½½çŠ¶æ€
                $taskCard.removeClass('updating');

                // å¦‚æœæœ‰çŠ¶æ€å˜æ›´çš„ç‰¹æ®Šå¤„ç†
                if (response.data && response.data.startDate) {
                    console.log('ä»»åŠ¡å·²å¼€å§‹:', response.data.startDate);
                }
                if (response.data && response.data.completedAt) {
                    console.log('ä»»åŠ¡å·²å®Œæˆ:', response.data.completedAt);
                }
            } else {
                // æ›´æ–°å¤±è´¥ï¼Œå›æ»šä»»åŠ¡å¡ç‰‡ä½ç½®
                rollbackTaskPosition($taskCard, originalColumn);
                showToast('error', response.message || 'æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥');
            }
        },
        error: function(xhr) {
            // æ›´æ–°å¤±è´¥ï¼Œå›æ»šä»»åŠ¡å¡ç‰‡ä½ç½®
            rollbackTaskPosition($taskCard, originalColumn);

            const response = xhr.responseJSON;
            let errorMessage = 'æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥';

            if (response && response.message) {
                errorMessage = response.message;
            } else if (xhr.status === 403) {
                errorMessage = 'æ‚¨æ²¡æœ‰æƒé™æ›´æ”¹æ­¤ä»»åŠ¡çŠ¶æ€';
            } else if (xhr.status === 404) {
                errorMessage = 'ä»»åŠ¡ä¸å­˜åœ¨';
            } else if (xhr.status === 400) {
                errorMessage = 'æ— æ•ˆçš„çŠ¶æ€å€¼';
            }

            showToast('error', errorMessage);
            console.error('æ›´æ–°ä»»åŠ¡çŠ¶æ€å¤±è´¥:', xhr);
        },
        complete: function() {
            $taskCard.removeClass('updating');
        }
    });
}

// å›æ»šä»»åŠ¡å¡ç‰‡ä½ç½®
function rollbackTaskPosition($taskCard, originalColumn) {
    $taskCard.appendTo(originalColumn);
    showToast('info', 'ä»»åŠ¡ä½ç½®å·²æ¢å¤');
}

// æ›´æ–°ä»»åŠ¡è®¡æ•°
function updateTaskCounts() {
    $('.kanban-column').each(function() {
        const $column = $(this);
        const $body = $column.find('.kanban-body');
        const $badge = $column.find('.kanban-header .badge');
        const taskCount = $body.find('.kanban-card').length;

        $badge.text(taskCount);

        // å¦‚æœåˆ—ä¸ºç©ºï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
        if (taskCount === 0) {
            if ($body.find('.empty-column').length === 0) {
                $body.append(`
                    <div class="empty-column text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">æš‚æ— ä»»åŠ¡</p>
                    </div>
                `);
            }
        } else {
            $body.find('.empty-column').remove();
        }
    });
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(type, message) {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'info' ? 'info' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'info' ? 'info-circle' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `);

    // æ·»åŠ åˆ°é¡µé¢
    let toastContainer = $('#toast-container');
    if (toastContainer.length === 0) {
        toastContainer = $('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>');
        $('body').append(toastContainer);
    }

    toastContainer.append(toast);

    // æ˜¾ç¤ºæç¤º
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();

    // è‡ªåŠ¨ç§»é™¤
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}
</script>

<%- include('../partials/footer') %>

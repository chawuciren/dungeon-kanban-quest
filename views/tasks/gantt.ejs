<%- include('../partials/header', { title: title }) %>

<!-- é¡µé¢æ ‡é¢˜å’Œæ§åˆ¶æ  -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-chart-gantt me-2 text-primary"></i>
                    ä»»åŠ¡ç”˜ç‰¹å›¾
                </h2>
                <p class="text-muted mb-0">æ—¶é—´è½´è§†å›¾å±•ç¤ºä»»åŠ¡è¿›åº¦å’Œæ—¶é—´å®‰æ’</p>
            </div>
            <div class="btn-group">
                <%
                    const currentQuery = new URLSearchParams();
                    if (projectId) currentQuery.set('projectId', projectId);
                    const queryString = currentQuery.toString();
                    const queryPrefix = queryString ? '?' + queryString : '';
                %>
                <a href="/tasks<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-list me-1"></i>åˆ—è¡¨è§†å›¾
                </a>
                <a href="/tasks/tree<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-sitemap me-1"></i>æ ‘å½¢è§†å›¾
                </a>
                <a href="/tasks/kanban<%= queryPrefix %>" class="btn btn-outline-secondary">
                    <i class="fas fa-columns me-1"></i>çœ‹æ¿è§†å›¾
                </a>
                <a href="/tasks/gantt<%= queryPrefix %>" class="btn btn-primary active">
                    <i class="fas fa-chart-gantt me-1"></i>ç”˜ç‰¹è§†å›¾
                </a>
            </div>
            <a href="/tasks/create<%= queryPrefix ? queryPrefix + '&' : '?' %>view=gantt" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                å‘å¸ƒä»»åŠ¡
            </a>
        </div>
    </div>
</div>

<!-- ç”˜ç‰¹å›¾æ§åˆ¶é¢æ¿ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body py-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-secondary" id="viewModeDay">æ—¥</button>
                        <button type="button" class="btn btn-outline-secondary active" id="viewModeWeek">å‘¨</button>
                        <button type="button" class="btn btn-outline-secondary" id="viewModeMonth">æœˆ</button>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="gantt-legend">
                            <span class="legend-item">
                                <span class="legend-color task-published"></span>
                                å¾…æ¥å•
                            </span>
                            <span class="legend-item">
                                <span class="legend-color task-assigned"></span>
                                è¿›è¡Œä¸­
                            </span>
                            <span class="legend-item">
                                <span class="legend-color task-review"></span>
                                å¾…å®¡æ ¸
                            </span>
                            <span class="legend-item">
                                <span class="legend-color task-completed"></span>
                                å·²å®Œæˆ
                            </span>
                        </div>
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="todayBtn">
                            <i class="fas fa-calendar-day me-1"></i>ä»Šå¤©
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç”˜ç‰¹å›¾å®¹å™¨ -->
<div class="row">
    <!-- å·¦ä¾§ä»»åŠ¡åˆ—è¡¨é¢æ¿ -->
    <div class="col-lg-4 col-md-5">
        <div class="card h-100">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>ä»»åŠ¡åˆ—è¡¨
                </h6>
            </div>
            <div class="card-body p-0">
                <div id="task-list-container" class="task-list-container">
                    <!-- ä»»åŠ¡åˆ—è¡¨å°†åœ¨è¿™é‡Œæ¸²æŸ“ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ç”˜ç‰¹å›¾ -->
    <div class="col-lg-8 col-md-7">
        <div class="card h-100">
            <div class="card-body p-0">
                <div id="gantt-container" class="gantt-container">
                    <!-- ç”˜ç‰¹å›¾å¤´éƒ¨ -->
                    <div class="gantt-header">
                        <div class="gantt-timeline" id="gantt-timeline">
                            <!-- æ—¶é—´è½´å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                        </div>
                    </div>
                    <!-- ç”˜ç‰¹å›¾ä¸»ä½“ -->
                    <div class="gantt-body" id="gantt-body">
                        <!-- ä»»åŠ¡æ¡å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
                    </div>
                    <!-- ä»Šå¤©çº¿ -->
                    <div class="gantt-today-line" id="gantt-today-line"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ä»»åŠ¡è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailContent">
                <!-- ä»»åŠ¡è¯¦æƒ…å†…å®¹å°†åŠ¨æ€åŠ è½½ -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <a href="#" class="btn btn-primary" id="viewTaskBtn">æŸ¥çœ‹è¯¦æƒ…</a>
            </div>
        </div>
    </div>
</div>

<!-- è‡ªå®šä¹‰ç”˜ç‰¹å›¾ï¼Œä¸ä½¿ç”¨å¤–éƒ¨æ’ä»¶ -->

<style>
/* ä»»åŠ¡åˆ—è¡¨é¢æ¿æ ·å¼ */
.task-list-container {
    max-height: 600px;
    overflow-y: auto;
    overflow-x: auto;
    border-radius: 0 0 0.5rem 0.5rem;
}

/* å¤ç”¨åˆ—è¡¨è§†å›¾çš„æ ·å¼ */
.quick-edit-field.loading {
    opacity: 0.6;
    pointer-events: none;
}

.quick-edit-field.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    right: 10px;
    width: 16px;
    height: 16px;
    margin-top: -8px;
    border: 2px solid #ccc;
    border-top-color: #007bff;
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to {
        transform: rotate(360deg);
    }
}

.task-card {
    transition: box-shadow 0.2s ease;
    min-width: 800px; /* ç¡®ä¿å¡ç‰‡æœ‰æœ€å°å®½åº¦ */
}

.task-card:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.task-card .card-body {
    padding: 0.75rem 1rem;
    min-height: 60px;
}

.task-card .card-title {
    font-size: 1rem;
    font-weight: 600;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.task-card .badge {
    font-size: 0.75em;
    padding: 0.25em 0.5em;
}

.task-card small {
    font-size: 0.875rem;
    line-height: 1.4;
}

.task-card .form-select-sm {
    font-size: 0.9rem;
    padding: 0.375rem 0.75rem;
    height: auto;
    min-height: 32px;
}

.task-card .dropdown-toggle {
    padding: 0.375rem 0.75rem;
    font-size: 0.9rem;
    min-height: 32px;
}

.task-card .row {
    min-height: 40px;
}

.task-title-link {
    color: #212529 !important;
    transition: color 0.2s ease;
}

.task-title-link:hover {
    color: #0d6efd !important;
    text-decoration: underline !important;
}

/* ç”˜ç‰¹å›¾ç‰¹æœ‰çš„ä»»åŠ¡å¡ç‰‡æ ·å¼ */
.task-card.gantt-task-item {
    cursor: pointer;
}

.task-card.gantt-task-item.active {
    border-left: 4px solid #0d6efd;
    background-color: #e3f2fd;
}

/* è‡ªå®šä¹‰ç”˜ç‰¹å›¾æ ·å¼ */
.gantt-container {
    min-height: 600px;
    overflow-x: auto;
    background: #fff;
    position: relative;
    border: 1px solid #dee2e6;
}

.gantt-header {
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    position: sticky;
    top: 0;
    z-index: 10;
}

.gantt-timeline {
    display: flex;
    flex-direction: column;
    border-bottom: 1px solid #dee2e6;
}

/* æœˆä»½è¡Œ */
.gantt-timeline-month-row {
    display: flex;
    height: 30px;
    background: #e9ecef;
    border-bottom: 1px solid #dee2e6;
}

.gantt-timeline-month-header {
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 1px solid #dee2e6;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
}

/* å‘¨è¡Œ */
.gantt-timeline-week-row {
    display: flex;
    height: 30px;
    background: #e9ecef;
    border-bottom: 1px solid #dee2e6;
}

.gantt-timeline-week-header {
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 1px solid #dee2e6;
    font-weight: 600;
    font-size: 0.875rem;
    color: #495057;
}

.gantt-timeline-week-cell {
    display: flex;
    align-items: center;
    justify-content: center;
    border-right: 1px solid #dee2e6;
    font-weight: 500;
    font-size: 0.8rem;
    color: #495057;
    background: #f8f9fa;
    height: 40px;
}

.gantt-timeline-week-cell.has-today {
    background: #fff3cd;
    color: #856404;
    font-weight: 600;
}

/* æ—¥æœŸè¡Œ */
.gantt-timeline-day-row {
    display: flex;
    height: 40px;
}

.gantt-timeline-day-cell {
    flex: 1;
    min-width: 80px;
    border-right: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    font-size: 0.8rem;
    background: #f8f9fa;
}

.gantt-timeline-day-cell.today {
    background: #fff3cd;
    color: #856404;
    font-weight: 700;
}

.gantt-timeline-day-cell .day-number {
    font-weight: 600;
    font-size: 0.9rem;
}

.gantt-timeline-day-cell .day-week {
    font-size: 0.7rem;
    color: #6c757d;
    margin-top: 2px;
}

/* å…¼å®¹æ—§æ ·å¼ */
.gantt-timeline-cell {
    flex: 1;
    min-width: 100px;
    border-right: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    text-align: center;
    font-size: 0.875rem;
}

.gantt-timeline-month {
    background: #e9ecef;
    padding: 4px;
    font-weight: 600;
    border-bottom: 1px solid #dee2e6;
}

.gantt-timeline-day {
    padding: 8px 4px;
    font-weight: 500;
}

.gantt-timeline-day.today {
    background: #fff3cd;
    color: #856404;
    font-weight: 700;
}

/* æœˆè§†å›¾ç‰¹æ®Šæ ·å¼ */
.gantt-timeline-month-header.month-view {
    flex-direction: column;
    padding: 8px;
    text-align: center;
}

.gantt-timeline-month-header.month-view.has-today {
    background: #fff3cd;
    color: #856404;
}

.gantt-timeline-month-header .month-year {
    font-size: 0.75rem;
    color: #6c757d;
    margin-bottom: 2px;
}

.gantt-timeline-month-header .month-name {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 2px;
}

.gantt-timeline-month-header .month-days {
    font-size: 0.7rem;
    color: #6c757d;
}

/* å…¼å®¹æ—§çš„æœˆè§†å›¾æ ·å¼ */
.gantt-timeline-month-cell {
    display: flex;
    flex-direction: column;
    border-right: 1px solid #dee2e6;
}

.gantt-timeline-days {
    display: flex;
    border-top: 1px solid #dee2e6;
}

.gantt-timeline-days .gantt-timeline-day {
    border-right: 1px solid #e9ecef;
    font-size: 0.75rem;
    padding: 4px 2px;
}

.gantt-body {
    position: relative;
}

.gantt-row {
    display: flex;
    height: 50px;
    border-bottom: 1px solid #e9ecef;
    position: relative;
}

.gantt-row:hover {
    background: #f8f9fa;
}

.gantt-cell {
    flex: 1;
    min-width: 100px;
    border-right: 1px solid #e9ecef;
    position: relative;
}

.gantt-task-bar {
    position: absolute;
    height: 30px;
    top: 10px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    padding: 0 8px;
    color: white;
    font-size: 0.8rem;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.gantt-task-bar:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.gantt-task-bar .task-name {
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.gantt-task-bar .task-progress {
    position: absolute;
    left: 0;
    top: 0;
    height: 100%;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    transition: width 0.3s ease;
}

.gantt-time-label {
    position: absolute;
    font-size: 0.7rem;
    color: #6c757d;
    background: rgba(255,255,255,0.9);
    padding: 2px 4px;
    border-radius: 2px;
    white-space: nowrap;
}

.gantt-time-label.start {
    left: -50px;
    top: 50%;
    transform: translateY(-50%);
}

.gantt-time-label.end {
    right: -50px;
    top: 50%;
    transform: translateY(-50%);
}

/* ç”˜ç‰¹å›¾å›¾ä¾‹ */
.gantt-legend {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.legend-color {
    width: 16px;
    height: 16px;
    border-radius: 3px;
    display: inline-block;
}

/* ä»»åŠ¡çŠ¶æ€é¢œè‰² */
.gantt-task-bar.task-published {
    background-color: #007bff;
}

.gantt-task-bar.task-assigned,
.gantt-task-bar.task-in_progress {
    background-color: #ffc107;
}

.gantt-task-bar.task-review {
    background-color: #17a2b8;
}

.gantt-task-bar.task-completed {
    background-color: #28a745;
}

.legend-color.task-published {
    background-color: #007bff;
}

.legend-color.task-assigned,
.legend-color.task-in_progress {
    background-color: #ffc107;
}

.legend-color.task-review {
    background-color: #17a2b8;
}

.legend-color.task-completed {
    background-color: #28a745;
}

/* ä»Šå¤©çº¿ */
.gantt-today-line {
    position: absolute;
    top: 70px; /* é»˜è®¤å€¼ï¼Œä¼šè¢«JavaScriptåŠ¨æ€è°ƒæ•´ */
    bottom: 0;
    width: 2px;
    background-color: #dc3545;
    z-index: 100;
    pointer-events: none;
    display: none; /* é»˜è®¤éšè—ï¼Œç”±JavaScriptæ§åˆ¶æ˜¾ç¤º */
}

.gantt-today-line::before {
    content: 'ä»Šå¤©';
    position: absolute;
    top: -25px;
    left: -15px;
    background-color: #dc3545;
    color: white;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.7rem;
    font-weight: 500;
    white-space: nowrap;
}

/* è‡ªå®šä¹‰ç”˜ç‰¹å›¾æ ·å¼ä»¥åŒ¹é…ç•Œé¢é£æ ¼ */
.gantt-container .grid-header {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
}

.gantt-container .grid-row {
    border-bottom: 1px solid #e9ecef;
}

.gantt-container .grid-row:hover {
    background-color: #f8f9fa;
}

.gantt-container .bar {
    border-radius: 4px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.gantt-container .bar:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    transform: translateY(-1px);
}

.gantt-container .bar-progress {
    border-radius: 4px;
    background-color: rgba(255,255,255,0.3) !important;
}

.gantt-container .bar-label {
    color: white;
    font-weight: 500;
    text-shadow: 0 1px 2px rgba(0,0,0,0.3);
}

/* Frappe Gantt ä»Šå¤©çº¿æ ·å¼è‡ªå®šä¹‰ */
.gantt .today-highlight {
    background-color: rgba(255, 0, 0, 0.1) !important;
    border-left: 2px solid #dc3545 !important;
}

.gantt .today-line {
    stroke: #dc3545 !important;
    stroke-width: 2px !important;
}

/* å¦‚æœFrappe Ganttä½¿ç”¨ä¸åŒçš„ç±»å */
.gantt .current-date-line,
.gantt .today-marker {
    stroke: #dc3545 !important;
    stroke-width: 2px !important;
}

.gantt .current-date-highlight,
.gantt .today-column {
    background-color: rgba(255, 0, 0, 0.05) !important;
    border-left: 2px solid #dc3545 !important;
}

/* æ—¶é—´æ ‡ç­¾æ ·å¼ */
.gantt-time-label {
    font-size: 0.7rem;
    color: #6c757d;
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    white-space: nowrap;
    pointer-events: none;
    background: rgba(255, 255, 255, 0.9);
    padding: 1px 4px;
    border-radius: 2px;
    font-weight: 500;
    z-index: 5;
}

.gantt-time-label.start {
    left: -50px;
}

.gantt-time-label.end {
    right: -50px;
}

/* ç”˜ç‰¹å›¾æ¡æ ·å¼å¢å¼º */
.gantt-container .bar {
    position: relative;
}

/* ä¸­æ–‡æ—¥å†æ ·å¼ */
.gantt-container .grid-header .grid-header-cell {
    font-family: 'Microsoft YaHei', 'PingFang SC', sans-serif;
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
    .gantt-legend {
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .legend-item {
        font-size: 0.75rem;
    }

    .btn-group {
        flex-wrap: wrap;
    }
}
</style>

<script>
// ç­‰å¾…é¡µé¢å’Œåº“åŠ è½½å®Œæˆ
window.addEventListener('load', function() {
    // å»¶è¿Ÿåˆå§‹åŒ–ä»¥ç¡®ä¿åº“å®Œå…¨åŠ è½½
    setTimeout(function() {
        initGanttChart();
    }, 100);
});

function initGanttChart() {
    // ç”˜ç‰¹å›¾æ•°æ®
    const tasks = <%- JSON.stringify(ganttTasks) %>;

    if (tasks.length === 0) {
        document.getElementById('gantt-container').innerHTML = '<div class="alert alert-info text-center py-5"><i class="fas fa-info-circle me-2"></i>æš‚æ— ä»»åŠ¡æ•°æ®ï¼Œè¯·å…ˆåˆ›å»ºä¸€äº›ä»»åŠ¡</div>';
        document.getElementById('task-list-container').innerHTML = '<div class="alert alert-info text-center py-5"><i class="fas fa-info-circle me-2"></i>æš‚æ— ä»»åŠ¡æ•°æ®</div>';
        return;
    }

    try {
        console.log('å¼€å§‹æ¸²æŸ“è‡ªå®šä¹‰ç”˜ç‰¹å›¾ï¼Œä»»åŠ¡æ•°é‡:', tasks.length);

        // æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
        renderTaskList(tasks);

        // æ¸²æŸ“ç”˜ç‰¹å›¾
        renderGanttChart(tasks);

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        bindEventListeners();

    } catch (error) {
        console.error('ç”˜ç‰¹å›¾åˆå§‹åŒ–å¤±è´¥:', error);
        document.getElementById('gantt-container').innerHTML = '<div class="alert alert-danger text-center py-5"><i class="fas fa-exclamation-triangle me-2"></i>ç”˜ç‰¹å›¾åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</div>';
        document.getElementById('task-list-container').innerHTML = '<div class="alert alert-danger text-center py-5"><i class="fas fa-exclamation-triangle me-2"></i>ä»»åŠ¡åˆ—è¡¨åŠ è½½å¤±è´¥</div>';
    }
}

// å½“å‰è§†å›¾æ¨¡å¼
let currentViewMode = 'Week';

// æ¸²æŸ“è‡ªå®šä¹‰ç”˜ç‰¹å›¾
function renderGanttChart(tasks, viewMode = 'Week') {
    console.log('å¼€å§‹æ¸²æŸ“ç”˜ç‰¹å›¾ï¼Œè§†å›¾æ¨¡å¼:', viewMode);
    currentViewMode = viewMode;

    // è®¡ç®—æ—¥æœŸèŒƒå›´
    const dateRange = calculateDateRange(tasks, viewMode);
    console.log('æ—¥æœŸèŒƒå›´:', dateRange);

    // æ¸²æŸ“æ—¶é—´è½´
    renderTimeline(dateRange, viewMode);

    // æ¸²æŸ“ä»»åŠ¡æ¡
    renderTaskBars(tasks, dateRange);

    // æ¸²æŸ“ä»Šå¤©çº¿
    renderTodayLine(dateRange);
}

// è®¡ç®—æ—¥æœŸèŒƒå›´
function calculateDateRange(tasks, viewMode = 'Week') {
    if (tasks.length === 0) return null;

    let minDate = new Date(tasks[0].start);
    let maxDate = new Date(tasks[0].end);

    tasks.forEach(task => {
        const startDate = new Date(task.start);
        const endDate = new Date(task.end);

        if (startDate < minDate) minDate = startDate;
        if (endDate > maxDate) maxDate = endDate;
    });

    let startDate, endDate;

    if (viewMode === 'Day') {
        // æ—¥è§†å›¾ï¼šæ˜¾ç¤ºå‰å3å¤©
        startDate = new Date(minDate);
        startDate.setDate(startDate.getDate() - 3);

        endDate = new Date(maxDate);
        endDate.setDate(endDate.getDate() + 3);
    } else if (viewMode === 'Week') {
        // å‘¨è§†å›¾ï¼šæ˜¾ç¤ºå‰å1å‘¨
        startDate = new Date(minDate);
        startDate.setDate(startDate.getDate() - 7);

        endDate = new Date(maxDate);
        endDate.setDate(endDate.getDate() + 7);
    } else if (viewMode === 'Month') {
        // æœˆè§†å›¾ï¼šæ˜¾ç¤ºå‰å1ä¸ªæœˆ
        startDate = new Date(minDate);
        startDate.setMonth(startDate.getMonth() - 1);

        endDate = new Date(maxDate);
        endDate.setMonth(endDate.getMonth() + 1);
    }

    // ç”Ÿæˆæ—¥æœŸæ•°ç»„
    const dates = [];
    const currentDate = new Date(startDate);

    while (currentDate <= endDate) {
        dates.push(new Date(currentDate));
        currentDate.setDate(currentDate.getDate() + 1);
    }

    return {
        startDate,
        endDate,
        dates,
        totalDays: dates.length,
        viewMode
    };
}

// æ¸²æŸ“æ—¶é—´è½´
function renderTimeline(dateRange, viewMode = 'Week') {
    const timeline = document.getElementById('gantt-timeline');
    timeline.innerHTML = '';

    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    // æ ¹æ®è§†å›¾æ¨¡å¼å†³å®šæ˜¾ç¤ºæ–¹å¼
    if (viewMode === 'Month') {
        renderMonthTimeline(dateRange, timeline, todayStr);
    } else {
        renderDayWeekTimeline(dateRange, timeline, todayStr, viewMode);
    }
}

// æ¸²æŸ“æœˆè§†å›¾æ—¶é—´è½´
function renderMonthTimeline(dateRange, timeline, todayStr) {
    // æœˆè§†å›¾ï¼šåªæ˜¾ç¤ºæœˆä»½ï¼Œä¸æ˜¾ç¤ºå…·ä½“æ—¥æœŸ
    const monthGroups = {};
    dateRange.dates.forEach(date => {
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        if (!monthGroups[monthKey]) {
            monthGroups[monthKey] = {
                year: date.getFullYear(),
                month: date.getMonth(),
                dates: [],
                hasToday: false
            };
        }
        monthGroups[monthKey].dates.push(date);

        // æ£€æŸ¥è¿™ä¸ªæœˆæ˜¯å¦åŒ…å«ä»Šå¤©
        const dateStr = date.toISOString().split('T')[0];
        if (dateStr === todayStr) {
            monthGroups[monthKey].hasToday = true;
        }
    });

    // åˆ›å»ºå•è¡Œæœˆä»½æ˜¾ç¤º
    const monthRow = document.createElement('div');
    monthRow.className = 'gantt-timeline-month-row';
    monthRow.style.height = '70px'; // æœˆè§†å›¾æ—¶é—´è½´æ›´é«˜

    Object.values(monthGroups).forEach(monthGroup => {
        const monthCell = document.createElement('div');
        monthCell.className = 'gantt-timeline-month-header month-view';
        monthCell.style.flex = monthGroup.dates.length;

        if (monthGroup.hasToday) {
            monthCell.classList.add('has-today');
        }

        monthCell.innerHTML = `
            <div class="month-year">${monthGroup.year}å¹´</div>
            <div class="month-name">${monthGroup.month + 1}æœˆ</div>
            <div class="month-days">${monthGroup.dates.length}å¤©</div>
        `;

        monthRow.appendChild(monthCell);
    });

    timeline.appendChild(monthRow);
}

// æ¸²æŸ“æ—¥/å‘¨è§†å›¾æ—¶é—´è½´
function renderDayWeekTimeline(dateRange, timeline, todayStr, viewMode) {
    if (viewMode === 'Week') {
        renderWeekTimeline(dateRange, timeline, todayStr);
    } else {
        renderDayTimeline(dateRange, timeline, todayStr);
    }
}

// æ¸²æŸ“å‘¨è§†å›¾æ—¶é—´è½´
function renderWeekTimeline(dateRange, timeline, todayStr) {
    // æŒ‰æœˆåˆ†ç»„ï¼ˆä¸Šè¡Œæ˜¾ç¤ºå¹´æœˆï¼‰
    const monthGroups = [];
    let currentMonthGroup = null;

    // æŒ‰å‘¨åˆ†ç»„ï¼ˆä¸‹è¡Œæ˜¾ç¤ºç¬¬å‡ å‘¨ï¼‰
    const weekGroups = [];
    let currentWeekGroup = null;

    dateRange.dates.forEach((date, index) => {
        // æœˆä»½åˆ†ç»„
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
        if (!currentMonthGroup || currentMonthGroup.key !== monthKey) {
            currentMonthGroup = {
                key: monthKey,
                year: date.getFullYear(),
                month: date.getMonth(),
                dates: [],
                startIndex: index
            };
            monthGroups.push(currentMonthGroup);
        }
        currentMonthGroup.dates.push(date);

        // å‘¨åˆ†ç»„
        const weekNumber = getWeekNumber(date);
        const weekKey = `${date.getFullYear()}-W${weekNumber}`;
        if (!currentWeekGroup || currentWeekGroup.key !== weekKey) {
            currentWeekGroup = {
                key: weekKey,
                year: date.getFullYear(),
                weekNumber: weekNumber,
                dates: [],
                startIndex: index
            };
            weekGroups.push(currentWeekGroup);
        }
        currentWeekGroup.dates.push(date);
    });

    // åˆ›å»ºä¸¤è¡Œç»“æ„ï¼šæœˆä»½è¡Œå’Œå‘¨è¡Œ
    const monthRow = document.createElement('div');
    monthRow.className = 'gantt-timeline-month-row';

    const weekRow = document.createElement('div');
    weekRow.className = 'gantt-timeline-week-row';

    // æ¸²æŸ“æœˆä»½è¡Œï¼ˆä¸Šè¡Œï¼‰
    monthGroups.forEach(monthGroup => {
        const monthCell = document.createElement('div');
        monthCell.className = 'gantt-timeline-month-header';
        monthCell.style.flex = monthGroup.dates.length;
        monthCell.textContent = `${monthGroup.year}å¹´${monthGroup.month + 1}æœˆ`;
        monthRow.appendChild(monthCell);
    });

    // æ¸²æŸ“å‘¨è¡Œï¼ˆä¸‹è¡Œï¼‰
    weekGroups.forEach(weekGroup => {
        const weekCell = document.createElement('div');
        weekCell.className = 'gantt-timeline-week-cell';
        weekCell.style.flex = weekGroup.dates.length;

        // æ£€æŸ¥è¿™å‘¨æ˜¯å¦åŒ…å«ä»Šå¤©
        const hasToday = weekGroup.dates.some(date =>
            date.toISOString().split('T')[0] === todayStr
        );

        if (hasToday) {
            weekCell.classList.add('has-today');
        }

        weekCell.textContent = `ç¬¬${weekGroup.weekNumber}å‘¨`;
        weekRow.appendChild(weekCell);
    });

    timeline.appendChild(monthRow);
    timeline.appendChild(weekRow);
}

// æ¸²æŸ“æ—¥è§†å›¾æ—¶é—´è½´
function renderDayTimeline(dateRange, timeline, todayStr) {
    // åˆ›å»ºä¸¤è¡Œç»“æ„ï¼šæœˆä»½è¡Œå’Œæ—¥æœŸè¡Œ
    const monthRow = document.createElement('div');
    monthRow.className = 'gantt-timeline-month-row';

    const dayRow = document.createElement('div');
    dayRow.className = 'gantt-timeline-day-row';

    // æŒ‰æœˆåˆ†ç»„
    const monthGroups = [];
    let currentMonthGroup = null;

    dateRange.dates.forEach((date, index) => {
        const monthKey = `${date.getFullYear()}-${date.getMonth()}`;

        if (!currentMonthGroup || currentMonthGroup.key !== monthKey) {
            currentMonthGroup = {
                key: monthKey,
                year: date.getFullYear(),
                month: date.getMonth(),
                dates: [],
                startIndex: index
            };
            monthGroups.push(currentMonthGroup);
        }

        currentMonthGroup.dates.push(date);
    });

    // æ¸²æŸ“æœˆä»½è¡Œ
    monthGroups.forEach(monthGroup => {
        const monthCell = document.createElement('div');
        monthCell.className = 'gantt-timeline-month-header';
        monthCell.style.flex = monthGroup.dates.length;
        monthCell.textContent = `${monthGroup.year}å¹´${monthGroup.month + 1}æœˆ`;
        monthRow.appendChild(monthCell);
    });

    // æ¸²æŸ“æ—¥æœŸè¡Œ
    dateRange.dates.forEach(date => {
        const dayCell = document.createElement('div');
        dayCell.className = 'gantt-timeline-day-cell';

        const dateStr = date.toISOString().split('T')[0];
        if (dateStr === todayStr) {
            dayCell.classList.add('today');
        }

        dayCell.textContent = `${date.getDate()}æ—¥`;
        dayRow.appendChild(dayCell);
    });

    timeline.appendChild(monthRow);
    timeline.appendChild(dayRow);
}

// è®¡ç®—ä¸€å¹´ä¸­çš„ç¬¬å‡ å‘¨
function getWeekNumber(date) {
    const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
    const dayNum = d.getUTCDay() || 7;
    d.setUTCDate(d.getUTCDate() + 4 - dayNum);
    const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
    return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
}

// æ¸²æŸ“ä»»åŠ¡æ¡
function renderTaskBars(tasks, dateRange) {
    const ganttBody = document.getElementById('gantt-body');
    ganttBody.innerHTML = '';

    tasks.forEach((task, index) => {
        const row = document.createElement('div');
        row.className = 'gantt-row';

        // åˆ›å»ºæ¯æ—¥çš„å•å…ƒæ ¼
        dateRange.dates.forEach(date => {
            const cell = document.createElement('div');
            cell.className = 'gantt-cell';
            row.appendChild(cell);
        });

        // è®¡ç®—ä»»åŠ¡æ¡çš„ä½ç½®å’Œå®½åº¦
        const taskStart = new Date(task.start);
        const taskEnd = new Date(task.end);

        const startIndex = dateRange.dates.findIndex(date =>
            date.toISOString().split('T')[0] === task.start
        );
        const endIndex = dateRange.dates.findIndex(date =>
            date.toISOString().split('T')[0] === task.end
        );

        if (startIndex >= 0 && endIndex >= 0) {
            const taskBar = document.createElement('div');
            taskBar.className = `gantt-task-bar task-${task.task.status}`;
            taskBar.style.left = `${(startIndex / dateRange.totalDays) * 100}%`;
            taskBar.style.width = `${((endIndex - startIndex + 1) / dateRange.totalDays) * 100}%`;

            // æ·»åŠ è¿›åº¦æ¡
            const progressBar = document.createElement('div');
            progressBar.className = 'task-progress';
            progressBar.style.width = `${task.progress}%`;
            taskBar.appendChild(progressBar);

            // æ·»åŠ ä»»åŠ¡åç§°
            const taskName = document.createElement('span');
            taskName.className = 'task-name';
            taskName.textContent = task.name;
            taskBar.appendChild(taskName);

            // æ·»åŠ å¼€å§‹æ—¶é—´æ ‡ç­¾
            const startLabel = document.createElement('div');
            startLabel.className = 'gantt-time-label start';
            startLabel.textContent = formatDate(task.start);
            taskBar.appendChild(startLabel);

            // æ·»åŠ ç»“æŸæ—¶é—´æ ‡ç­¾
            const endLabel = document.createElement('div');
            endLabel.className = 'gantt-time-label end';
            endLabel.textContent = formatDate(task.end);
            taskBar.appendChild(endLabel);

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶
            taskBar.addEventListener('click', () => {
                highlightTask(task.id);
                showTaskDetail(task.task);
            });

            row.appendChild(taskBar);
        }

        ganttBody.appendChild(row);
    });
}

// æ¸²æŸ“ä»Šå¤©çº¿
function renderTodayLine(dateRange) {
    const todayLine = document.getElementById('gantt-today-line');
    const today = new Date();
    const todayStr = today.toISOString().split('T')[0];

    console.log('æŸ¥æ‰¾ä»Šå¤©:', todayStr);
    console.log('æ—¥æœŸèŒƒå›´:', dateRange.dates.map(d => d.toISOString().split('T')[0]));

    const todayIndex = dateRange.dates.findIndex(date =>
        date.toISOString().split('T')[0] === todayStr
    );

    console.log('ä»Šå¤©çš„ç´¢å¼•:', todayIndex, 'æ€»å¤©æ•°:', dateRange.totalDays);

    if (todayIndex >= 0) {
        // ç­‰å¾…DOMæ¸²æŸ“å®Œæˆåå†è®¡ç®—ä½ç½®
        setTimeout(() => {
            const timeline = document.getElementById('gantt-timeline');
            const ganttContainer = document.getElementById('gantt-container');

            if (timeline && ganttContainer) {
                // æ ¹æ®è§†å›¾æ¨¡å¼é€‰æ‹©ä¸åŒçš„è®¡ç®—æ–¹å¼
                if (currentViewMode === 'Week') {
                    // å‘¨è§†å›¾ï¼šåŸºäºå‘¨å•å…ƒæ ¼è®¡ç®—
                    const weekRow = timeline.querySelector('.gantt-timeline-week-row');
                    if (weekRow) {
                        const weekCells = weekRow.querySelectorAll('.gantt-timeline-week-cell');
                        const todayWeekCell = weekRow.querySelector('.gantt-timeline-week-cell.has-today');

                        if (todayWeekCell) {
                            const cellRect = todayWeekCell.getBoundingClientRect();
                            const containerRect = ganttContainer.getBoundingClientRect();

                            // è®¡ç®—ä»Šå¤©åœ¨è¿™å‘¨ä¸­çš„ä½ç½®
                            const todayWeekNumber = getWeekNumber(today);
                            const weekDates = dateRange.dates.filter(date => getWeekNumber(date) === todayWeekNumber);
                            const todayIndexInWeek = weekDates.findIndex(date =>
                                date.toISOString().split('T')[0] === todayStr
                            );

                            const cellWidth = cellRect.width;
                            const dayWidth = cellWidth / weekDates.length;
                            const position = cellRect.left - containerRect.left + (todayIndexInWeek * dayWidth) + (dayWidth / 2);

                            todayLine.style.left = `${position}px`;
                            todayLine.style.top = `${timeline.offsetHeight}px`;
                            todayLine.style.display = 'block';

                            console.log('å‘¨è§†å›¾ä»Šå¤©çº¿ä½ç½®:', {
                                todayWeekNumber,
                                todayIndexInWeek,
                                weekDates: weekDates.length,
                                position: position + 'px'
                            });
                        }
                    }
                } else if (currentViewMode === 'Month') {
                    // æœˆè§†å›¾ï¼šåŸºäºæœˆå•å…ƒæ ¼è®¡ç®—
                    const monthRow = timeline.querySelector('.gantt-timeline-month-row');
                    if (monthRow) {
                        const monthCells = monthRow.querySelectorAll('.gantt-timeline-month-header.month-view');
                        const todayMonthCell = monthRow.querySelector('.gantt-timeline-month-header.month-view.has-today');

                        if (todayMonthCell) {
                            const cellRect = todayMonthCell.getBoundingClientRect();
                            const containerRect = ganttContainer.getBoundingClientRect();

                            // è®¡ç®—ä»Šå¤©åœ¨è¿™ä¸ªæœˆä¸­çš„ä½ç½®
                            const todayMonth = today.getMonth();
                            const todayYear = today.getFullYear();
                            const monthDates = dateRange.dates.filter(date =>
                                date.getMonth() === todayMonth && date.getFullYear() === todayYear
                            );
                            const todayIndexInMonth = monthDates.findIndex(date =>
                                date.toISOString().split('T')[0] === todayStr
                            );

                            const cellWidth = cellRect.width;
                            const dayWidth = cellWidth / monthDates.length;
                            const position = cellRect.left - containerRect.left + (todayIndexInMonth * dayWidth) + (dayWidth / 2);

                            todayLine.style.left = `${position}px`;
                            todayLine.style.top = `${timeline.offsetHeight}px`;
                            todayLine.style.display = 'block';

                            console.log('æœˆè§†å›¾ä»Šå¤©çº¿ä½ç½®:', {
                                todayMonth: todayMonth + 1,
                                todayIndexInMonth,
                                monthDates: monthDates.length,
                                position: position + 'px'
                            });
                        }
                    }
                } else {
                    // æ—¥è§†å›¾ï¼šåŸºäºæ—¥æœŸå•å…ƒæ ¼è®¡ç®—
                    const dayRow = timeline.querySelector('.gantt-timeline-day-row');
                    if (dayRow) {
                        const dayCells = dayRow.querySelectorAll('.gantt-timeline-day-cell');

                        if (dayCells[todayIndex]) {
                            const todayCell = dayCells[todayIndex];
                            const cellRect = todayCell.getBoundingClientRect();
                            const containerRect = ganttContainer.getBoundingClientRect();

                            const position = cellRect.left - containerRect.left + (cellRect.width / 2);

                            todayLine.style.left = `${position}px`;
                            todayLine.style.top = `${timeline.offsetHeight}px`;
                            todayLine.style.display = 'block';

                            console.log('æ—¥è§†å›¾ä»Šå¤©çº¿ä½ç½®:', {
                                todayIndex,
                                position: position + 'px'
                            });
                        }
                    }
                }
            }
        }, 300); // å¢åŠ å»¶è¿Ÿç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
    } else {
        todayLine.style.display = 'none';
        console.log('ä»Šå¤©ä¸åœ¨å½“å‰æ—¥æœŸèŒƒå›´å†…');
    }
}

// ç­‰å¾…ç”˜ç‰¹å›¾å®Œå…¨æ¸²æŸ“
function waitForGanttRender(callback, maxAttempts = 20, currentAttempt = 0) {
    if (currentAttempt >= maxAttempts) {
        console.warn('ç­‰å¾…ç”˜ç‰¹å›¾æ¸²æŸ“è¶…æ—¶ï¼Œå¼ºåˆ¶æ‰§è¡Œå›è°ƒ');
        callback();
        return;
    }

    // æ£€æŸ¥ç”˜ç‰¹å›¾æ˜¯å¦å·²ç»æ¸²æŸ“å®Œæˆ
    const ganttContainer = document.querySelector('#gantt-container');
    const ganttSvg = ganttContainer ? ganttContainer.querySelector('svg') : null;
    const ganttBars = ganttContainer ? ganttContainer.querySelectorAll('.bar') : [];
    const ganttHeaders = ganttContainer ? ganttContainer.querySelectorAll('.grid-header-cell') : [];

    console.log(`æ¸²æŸ“æ£€æŸ¥ ${currentAttempt + 1}/${maxAttempts}:`, {
        container: !!ganttContainer,
        svg: !!ganttSvg,
        bars: ganttBars.length,
        headers: ganttHeaders.length,
        containerWidth: ganttContainer ? ganttContainer.offsetWidth : 0
    });

    // æ£€æŸ¥ç”˜ç‰¹å›¾æ˜¯å¦å·²ç»æœ‰å†…å®¹
    if (ganttContainer &&
        ganttContainer.offsetWidth > 0 &&
        (ganttSvg || ganttBars.length > 0 || ganttHeaders.length > 0)) {

        console.log('ç”˜ç‰¹å›¾æ¸²æŸ“å®Œæˆï¼Œæ‰§è¡Œå›è°ƒ');
        // å†ç­‰ä¸€ç‚¹æ—¶é—´ç¡®ä¿å®Œå…¨æ¸²æŸ“
        setTimeout(callback, 200);
        return;
    }

    // å¦‚æœè¿˜æ²¡æœ‰æ¸²æŸ“å®Œæˆï¼Œç»§ç»­ç­‰å¾…
    setTimeout(() => {
        waitForGanttRender(callback, maxAttempts, currentAttempt + 1);
    }, 300);
}

function bindEventListeners() {
    // è§†å›¾æ¨¡å¼åˆ‡æ¢
    document.getElementById('viewModeDay').addEventListener('click', function() {
        updateActiveButton(this);
        const tasks = <%- JSON.stringify(ganttTasks) %>;
        renderGanttChart(tasks, 'Day');
        console.log('åˆ‡æ¢åˆ°æ—¥è§†å›¾');
    });

    document.getElementById('viewModeWeek').addEventListener('click', function() {
        updateActiveButton(this);
        const tasks = <%- JSON.stringify(ganttTasks) %>;
        renderGanttChart(tasks, 'Week');
        console.log('åˆ‡æ¢åˆ°å‘¨è§†å›¾');
    });

    document.getElementById('viewModeMonth').addEventListener('click', function() {
        updateActiveButton(this);
        const tasks = <%- JSON.stringify(ganttTasks) %>;
        renderGanttChart(tasks, 'Month');
        console.log('åˆ‡æ¢åˆ°æœˆè§†å›¾');
    });

    // ä»Šå¤©æŒ‰é’®
    document.getElementById('todayBtn').addEventListener('click', function() {
        // æ»šåŠ¨åˆ°ä»Šå¤©çº¿çš„ä½ç½®
        const todayLine = document.getElementById('gantt-today-line');
        if (todayLine && todayLine.style.display !== 'none') {
            todayLine.scrollIntoView({ behavior: 'smooth', inline: 'center' });
        }
    });
}

// æ›´æ–°æ´»åŠ¨æŒ‰é’®
function updateActiveButton(activeBtn) {
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    activeBtn.classList.add('active');
}

// æ¸²æŸ“ä»»åŠ¡åˆ—è¡¨
function renderTaskList(tasks) {
    const container = document.getElementById('task-list-container');

    if (tasks.length === 0) {
        container.innerHTML = '<div class="alert alert-info text-center py-5"><i class="fas fa-info-circle me-2"></i>æš‚æ— ä»»åŠ¡æ•°æ®</div>';
        return;
    }

    const taskListHtml = tasks.map(task => {
        const taskData = task.task;
        const assigneeName = taskData.assignee ?
            `${taskData.assignee.firstName || ''} ${taskData.assignee.lastName || ''}`.trim() || taskData.assignee.username :
            'æœªåˆ†é…';

        return `
            <div class="card mb-1 task-card gantt-task-item" data-task-id="${task.id}" onclick="highlightTask('${task.id}')">
                <div class="card-body py-1 px-2">
                    <div class="row align-items-center">
                        <!-- ä»»åŠ¡æ ‡é¢˜å’Œæ˜Ÿçº§ -->
                        <div class="col-md-3">
                            <div class="d-flex align-items-center">
                                <h6 class="card-title mb-0 me-2 text-truncate" style="max-width: 200px;">
                                    <a href="/tasks/${taskData.id}" class="text-decoration-none task-title-link">
                                        ${task.name}
                                    </a>
                                </h6>
                                <span class="badge bg-warning">
                                    ${'â­'.repeat(taskData.starLevel || 0)}
                                </span>
                            </div>
                        </div>

                        <!-- å¿«é€Ÿç¼–è¾‘å­—æ®µ -->
                        <div class="col-md-2">
                            <select class="form-select form-select-sm quick-edit-field"
                                    data-task-id="${taskData.id}"
                                    data-field="status">
                                <option value="draft" ${taskData.status === 'draft' ? 'selected' : ''}>è‰ç¨¿</option>
                                <option value="published" ${taskData.status === 'published' ? 'selected' : ''}>å·²å‘å¸ƒ</option>
                                <option value="bidding" ${taskData.status === 'bidding' ? 'selected' : ''}>ç«æ ‡ä¸­</option>
                                <option value="assigned" ${taskData.status === 'assigned' ? 'selected' : ''}>å·²åˆ†é…</option>
                                <option value="in_progress" ${taskData.status === 'in_progress' ? 'selected' : ''}>è¿›è¡Œä¸­</option>
                                <option value="review" ${taskData.status === 'review' ? 'selected' : ''}>å¾…å®¡æ ¸</option>
                                <option value="completed" ${taskData.status === 'completed' ? 'selected' : ''}>å·²å®Œæˆ</option>
                                <option value="cancelled" ${taskData.status === 'cancelled' ? 'selected' : ''}>å·²å–æ¶ˆ</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm quick-edit-field"
                                    data-task-id="${taskData.id}"
                                    data-field="assigneeId">
                                <option value="">æœªåˆ†é…</option>
                                ${taskData.project && taskData.project.members ?
                                    taskData.project.members.map(member =>
                                        `<option value="${member.id}" ${taskData.assigneeId === member.id ? 'selected' : ''}>
                                            ${(member.firstName + ' ' + member.lastName).trim() || member.username}
                                        </option>`
                                    ).join('') : ''
                                }
                            </select>
                        </div>
                        <div class="col-md-2">
                            <select class="form-select form-select-sm quick-edit-field"
                                    data-task-id="${taskData.id}"
                                    data-field="urgencyLevel">
                                <option value="urgent" ${taskData.urgencyLevel === 'urgent' ? 'selected' : ''}>ğŸ”¥ ç´§æ€¥</option>
                                <option value="important" ${taskData.urgencyLevel === 'important' ? 'selected' : ''}>âš¡ é‡è¦</option>
                                <option value="normal" ${taskData.urgencyLevel === 'normal' ? 'selected' : ''}>ğŸ“… æ™®é€š</option>
                                <option value="delayed" ${taskData.urgencyLevel === 'delayed' ? 'selected' : ''}>ğŸ• å»¶æœŸ</option>
                                <option value="frozen" ${taskData.urgencyLevel === 'frozen' ? 'selected' : ''}>â„ï¸ å†»ç»“</option>
                            </select>
                        </div>

                        <!-- ä»»åŠ¡ä¿¡æ¯ -->
                        <div class="col-md-2">
                            <small class="text-muted">
                                <div><i class="fas fa-user me-1"></i>${taskData.publisher ? (taskData.publisher.firstName + ' ' + taskData.publisher.lastName).trim() || taskData.publisher.username : 'æœªçŸ¥'}</div>
                                ${taskData.estimatedHours || taskData.dueDate ? `<div>
                                    ${taskData.estimatedHours ? `<i class="fas fa-clock me-1"></i>${taskData.estimatedHours}h` : ''}
                                    ${taskData.dueDate ? `<i class="fas fa-calendar ms-1 me-1"></i>${new Date(taskData.dueDate).toLocaleDateString('zh-CN')}` : ''}
                                </div>` : ''}
                            </small>
                        </div>

                        <!-- æ“ä½œæŒ‰é’® -->
                        <div class="col-md-1 text-end">
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-ellipsis-h"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="/tasks/${taskData.id}">
                                        <i class="fas fa-eye me-2"></i>æŸ¥çœ‹è¯¦æƒ…
                                    </a></li>
                                    <li><a class="dropdown-item" href="/tasks/create?parent=${taskData.id}">
                                        <i class="fas fa-plus me-2"></i>æ·»åŠ å­ä»»åŠ¡
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="/tasks/${taskData.id}/edit">
                                        <i class="fas fa-edit me-2"></i>ç¼–è¾‘
                                    </a></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteTask('${taskData.id}', '${task.name}')">
                                        <i class="fas fa-trash me-2"></i>åˆ é™¤
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    container.innerHTML = taskListHtml;

    // åˆå§‹åŒ–å¿«é€Ÿç¼–è¾‘åŠŸèƒ½
    initQuickEdit();
}

// åˆå§‹åŒ–å¿«é€Ÿç¼–è¾‘åŠŸèƒ½
function initQuickEdit() {
    // åˆå§‹åŒ–å¿«é€Ÿç¼–è¾‘å­—æ®µï¼Œä¿å­˜åŸå§‹å€¼
    $('.quick-edit-field').each(function() {
        const $select = $(this);
        $select.data('original-value', $select.val());
    });

    // å¿«é€Ÿç¼–è¾‘å­—æ®µå¤„ç†
    $(document).off('change', '.quick-edit-field').on('change', '.quick-edit-field', function() {
        const $select = $(this);
        const taskId = $select.data('task-id');
        const field = $select.data('field');
        const value = $select.val();
        const originalValue = $select.data('original-value');

        console.log('å¿«é€Ÿç¼–è¾‘è§¦å‘:', { taskId, field, value, originalValue });

        // ç¦ç”¨é€‰æ‹©æ¡†å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        $select.prop('disabled', true);
        $select.addClass('loading');

        // å‘é€AJAXè¯·æ±‚
        $.ajax({
            url: `/tasks/${taskId}/quick-update`,
            method: 'POST',
            dataType: 'json',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            data: {
                field: field,
                value: value
            },
            success: function(response) {
                console.log('AJAXæˆåŠŸå“åº”:', response);
                if (response.success) {
                    // æ˜¾ç¤ºæˆåŠŸæç¤º
                    showToast('success', response.message);
                    // æ›´æ–°åŸå§‹å€¼
                    $select.data('original-value', value);
                } else {
                    // æ¢å¤åŸå§‹å€¼
                    $select.val($select.data('original-value'));
                    showToast('error', response.message || 'æ›´æ–°å¤±è´¥');
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAXé”™è¯¯:', { xhr, status, error });
                console.error('å“åº”æ–‡æœ¬:', xhr.responseText);
                // æ¢å¤åŸå§‹å€¼
                $select.val($select.data('original-value'));
                const errorMsg = xhr.responseJSON?.message || `ç½‘ç»œé”™è¯¯ï¼š${error}`;
                showToast('error', errorMsg);
            },
            complete: function() {
                // æ¢å¤é€‰æ‹©æ¡†çŠ¶æ€
                $select.prop('disabled', false);
                $select.removeClass('loading');
            }
        });
    });
}

// æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
function showToast(type, message) {
    // åˆ›å»ºæç¤ºå…ƒç´ 
    const toast = $(`
        <div class="toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check' : 'exclamation-triangle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        </div>
    `);

    // æ·»åŠ åˆ°é¡µé¢
    let toastContainer = $('#toast-container');
    if (toastContainer.length === 0) {
        toastContainer = $('<div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>');
        $('body').append(toastContainer);
    }

    toastContainer.append(toast);

    // æ˜¾ç¤ºæç¤º
    const bsToast = new bootstrap.Toast(toast[0]);
    bsToast.show();

    // è‡ªåŠ¨ç§»é™¤
    toast.on('hidden.bs.toast', function() {
        $(this).remove();
    });
}

// åˆ é™¤ä»»åŠ¡å‡½æ•°
function deleteTask(taskId, taskTitle) {
    if (confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${taskTitle}"å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ’¤é”€ï¼Œä»»åŠ¡çš„æ‰€æœ‰ç›¸å…³æ•°æ®éƒ½å°†è¢«åˆ é™¤ã€‚`)) {
        // åˆ›å»ºè¡¨å•å¹¶æäº¤
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/tasks/${taskId}/delete`;

        // æ·»åŠ CSRF tokenï¼ˆå¦‚æœéœ€è¦ï¼‰
        const csrfToken = document.querySelector('meta[name="csrf-token"]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = '_token';
            csrfInput.value = csrfToken.getAttribute('content');
            form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
    }
}

// é«˜äº®ä»»åŠ¡
function highlightTask(taskId) {
    // æ¸…é™¤æ‰€æœ‰é«˜äº®
    document.querySelectorAll('.gantt-task-item').forEach(item => {
        item.classList.remove('active');
    });

    // é«˜äº®é€‰ä¸­çš„ä»»åŠ¡
    const taskItem = document.querySelector(`[data-task-id="${taskId}"]`);
    if (taskItem) {
        taskItem.classList.add('active');
    }
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return `${date.getMonth() + 1}/${date.getDate()}`;
}

// æ ¼å¼åŒ–ä¸­æ–‡æ—¥æœŸ
function formatDateChinese(dateStr) {
    const date = new Date(dateStr);
    const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
    return `${months[date.getMonth()]}${date.getDate()}æ—¥`;
}

// ä¸å†éœ€è¦çš„å‡½æ•°ï¼Œå·²é›†æˆåˆ°è‡ªå®šä¹‰ç”˜ç‰¹å›¾ä¸­
// æ·»åŠ æ—¶é—´æ ‡ç­¾
function addTimeLabels(tasks) {
    setTimeout(() => {
        // ç§»é™¤å·²å­˜åœ¨çš„æ—¶é—´æ ‡ç­¾
        const existingLabels = document.querySelectorAll('.gantt-time-label');
        existingLabels.forEach(label => label.remove());

        // å°è¯•å¤šç§é€‰æ‹©å™¨æ‰¾åˆ°ç”˜ç‰¹å›¾æ¡
        const bars = document.querySelectorAll('#gantt-container .bar') ||
                    document.querySelectorAll('.gantt-container .bar') ||
                    document.querySelectorAll('.bar');

        console.log('æ‰¾åˆ°çš„ç”˜ç‰¹å›¾æ¡æ•°é‡:', bars.length, 'ä»»åŠ¡æ•°é‡:', tasks.length);

        bars.forEach((bar, index) => {
            if (tasks[index]) {
                const task = tasks[index];

                // æ¸…é™¤è¯¥æ¡ä¸Šå·²æœ‰çš„æ—¶é—´æ ‡ç­¾
                const existingLabelsInBar = bar.querySelectorAll('.gantt-time-label');
                existingLabelsInBar.forEach(label => label.remove());

                // ç¡®ä¿baræœ‰ç›¸å¯¹å®šä½
                bar.style.position = 'relative';

                // æ·»åŠ å¼€å§‹æ—¶é—´æ ‡ç­¾
                const startLabel = document.createElement('div');
                startLabel.className = 'gantt-time-label start';
                startLabel.textContent = formatDate(task.start);
                startLabel.style.position = 'absolute';
                startLabel.style.left = '-50px';
                startLabel.style.top = '50%';
                startLabel.style.transform = 'translateY(-50%)';
                startLabel.style.fontSize = '0.7rem';
                startLabel.style.color = '#6c757d';
                startLabel.style.whiteSpace = 'nowrap';
                startLabel.style.background = 'rgba(255, 255, 255, 0.9)';
                startLabel.style.padding = '1px 4px';
                startLabel.style.borderRadius = '2px';
                startLabel.style.zIndex = '5';
                bar.appendChild(startLabel);

                // æ·»åŠ ç»“æŸæ—¶é—´æ ‡ç­¾
                const endLabel = document.createElement('div');
                endLabel.className = 'gantt-time-label end';
                endLabel.textContent = formatDate(task.end);
                endLabel.style.position = 'absolute';
                endLabel.style.right = '-50px';
                endLabel.style.top = '50%';
                endLabel.style.transform = 'translateY(-50%)';
                endLabel.style.fontSize = '0.7rem';
                endLabel.style.color = '#6c757d';
                endLabel.style.whiteSpace = 'nowrap';
                endLabel.style.background = 'rgba(255, 255, 255, 0.9)';
                endLabel.style.padding = '1px 4px';
                endLabel.style.borderRadius = '2px';
                endLabel.style.zIndex = '5';
                bar.appendChild(endLabel);

                console.log(`ä¸ºä»»åŠ¡ ${index} æ·»åŠ äº†æ—¶é—´æ ‡ç­¾:`, task.start, '-', task.end);
            }
        });
    }, 1000);
}

// å¼ºåˆ¶åº”ç”¨ä»»åŠ¡çŠ¶æ€é¢œè‰²
function applyTaskColors(tasks) {
    console.log('å¼€å§‹åº”ç”¨ä»»åŠ¡çŠ¶æ€é¢œè‰²...');

    // å¤šæ¬¡å°è¯•åº”ç”¨é¢œè‰²ï¼Œç¡®ä¿ç”˜ç‰¹å›¾å®Œå…¨æ¸²æŸ“
    let attempts = 0;
    const maxAttempts = 10;

    function tryApplyColors() {
        attempts++;

        // å°è¯•å¤šç§é€‰æ‹©å™¨æ‰¾åˆ°ç”˜ç‰¹å›¾æ¡
        let bars = document.querySelectorAll('#gantt-container .bar');
        if (bars.length === 0) {
            bars = document.querySelectorAll('#gantt-container rect.bar');
        }
        if (bars.length === 0) {
            bars = document.querySelectorAll('#gantt-container .gantt-bar');
        }
        if (bars.length === 0) {
            bars = document.querySelectorAll('#gantt-container rect');
        }

        console.log(`ç¬¬${attempts}æ¬¡å°è¯•åº”ç”¨é¢œè‰²ï¼Œæ‰¾åˆ°${bars.length}ä¸ªç”˜ç‰¹å›¾æ¡`);
        console.log('ç”˜ç‰¹å›¾å®¹å™¨å†…å®¹:', document.querySelector('#gantt-container').innerHTML.substring(0, 200));

        if (bars.length === 0 && attempts < maxAttempts) {
            setTimeout(tryApplyColors, 200);
            return;
        }

        bars.forEach((bar, index) => {
            if (tasks[index]) {
                const task = tasks[index];
                const status = task.task ? task.task.status : task.status;

                // å®šä¹‰é¢œè‰²æ˜ å°„
                const colorMap = {
                    'published': '#007bff',    // è“è‰² - å¾…æ¥å•
                    'assigned': '#ffc107',     // é»„è‰² - è¿›è¡Œä¸­
                    'in_progress': '#ffc107',  // é»„è‰² - è¿›è¡Œä¸­
                    'review': '#17a2b8',       // é’è‰² - å¾…å®¡æ ¸
                    'completed': '#28a745'     // ç»¿è‰² - å·²å®Œæˆ
                };

                const color = colorMap[status] || '#6c757d';

                console.log(`å¤„ç†ä»»åŠ¡ ${index}:`, {
                    status: status,
                    color: color,
                    element: bar.tagName,
                    classes: bar.className
                });

                // æ ¹æ®å…ƒç´ ç±»å‹è®¾ç½®é¢œè‰²
                if (bar.tagName === 'rect' || bar.tagName === 'RECT') {
                    // SVG rectå…ƒç´ 
                    bar.setAttribute('fill', color);
                    bar.style.fill = color;
                } else {
                    // HTMLå…ƒç´ 
                    bar.style.backgroundColor = color;
                    bar.style.background = color;
                }

                // è®¾ç½®è¿›åº¦æ¡å†…éƒ¨çš„è¿›åº¦é¢œè‰²
                const progressBar = bar.querySelector('.bar-progress') ||
                                  bar.querySelector('rect.bar-progress');
                if (progressBar) {
                    if (progressBar.tagName === 'rect' || progressBar.tagName === 'RECT') {
                        progressBar.setAttribute('fill', 'rgba(255,255,255,0.3)');
                        progressBar.style.fill = 'rgba(255,255,255,0.3)';
                    } else {
                        progressBar.style.backgroundColor = 'rgba(255,255,255,0.3)';
                        progressBar.style.background = 'rgba(255,255,255,0.3)';
                    }
                }

                // æ·»åŠ CSSç±»å’Œå±æ€§ç”¨äºåç»­è¯†åˆ«
                bar.classList.add(`task-${status}`);
                bar.setAttribute('data-status', status);
            }
        });

        // å¦‚æœè¿˜æœ‰æ›´å¤šå°è¯•æœºä¼šï¼Œç»§ç»­å°è¯•
        if (attempts < maxAttempts) {
            setTimeout(tryApplyColors, 300);
        }
    }

    // ç«‹å³å¼€å§‹ç¬¬ä¸€æ¬¡å°è¯•
    tryApplyColors();
}

// æ ¼å¼åŒ–æ—¥æœŸ
function formatDate(dateStr) {
    const date = new Date(dateStr);
    return `${date.getMonth() + 1}/${date.getDate()}`;
}

// æ ¼å¼åŒ–ä¸­æ–‡æ—¥æœŸ
function formatDateChinese(dateStr) {
    const date = new Date(dateStr);
    const months = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];
    return `${months[date.getMonth()]}${date.getDate()}æ—¥`;
}

// è‡ªå®šä¹‰ä¸­æ–‡æ—¥å†æ˜¾ç¤º
function customizeChineseCalendar() {
    setTimeout(() => {
        try {
            // æ›¿æ¢æœˆä»½æ˜¾ç¤º
            const headerCells = document.querySelectorAll('#gantt-container .grid-header .grid-header-cell');
            headerCells.forEach(cell => {
                const text = cell.textContent.trim();

                // æ›¿æ¢è‹±æ–‡æœˆä»½ä¸ºä¸­æ–‡
                const monthMap = {
                    'January': '1æœˆ', 'Jan': '1æœˆ',
                    'February': '2æœˆ', 'Feb': '2æœˆ',
                    'March': '3æœˆ', 'Mar': '3æœˆ',
                    'April': '4æœˆ', 'Apr': '4æœˆ',
                    'May': '5æœˆ',
                    'June': '6æœˆ', 'Jun': '6æœˆ',
                    'July': '7æœˆ', 'Jul': '7æœˆ',
                    'August': '8æœˆ', 'Aug': '8æœˆ',
                    'September': '9æœˆ', 'Sep': '9æœˆ',
                    'October': '10æœˆ', 'Oct': '10æœˆ',
                    'November': '11æœˆ', 'Nov': '11æœˆ',
                    'December': '12æœˆ', 'Dec': '12æœˆ'
                };

                // æ›¿æ¢æ˜ŸæœŸæ˜¾ç¤º
                const dayMap = {
                    'Monday': 'å‘¨ä¸€', 'Mon': 'å‘¨ä¸€',
                    'Tuesday': 'å‘¨äºŒ', 'Tue': 'å‘¨äºŒ',
                    'Wednesday': 'å‘¨ä¸‰', 'Wed': 'å‘¨ä¸‰',
                    'Thursday': 'å‘¨å››', 'Thu': 'å‘¨å››',
                    'Friday': 'å‘¨äº”', 'Fri': 'å‘¨äº”',
                    'Saturday': 'å‘¨å…­', 'Sat': 'å‘¨å…­',
                    'Sunday': 'å‘¨æ—¥', 'Sun': 'å‘¨æ—¥'
                };

                let newText = text;

                // æ›¿æ¢æœˆä»½
                Object.keys(monthMap).forEach(eng => {
                    newText = newText.replace(new RegExp(eng, 'gi'), monthMap[eng]);
                });

                // æ›¿æ¢æ˜ŸæœŸ
                Object.keys(dayMap).forEach(eng => {
                    newText = newText.replace(new RegExp(eng, 'gi'), dayMap[eng]);
                });

                // å¤„ç†å¹´ä»½æ˜¾ç¤º
                newText = newText.replace(/(\d{4})/g, '$1å¹´');

                if (newText !== text) {
                    cell.textContent = newText;
                }
            });

            // æ›¿æ¢ä»Šå¤©æŒ‰é’®çš„æ–‡æœ¬
            const todayButtons = document.querySelectorAll('#gantt-container .gantt-today');
            todayButtons.forEach(btn => {
                if (btn.textContent.toLowerCase().includes('today')) {
                    btn.textContent = 'ä»Šå¤©';
                }
            });

        } catch (error) {
            console.warn('ä¸­æ–‡æ—¥å†è‡ªå®šä¹‰å¤±è´¥:', error);
        }
    }, 800);
}

// è®¾ç½®DOMè§‚å¯Ÿå™¨æ¥ç›‘æ§ç”˜ç‰¹å›¾å˜åŒ–
function setupGanttObserver() {
    const ganttContainer = document.getElementById('gantt-container');
    if (!ganttContainer) return;

    // åˆ›å»ºè§‚å¯Ÿå™¨å®ä¾‹
    const observer = new MutationObserver(function(mutations) {
        let shouldUpdate = false;

        mutations.forEach(function(mutation) {
            // æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„èŠ‚ç‚¹æ·»åŠ 
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                for (let node of mutation.addedNodes) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯ç”˜ç‰¹å›¾ç›¸å…³çš„å…ƒç´ 
                        if (node.classList && (
                            node.classList.contains('grid-header') ||
                            node.classList.contains('grid-header-cell') ||
                            node.querySelector && node.querySelector('.grid-header-cell')
                        )) {
                            shouldUpdate = true;
                            break;
                        }
                    }
                }
            }
        });

        if (shouldUpdate) {
            // å»¶è¿Ÿæ‰§è¡Œä»¥ç¡®ä¿DOMå®Œå…¨æ›´æ–°
            setTimeout(() => {
                customizeChineseCalendar();
            }, 100);
        }
    });

    // å¼€å§‹è§‚å¯Ÿ
    observer.observe(ganttContainer, {
        childList: true,
        subtree: true
    });

    // ä¿å­˜è§‚å¯Ÿå™¨å¼•ç”¨ä»¥ä¾¿åç»­æ¸…ç†
    window.ganttObserver = observer;
}

// è·å–çŠ¶æ€æ ·å¼ç±»
function getStatusClass(status) {
    const classMap = {
        'published': 'bg-primary text-white',
        'assigned': 'bg-warning text-dark',
        'in_progress': 'bg-warning text-dark',
        'review': 'bg-info text-white',
        'completed': 'bg-success text-white'
    };
    return classMap[status] || 'bg-secondary text-white';
}

// è·å–çŠ¶æ€æ–‡æœ¬
function getStatusText(status) {
    const statusMap = {
        'published': 'å¾…æ¥å•',
        'assigned': 'è¿›è¡Œä¸­',
        'in_progress': 'è¿›è¡Œä¸­',
        'review': 'å¾…å®¡æ ¸',
        'completed': 'å·²å®Œæˆ'
    };
    return statusMap[status] || status;
}

// æ˜¾ç¤ºä»»åŠ¡è¯¦æƒ…
function showTaskDetail(task) {
    const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
    const content = document.getElementById('taskDetailContent');
    const viewBtn = document.getElementById('viewTaskBtn');

    // è®¾ç½®ä»»åŠ¡è¯¦æƒ…å†…å®¹
    content.innerHTML = `
        <div class="row">
            <div class="col-lg-8 col-md-7">
                <div class="mb-4">
                    <h5 class="mb-3">${task.title}</h5>
                    <p class="text-muted mb-3">${task.description || 'æš‚æ— æè¿°'}</p>
                </div>

                <div class="row g-3 mb-4">
                    <div class="col-sm-6 col-md-4">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">ä»»åŠ¡ç±»å‹</label>
                            <div class="fw-medium">${getTaskTypeText(task.taskType)}</div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">çŠ¶æ€</label>
                            <div class="fw-medium">
                                <span class="badge ${getStatusClass(task.status)}">${getStatusText(task.status)}</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-sm-6 col-md-4">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">æ˜Ÿçº§</label>
                            <div class="fw-medium">${'â­'.repeat(task.starLevel)}</div>
                        </div>
                    </div>

                    ${task.estimatedHours ? `
                    <div class="col-sm-6 col-md-4">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">é¢„ä¼°å·¥æ—¶</label>
                            <div class="fw-medium">${task.estimatedHours} å°æ—¶</div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="col-sm-6 col-md-4">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">æˆªæ­¢æ—¶é—´</label>
                            <div class="fw-medium">${task.dueDate ? formatDateChinese(task.dueDate.split('T')[0]) : 'æœªè®¾ç½®'}</div>
                        </div>
                    </div>
                </div>

                ${task.publisher || task.assignee ? `
                <div class="row g-3">
                    ${task.publisher ? `
                    <div class="col-sm-6">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">å‘å¸ƒè€…</label>
                            <div class="fw-medium">${task.publisher.firstName || ''} ${task.publisher.lastName || ''} (${task.publisher.username})</div>
                        </div>
                    </div>
                    ` : ''}
                    ${task.assignee ? `
                    <div class="col-sm-6">
                        <div class="info-item">
                            <label class="form-label text-muted mb-1">è´Ÿè´£äºº</label>
                            <div class="fw-medium">${task.assignee.firstName || ''} ${task.assignee.lastName || ''} (${task.assignee.username})</div>
                        </div>
                    </div>
                    ` : ''}
                </div>
                ` : ''}
            </div>
            <div class="col-lg-4 col-md-5">
                <div class="card bg-light h-100">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fas fa-clock me-2"></i>å·¥æ—¶ä¿¡æ¯</h6>
                    </div>
                    <div class="card-body">
                        <div class="time-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">é¢„ä¼°å·¥æ—¶</span>
                                <span class="fw-bold text-primary">${task.estimatedHours || 0} å°æ—¶</span>
                            </div>
                        </div>
                        ${task.actualHours ? `
                        <div class="time-item mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="text-muted">å®é™…å·¥æ—¶</span>
                                <span class="fw-bold text-warning">${task.actualHours} å°æ—¶</span>
                            </div>
                        </div>
                        <hr>
                        <div class="time-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="fw-medium">å·¥æ—¶æ•ˆç‡</span>
                                <span class="fw-bold ${task.actualHours <= task.estimatedHours ? 'text-success' : 'text-danger'} fs-5">
                                    ${task.estimatedHours > 0 ? Math.round((task.estimatedHours / task.actualHours) * 100) : 0}%
                                </span>
                            </div>
                        </div>
                        ` : `
                        <div class="text-center text-muted">
                            <i class="fas fa-hourglass-start fa-2x mb-2"></i>
                            <p class="mb-0">ä»»åŠ¡è¿›è¡Œä¸­</p>
                        </div>
                        `}
                    </div>
                </div>
            </div>
        </div>
    `;

    // è®¾ç½®æŸ¥çœ‹è¯¦æƒ…æŒ‰é’®é“¾æ¥
    viewBtn.href = `/tasks/${task.id}`;

    modal.show();
}

// è¾…åŠ©å‡½æ•°
function getTaskTypeText(type) {
    const typeMap = {
        'requirement': 'éœ€æ±‚',
        'task': 'ä»»åŠ¡',
        'bug': 'ç¼ºé™·',
        'epic': 'å²è¯—',
        'story': 'ç”¨æˆ·æ•…äº‹'
    };
    return typeMap[type] || type;
}




</script>

<%- include('../partials/footer') %>

<%- include('../partials/header') %>
<%- include('../helpers/roleHelper') %>

<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- é¡µé¢æ ‡é¢˜ -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">
                    <% if (isCreateMode) { %>
                        <i class="fas fa-user-plus me-2"></i>
                        æ‹›å‹Ÿå‹‡è€…
                    <% } else { %>
                        <i class="fas fa-user-edit me-2"></i>
                        ç¼–è¾‘å‹‡è€…æ¡£æ¡ˆ
                    <% } %>
                </h1>
                <a href="/users" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    è¿”å›åå†Œ
                </a>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ (ä»…ç¼–è¾‘æ¨¡å¼æ˜¾ç¤º) -->
            <% if (!isCreateMode && editUser) { %>
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex align-items-center">
                        <div class="avatar-circle me-3">
                            <% if (editUser.avatar) { %>
                                <img src="<%= editUser.avatar %>" alt="<%= editUser.getFullName() %>" class="rounded-circle" width="50" height="50">
                            <% } else { %>
                                <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 50px; height: 50px;">
                                    <h5 class="mb-0"><%= editUser.firstName.charAt(0).toUpperCase() %></h5>
                                </div>
                            <% } %>
                        </div>
                        <div>
                            <h5 class="card-title mb-0"><%= editUser.getFullName() %></h5>
                            <p class="text-muted mb-0">@<%= editUser.username %> â€¢ <%= editUser.email %></p>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <strong>å½“å‰èŒä¸šï¼š</strong><br>
                            <%- renderRoleBadge(editUser.role, true) %>
                        </div>
                        <div class="col-md-3">
                            <strong>æŠ€èƒ½ç­‰çº§ï¼š</strong><br>
                            <span class="badge bg-<%= editUser.skillLevel === 'diamond' ? 'info' : editUser.skillLevel === 'gold' ? 'warning' : editUser.skillLevel === 'silver' ? 'secondary' : editUser.skillLevel === 'bronze' ? 'dark' : 'light' %>">
                                <% if (editUser.skillLevel === 'diamond') { %>ğŸ’ é’»çŸ³
                                <% } else if (editUser.skillLevel === 'gold') { %>ğŸ¥‡ é»„é‡‘
                                <% } else if (editUser.skillLevel === 'silver') { %>ğŸ¥ˆ ç™½é“¶
                                <% } else if (editUser.skillLevel === 'bronze') { %>ğŸ¥‰ é’é“œ
                                <% } else { %>ğŸ”° æ–°æ‰‹<% } %>
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>è´¦æˆ·çŠ¶æ€ï¼š</strong><br>
                            <span class="badge bg-<%= editUser.status === 'active' ? 'success' : editUser.status === 'inactive' ? 'warning' : 'danger' %>">
                                <% if (editUser.status === 'active') { %>âœ… æ´»è·ƒ
                                <% } else if (editUser.status === 'inactive') { %>â¸ï¸ æœªæ¿€æ´»
                                <% } else { %>ğŸš« å·²ç¦ç”¨<% } %>
                            </span>
                        </div>
                        <div class="col-md-3">
                            <strong>æ³¨å†Œæ—¶é—´ï¼š</strong><br>
                            <span class="text-muted"><%= moment(editUser.createdAt).format('YYYY-MM-DD') %></span>
                        </div>
                    </div>

                    <% if (editUser.wallet) { %>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <strong>é’±åŒ…ä½™é¢ï¼š</strong>
                                <div class="d-flex gap-3 mt-2">
                                    <span class="badge bg-info">ğŸ’ <%= editUser.wallet.diamondBalance %></span>
                                    <span class="badge bg-warning">ğŸ¥‡ <%= editUser.wallet.goldBalance %></span>
                                    <span class="badge bg-secondary">ğŸ¥ˆ <%= editUser.wallet.silverBalance %></span>
                                    <span class="badge bg-dark">ğŸ¥‰ <%= editUser.wallet.copperBalance %></span>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </div>
            </div>
            <% } %>

            <!-- ç”¨æˆ·è¡¨å• -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <% if (isCreateMode) { %>
                            å‹‡è€…æ¡£æ¡ˆ
                        <% } else { %>
                            ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯
                        <% } %>
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="<% if (isCreateMode) { %>/users/create<% } else { %>/users/<%= editUser.id %>/edit<% } %>">
                        <div class="row">
                            <!-- åŸºæœ¬ä¿¡æ¯ -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">åŸºæœ¬ä¿¡æ¯</h6>

                                <div class="mb-3">
                                    <label for="firstName" class="form-label">å§“å <span class="text-danger">*</span></label>
                                    <div class="row">
                                        <div class="col-6">
                                            <input type="text" class="form-control" id="firstName" name="firstName"
                                                   value="<% if (!isCreateMode && editUser) { %><%= editUser.firstName %><% } %>" placeholder="å§“" required>
                                        </div>
                                        <div class="col-6">
                                            <input type="text" class="form-control" id="lastName" name="lastName"
                                                   value="<% if (!isCreateMode && editUser) { %><%= editUser.lastName %><% } %>" placeholder="å" required>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label for="username" class="form-label">ç”¨æˆ·å <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="username" name="username"
                                           value="<% if (!isCreateMode && editUser) { %><%= editUser.username %><% } %>" placeholder="ç”¨æˆ·ç™»å½•å" required>
                                    <div class="form-text">ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œ3-50ä¸ªå­—ç¬¦</div>
                                </div>

                                <div class="mb-3">
                                    <label for="email" class="form-label">é‚®ç®± <span class="text-danger">*</span></label>
                                    <input type="email" class="form-control" id="email" name="email"
                                           value="<% if (!isCreateMode && editUser) { %><%= editUser.email %><% } %>" placeholder="user@example.com" required>
                                </div>

                                <div class="mb-3">
                                    <label for="phone" class="form-label">æ‰‹æœºå·</label>
                                    <input type="tel" class="form-control" id="phone" name="phone"
                                           value="<% if (!isCreateMode && editUser) { %><%= editUser.phone || '' %><% } %>" placeholder="æ‰‹æœºå·ç ï¼ˆå¯é€‰ï¼‰">
                                </div>

                                <div class="mb-3">
                                    <label for="password" class="form-label">
                                        <% if (isCreateMode) { %>
                                            å¯†ç  <span class="text-danger">*</span>
                                        <% } else { %>
                                            æ–°å¯†ç 
                                        <% } %>
                                    </label>
                                    <input type="password" class="form-control" id="password" name="password"
                                           placeholder="<% if (isCreateMode) { %>è‡³å°‘6ä½å¯†ç <% } else { %>ç•™ç©ºåˆ™ä¸ä¿®æ”¹å¯†ç <% } %>"
                                           <% if (isCreateMode) { %>required<% } %> minlength="6">
                                    <div class="form-text">
                                        <% if (isCreateMode) { %>
                                            å¯†ç é•¿åº¦è‡³å°‘6ä½
                                        <% } else { %>
                                            å¦‚éœ€ä¿®æ”¹å¯†ç ï¼Œè¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰
                                        <% } %>
                                    </div>
                                </div>
                            </div>

                            <!-- è§’è‰²å’Œæƒé™ -->
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">è§’è‰²å’Œæƒé™</h6>

                                <div class="mb-3">
                                    <label for="role" class="form-label">èŒä¸šè§’è‰² <span class="text-danger">*</span></label>
                                    <select class="form-select" id="role" name="role" required>
                                        <% if (isCreateMode) { %>
                                            <option value="">è¯·é€‰æ‹©èŒä¸š</option>
                                        <% } %>
                                        <option value="guild_master" <% if (!isCreateMode && editUser && editUser.role === 'guild_master') { %>selected<% } %>>âš¡ ç¥åŸŸå®ˆæŠ¤è€… (ç®¡ç†å‘˜)</option>
                                        <option value="quest_captain" <% if (!isCreateMode && editUser && editUser.role === 'quest_captain') { %>selected<% } %>>ğŸ”® é¢„è¨€å¸ˆ (äº§å“ç»ç†)</option>
                                        <option value="swordsman" <% if (isCreateMode || (!isCreateMode && editUser && editUser.role === 'swordsman')) { %>selected<% } %>>âš”ï¸ å‰‘å£« (å¼€å‘è€…)</option>
                                        <option value="ranger" <% if (!isCreateMode && editUser && editUser.role === 'ranger') { %>selected<% } %>>ğŸ¹ å¼“ç®­æ‰‹ (æµ‹è¯•å‘˜)</option>
                                        <option value="quest_giver" <% if (!isCreateMode && editUser && editUser.role === 'quest_giver') { %>selected<% } %>>ğŸ’ å§”æ‰˜è´µæ— (å®¢æˆ·)</option>
                                        <option value="enchanter" <% if (!isCreateMode && editUser && editUser.role === 'enchanter') { %>selected<% } %>>ğŸ”® é­”æ³•å¸ˆ (UIè®¾è®¡å¸ˆ)</option>
                                        <option value="alchemist" <% if (!isCreateMode && editUser && editUser.role === 'alchemist') { %>selected<% } %>>âœ¨ ç‰§å¸ˆ (è¿ç»´å·¥ç¨‹å¸ˆ)</option>
                                    </select>
                                    <% if (isCreateMode) { %>
                                        <div class="form-text">
                                            <small>
                                                <strong>èŒä¸šè¯´æ˜ï¼š</strong><br>
                                                â€¢ âš¡ ç¥åŸŸå®ˆæŠ¤ (ç®¡ç†å‘˜)ï¼šæ‹¥æœ‰è‡³é«˜æƒé™çš„ç¥çº§å­˜åœ¨ï¼Œå®ˆæŠ¤æ•´ä¸ªå¼‚ä¸–ç•Œ<br>
                                                â€¢ ğŸ”® é¢„è¨€å¸ˆ (äº§å“ç»ç†)ï¼šé¢„æµ‹å’Œè§„åˆ’æœªæ¥çš„ç¥ç§˜å­¦è€…<br>
                                                â€¢ âš”ï¸ å‰‘å£« (å¼€å‘è€…)ï¼šæŒ¥å‰‘æ–©æ•Œçš„å‰çº¿æˆ˜æ–—ä¸“å®¶ï¼Œè´Ÿè´£ä»»åŠ¡å¼€å‘å’Œå®ç°<br>
                                                â€¢ ğŸ¹ å¼“ç®­æ‰‹ (æµ‹è¯•å‘˜)ï¼šæ½œè¡Œæ¢æŸ¥ã€å‘ç°è¿½è¸ªéšæ‚£çš„ä¸“ä¸šä¾¦å¯Ÿè€…ï¼Œè´Ÿè´£è´¨é‡ä¿è¯å’Œæµ‹è¯•<br>
                                                â€¢ ğŸ’ å§”æ‰˜è´µæ— (å®¢æˆ·)ï¼šå‘å¸ƒæ¢é™©å§”æ‰˜çš„å°Šè´µèµåŠ©æ–¹<br>
                                                â€¢ âœ¨ æ³•å¸ˆ (UIè®¾è®¡å¸ˆ)ï¼š æ–½å±•è§†è§‰é­”æ³•çš„è‰ºæœ¯å¤§å¸ˆ<br>
                                                â€¢ ğŸŒ™ ç‰§å¸ˆ (è¿ç»´å·¥ç¨‹å¸ˆ)ï¼šç»´æŠ¤ç¥ç§˜æœºæ¢°å’Œè®¾æ–½çš„æŠ€æœ¯ä¸“å®¶ï¼Œè´Ÿè´£ç³»ç»Ÿè¿ç»´<br>
                                            </small>
                                        </div>
                                    <% } %>
                                </div>

                                <div class="mb-3">
                                    <label for="skillLevel" class="form-label">æŠ€èƒ½ç­‰çº§</label>
                                    <select class="form-select" id="skillLevel" name="skillLevel">
                                        <option value="novice" <% if (isCreateMode || (!isCreateMode && editUser && editUser.skillLevel === 'novice')) { %>selected<% } %>>ğŸ”° æ–°æ‰‹ - åˆå­¦è€…</option>
                                        <option value="bronze" <% if (!isCreateMode && editUser && editUser.skillLevel === 'bronze') { %>selected<% } %>>ğŸ¥‰ é’é“œ - æœ‰ä¸€å®šç»éªŒ</option>
                                        <option value="silver" <% if (!isCreateMode && editUser && editUser.skillLevel === 'silver') { %>selected<% } %>>ğŸ¥ˆ ç™½é“¶ - ç»éªŒä¸°å¯Œ</option>
                                        <option value="gold" <% if (!isCreateMode && editUser && editUser.skillLevel === 'gold') { %>selected<% } %>>ğŸ¥‡ é»„é‡‘ - æŠ€èƒ½ç²¾æ¹›</option>
                                        <option value="diamond" <% if (!isCreateMode && editUser && editUser.skillLevel === 'diamond') { %>selected<% } %>>ğŸ’ é’»çŸ³ - é¡¶çº§ä¸“å®¶</option>
                                    </select>
                                    <div class="form-text">æŠ€èƒ½ç­‰çº§å½±å“å¯æ¥å–çš„ä»»åŠ¡éš¾åº¦</div>
                                </div>

                                <div class="mb-3">
                                    <label for="status" class="form-label">è´¦æˆ·çŠ¶æ€</label>
                                    <select class="form-select" id="status" name="status">
                                        <option value="active" <% if (isCreateMode || (!isCreateMode && editUser && editUser.status === 'active')) { %>selected<% } %>>âœ… æ´»è·ƒ - æ­£å¸¸ä½¿ç”¨</option>
                                        <option value="inactive" <% if (!isCreateMode && editUser && editUser.status === 'inactive') { %>selected<% } %>>â¸ï¸ æœªæ¿€æ´» - éœ€è¦æ¿€æ´»</option>
                                        <option value="suspended" <% if (!isCreateMode && editUser && editUser.status === 'suspended') { %>selected<% } %>>ğŸš« å·²ç¦ç”¨ - ç¦æ­¢ç™»å½•</option>
                                    </select>
                                </div>

                                <% if (isCreateMode) { %>
                                    <!-- æ¸¸æˆåŒ–ä¿¡æ¯æç¤º -->
                                    <div class="alert alert-info">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-gift me-1"></i>
                                            æ–°ç”¨æˆ·ç¦åˆ©
                                        </h6>
                                        <p class="mb-0">æ–°ç”¨æˆ·å°†è‡ªåŠ¨è·å¾—ï¼š</p>
                                        <ul class="mb-0 mt-2">
                                            <li>ğŸ¥‡ 100é‡‘å¸ æ–°æ‰‹å¥–åŠ±</li>
                                            <li>ğŸ¯ å®Œæ•´çš„è™šæ‹Ÿé’±åŒ…</li>
                                            <li>ğŸ“Š ä¸ªäººæ•°æ®ç»Ÿè®¡</li>
                                        </ul>
                                    </div>
                                <% } else { %>
                                    <!-- å±é™©æ“ä½œåŒºåŸŸ -->
                                    <div class="alert alert-warning">
                                        <h6 class="alert-heading">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            å±é™©æ“ä½œ
                                        </h6>
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-warning btn-sm"
                                                    onclick="showResetPasswordModal()">
                                                <i class="fas fa-key me-1"></i>
                                                é‡ç½®å¯†ç 
                                            </button>
                                            <% if (editUser.id !== user.id) { %>
                                                <button type="button" class="btn btn-outline-danger btn-sm"
                                                        onclick="confirmDelete('<%= editUser.id %>', '<%= editUser.username %>')">
                                                    <i class="fas fa-ban me-1"></i>
                                                    ç¦ç”¨è´¦æˆ·
                                                </button>
                                            <% } %>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>

                        <!-- æäº¤æŒ‰é’® -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <hr>
                                <div class="d-flex justify-content-end">
                                    <a href="/users" class="btn btn-secondary me-2">
                                        <i class="fas fa-times me-1"></i>
                                        å–æ¶ˆ
                                    </a>
                                    <button type="submit" class="btn btn-primary">
                                        <% if (isCreateMode) { %>
                                            <i class="fas fa-user-plus me-1"></i>
                                            æ‹›å‹Ÿå‹‡è€…
                                        <% } else { %>
                                            <i class="fas fa-save me-1"></i>
                                            ä¿å­˜ä¿®æ”¹
                                        <% } %>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<% if (!isCreateMode) { %>
<!-- é‡ç½®å¯†ç æ¨¡æ€æ¡† -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">é‡ç½®ç”¨æˆ·å¯†ç </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/users/<%= editUser.id %>/reset-password">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">æ–°å¯†ç </label>
                        <input type="password" class="form-control" id="newPassword" name="newPassword"
                               placeholder="è¯·è¾“å…¥æ–°å¯†ç " required minlength="6">
                        <div class="form-text">å¯†ç é•¿åº¦è‡³å°‘6ä½</div>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        é‡ç½®å¯†ç åï¼Œç”¨æˆ·éœ€è¦ä½¿ç”¨æ–°å¯†ç é‡æ–°ç™»å½•ã€‚
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-warning">ç¡®è®¤é‡ç½®</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡† -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ç¡®è®¤ç¦ç”¨ç”¨æˆ·</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ç¡®å®šè¦ç¦ç”¨ç”¨æˆ· <strong id="deleteUsername"></strong> å—ï¼Ÿ</p>
                <p class="text-muted small">ç¦ç”¨åç”¨æˆ·å°†æ— æ³•ç™»å½•ç³»ç»Ÿï¼Œä½†æ•°æ®ä¸ä¼šè¢«åˆ é™¤ã€‚</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">ç¡®è®¤ç¦ç”¨</button>
                </form>
            </div>
        </div>
    </div>
</div>
<% } %>

<script>
<% if (!isCreateMode) { %>
function showResetPasswordModal() {
    new bootstrap.Modal(document.getElementById('resetPasswordModal')).show();
}

function confirmDelete(userId, username) {
    document.getElementById('deleteUsername').textContent = username;
    document.getElementById('deleteForm').action = '/users/' + userId + '/delete';
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}
<% } %>

// è¡¨å•éªŒè¯
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const isCreateMode = <%= isCreateMode ? 'true' : 'false' %>;

    // ç”¨æˆ·åéªŒè¯
    usernameInput.addEventListener('input', function() {
        const value = this.value;
        const isValid = /^[a-zA-Z0-9]{3,50}$/.test(value);

        if (value && !isValid) {
            this.classList.add('is-invalid');
            this.setCustomValidity('ç”¨æˆ·ååªèƒ½åŒ…å«å­—æ¯å’Œæ•°å­—ï¼Œ3-50ä¸ªå­—ç¬¦');
        } else {
            this.classList.remove('is-invalid');
            this.setCustomValidity('');
        }
    });

    // å¯†ç å¼ºåº¦æç¤ºï¼ˆä»…åˆ›å»ºæ¨¡å¼ï¼‰
    if (isCreateMode && passwordInput) {
        passwordInput.addEventListener('input', function() {
            const value = this.value;
            const strength = getPasswordStrength(value);

            // ç§»é™¤ä¹‹å‰çš„æç¤º
            const existingFeedback = this.parentNode.querySelector('.password-strength');
            if (existingFeedback) {
                existingFeedback.remove();
            }

            if (value) {
                const feedback = document.createElement('div');
                feedback.className = 'password-strength form-text';
                feedback.innerHTML = `å¯†ç å¼ºåº¦: <span class="badge bg-${strength.color}">${strength.text}</span>`;
                this.parentNode.appendChild(feedback);
            }
        });
    }

    function getPasswordStrength(password) {
        if (password.length < 6) {
            return { color: 'danger', text: 'å¤ªå¼±' };
        } else if (password.length < 8) {
            return { color: 'warning', text: 'ä¸€èˆ¬' };
        } else if (password.length >= 8 && /[A-Z]/.test(password) && /[0-9]/.test(password)) {
            return { color: 'success', text: 'å¼º' };
        } else {
            return { color: 'info', text: 'ä¸­ç­‰' };
        }
    }
});
</script>

<%- include('../partials/footer') %>

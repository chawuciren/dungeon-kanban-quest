<%- include('../partials/header', { title: title }) %>

<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-wallet me-2 text-primary"></i>
            æˆ‘çš„é’±åŒ…
        </h2>
        <p class="text-muted mb-0">ç®¡ç†æ‚¨çš„è™šæ‹Ÿè´§å¸èµ„äº§</p>
    </div>
</div>

<!-- é’±åŒ…æ¦‚è§ˆ -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-gem fa-3x text-info"></i>
                </div>
                <h3 class="mb-1" id="diamondBalance">0</h3>
                <p class="text-muted mb-2">é’»çŸ³</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    å†»ç»“: <span id="frozenDiamond">0</span>
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-coins fa-3x text-warning"></i>
                </div>
                <h3 class="mb-1" id="goldBalance">0</h3>
                <p class="text-muted mb-2">é‡‘å¸</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    å†»ç»“: <span id="frozenGold">0</span>
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-circle fa-3x text-secondary"></i>
                </div>
                <h3 class="mb-1" id="silverBalance">0</h3>
                <p class="text-muted mb-2">é“¶å¸</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    å†»ç»“: <span id="frozenSilver">0</span>
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-circle fa-3x text-dark"></i>
                </div>
                <h3 class="mb-1" id="copperBalance">0</h3>
                <p class="text-muted mb-2">é“œå¸</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    å†»ç»“: <span id="frozenCopper">0</span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <h4 class="mb-1" id="totalEarned">0</h4>
                <p class="mb-0">ç´¯è®¡æ”¶å…¥</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <h4 class="mb-1" id="totalSpent">0</h4>
                <p class="mb-0">ç´¯è®¡æ”¯å‡º</p>
            </div>
        </div>
    </div>
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <h4 class="mb-1" id="totalAssets">0</h4>
                <p class="mb-0">æ€»èµ„äº§ï¼ˆé“œå¸ï¼‰</p>
            </div>
        </div>
    </div>
</div>

<!-- æ“ä½œåŒºåŸŸ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    é’±åŒ…æ“ä½œ
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-success" id="dailyCheckinBtn">
                                <i class="fas fa-calendar-check me-2"></i>
                                æ¯æ—¥ç­¾åˆ°
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            æ¯æ—¥å¯è·å¾—100é‡‘å¸
                        </small>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-primary" id="monthlyRechargeBtn">
                                <i class="fas fa-gem me-2"></i>
                                æœˆåº¦å……å€¼
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            æ¯æœˆå¯è·å¾—3000é‡‘å¸+10é’»çŸ³
                        </small>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-warning" id="exchangeBtn">
                                <i class="fas fa-exchange-alt me-2"></i>
                                è´§å¸å…‘æ¢
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            ä¸åŒè´§å¸é—´å…‘æ¢
                        </small>
                    </div>
                    <div class="col-md-3">
                        <div class="d-grid">
                            <button class="btn btn-info" id="transferBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                è½¬è´¦
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            å‘å…¶ä»–ç”¨æˆ·è½¬è´¦
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- äº¤æ˜“å†å² -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    äº¤æ˜“å†å²
                </h5>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary active" data-filter="all">å…¨éƒ¨</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="income">æ”¶å…¥</button>
                    <button type="button" class="btn btn-outline-primary" data-filter="expense">æ”¯å‡º</button>
                </div>
            </div>
            <div class="card-body">
                <div id="transactionsList">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½äº¤æ˜“è®°å½•...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è´§å¸å…‘æ¢æ¨¡æ€æ¡† -->
<div class="modal fade" id="exchangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    è´§å¸å…‘æ¢
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exchangeForm">
                    <div class="mb-3">
                        <label class="form-label">å…‘æ¢æ–¹å‘</label>
                        <select class="form-select" id="exchangeDirection">
                            <option value="gold_to_silver">é‡‘å¸ â†’ é“¶å¸ (1:100)</option>
                            <option value="silver_to_copper">é“¶å¸ â†’ é“œå¸ (1:100)</option>
                            <option value="diamond_to_gold">é’»çŸ³ â†’ é‡‘å¸ (1:1000)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exchangeAmount" class="form-label">å…‘æ¢æ•°é‡</label>
                        <input type="number" class="form-control" id="exchangeAmount" min="1" required>
                        <div class="form-text" id="exchangePreview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" id="confirmExchange">ç¡®è®¤å…‘æ¢</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // åŠ è½½é’±åŒ…æ•°æ®
    loadWalletData();
    loadTransactions();
    
    // æ¯æ—¥ç­¾åˆ°
    $('#dailyCheckinBtn').click(function() {
        const btn = $(this);
        KanbanApp.setLoading(btn, true);
        
        $.post('/api/wallet/daily-checkin')
            .done(function(response) {
                if (response.success) {
                    KanbanApp.showAlert(response.message, 'success');
                    loadWalletData();
                } else {
                    KanbanApp.showAlert(response.message, 'warning');
                }
            })
            .fail(function(xhr) {
                const response = xhr.responseJSON;
                KanbanApp.showAlert(response?.message || 'ç­¾åˆ°å¤±è´¥', 'danger');
            })
            .always(function() {
                KanbanApp.setLoading(btn, false);
            });
    });
    
    // æœˆåº¦å……å€¼
    $('#monthlyRechargeBtn').click(function() {
        const btn = $(this);
        KanbanApp.setLoading(btn, true);
        
        $.post('/api/wallet/monthly-recharge')
            .done(function(response) {
                if (response.success) {
                    KanbanApp.showAlert(response.message, 'success');
                    loadWalletData();
                } else {
                    KanbanApp.showAlert(response.message, 'warning');
                }
            })
            .fail(function(xhr) {
                const response = xhr.responseJSON;
                KanbanApp.showAlert(response?.message || 'å……å€¼å¤±è´¥', 'danger');
            })
            .always(function() {
                KanbanApp.setLoading(btn, false);
            });
    });
    
    // è´§å¸å…‘æ¢
    $('#exchangeBtn').click(function() {
        $('#exchangeModal').modal('show');
    });
    
    // è½¬è´¦åŠŸèƒ½
    $('#transferBtn').click(function() {
        KanbanApp.showAlert('è½¬è´¦åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
    });
    
    // å…‘æ¢é¢„è§ˆ
    $('#exchangeAmount, #exchangeDirection').on('input change', function() {
        updateExchangePreview();
    });
    
    // ç¡®è®¤å…‘æ¢
    $('#confirmExchange').click(function() {
        KanbanApp.showAlert('è´§å¸å…‘æ¢åŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­...', 'info');
        $('#exchangeModal').modal('hide');
    });
    
    // äº¤æ˜“å†å²ç­›é€‰
    $('[data-filter]').click(function() {
        $('[data-filter]').removeClass('active');
        $(this).addClass('active');
        loadTransactions($(this).data('filter'));
    });
});

// åŠ è½½é’±åŒ…æ•°æ®
function loadWalletData() {
    $.get('/api/wallet/stats')
        .done(function(response) {
            if (response.success) {
                const data = response.data;
                
                // æ›´æ–°ä½™é¢æ˜¾ç¤º
                $('#diamondBalance').text(data.balances.diamond.toLocaleString());
                $('#goldBalance').text(data.balances.gold.toLocaleString());
                $('#silverBalance').text(data.balances.silver.toLocaleString());
                $('#copperBalance').text(data.balances.copper.toLocaleString());
                
                // æ›´æ–°å†»ç»“é‡‘é¢
                $('#frozenDiamond').text(data.frozenBalances.diamond.toLocaleString());
                $('#frozenGold').text(data.frozenBalances.gold.toLocaleString());
                $('#frozenSilver').text(data.frozenBalances.silver.toLocaleString());
                $('#frozenCopper').text(data.frozenBalances.copper.toLocaleString());
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                $('#totalEarned').text(data.totalEarned.toLocaleString());
                $('#totalSpent').text(data.totalSpent.toLocaleString());
                $('#totalAssets').text(data.totalAssets.toLocaleString());
                
                // æ›´æ–°å¯¼èˆªæ é’±åŒ…æ˜¾ç¤º
                KanbanApp.updateWalletDisplay(data.balances);
            }
        })
        .fail(function() {
            KanbanApp.showAlert('æ— æ³•åŠ è½½é’±åŒ…æ•°æ®', 'danger');
        });
}

// åŠ è½½äº¤æ˜“è®°å½•
function loadTransactions(filter = 'all') {
    $('#transactionsList').html(`
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">åŠ è½½ä¸­...</span>
            </div>
            <p class="mt-2 text-muted">æ­£åœ¨åŠ è½½äº¤æ˜“è®°å½•...</p>
        </div>
    `);
    
    // æ¨¡æ‹ŸåŠ è½½å»¶è¿Ÿ
    setTimeout(() => {
        const transactionsHtml = generateTransactionsHTML(filter);
        $('#transactionsList').html(transactionsHtml);
    }, 500);
}

// ç”Ÿæˆäº¤æ˜“è®°å½•HTML
function generateTransactionsHTML(filter) {
    const sampleTransactions = [
        {
            type: 'income',
            description: 'æ¯æ—¥ç­¾åˆ°å¥–åŠ±',
            amount: 100,
            currency: 'gold',
            date: '2024-01-10 09:00:00'
        },
        {
            type: 'income',
            description: 'å®Œæˆä»»åŠ¡ï¼šå®ç°ç”¨æˆ·ç™»å½•åŠŸèƒ½',
            amount: 100,
            currency: 'gold',
            date: '2024-01-09 15:30:00'
        },
        {
            type: 'expense',
            description: 'å‘å¸ƒä»»åŠ¡ï¼šä¼˜åŒ–æ•°æ®åº“æ€§èƒ½',
            amount: 200,
            currency: 'gold',
            date: '2024-01-08 10:15:00'
        }
    ];
    
    let filteredTransactions = sampleTransactions;
    if (filter !== 'all') {
        filteredTransactions = sampleTransactions.filter(t => t.type === filter);
    }
    
    if (filteredTransactions.length === 0) {
        return `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">æš‚æ— äº¤æ˜“è®°å½•</p>
            </div>
        `;
    }
    
    let html = '<div class="list-group list-group-flush">';
    filteredTransactions.forEach(transaction => {
        const currencyIcon = {
            diamond: 'ğŸ’',
            gold: 'ğŸ¥‡',
            silver: 'ğŸ¥ˆ',
            copper: 'ğŸ¥‰'
        }[transaction.currency];
        
        const typeClass = transaction.type === 'income' ? 'text-success' : 'text-danger';
        const typeIcon = transaction.type === 'income' ? 'fa-plus' : 'fa-minus';
        const sign = transaction.type === 'income' ? '+' : '-';
        
        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">${transaction.description}</h6>
                        <small class="text-muted">${transaction.date}</small>
                    </div>
                    <div class="text-end">
                        <div class="${typeClass} fw-bold">
                            <i class="fas ${typeIcon} me-1"></i>
                            ${sign}${currencyIcon} ${transaction.amount.toLocaleString()}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    return html;
}

// æ›´æ–°å…‘æ¢é¢„è§ˆ
function updateExchangePreview() {
    const direction = $('#exchangeDirection').val();
    const amount = parseInt($('#exchangeAmount').val()) || 0;
    
    if (amount <= 0) {
        $('#exchangePreview').text('');
        return;
    }
    
    let preview = '';
    switch (direction) {
        case 'gold_to_silver':
            preview = `å°†è·å¾— ${(amount * 100).toLocaleString()} é“¶å¸`;
            break;
        case 'silver_to_copper':
            preview = `å°†è·å¾— ${(amount * 100).toLocaleString()} é“œå¸`;
            break;
        case 'diamond_to_gold':
            preview = `å°†è·å¾— ${(amount * 1000).toLocaleString()} é‡‘å¸`;
            break;
    }
    
    $('#exchangePreview').text(preview);
}
</script>

<%- include('../partials/footer') %>

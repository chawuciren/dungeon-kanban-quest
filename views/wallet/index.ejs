<%- include('../partials/header', { title: title }) %>

<!-- 页面标题 -->
<div class="row mb-4">
    <div class="col-12">
        <h2>
            <i class="fas fa-wallet me-2 text-primary"></i>
            我的钱包
        </h2>
        <p class="text-muted mb-0">管理您的虚拟货币资产</p>
    </div>
</div>

<!-- 钱包概览 -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-gem fa-3x" style="color: #00bcd4;"></i>
                </div>
                <h3 class="mb-1"><%= wallet ? wallet.diamondBalance.toLocaleString() : 0 %></h3>
                <p class="text-muted mb-2">钻石</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    冻结: <%= wallet ? wallet.frozenDiamond.toLocaleString() : 0 %>
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-coins fa-3x" style="color: #ffd700;"></i>
                </div>
                <h3 class="mb-1"><%= wallet ? wallet.goldBalance.toLocaleString() : 0 %></h3>
                <p class="text-muted mb-2">金币</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    冻结: <%= wallet ? wallet.frozenGold.toLocaleString() : 0 %>
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-coins fa-3x" style="color: #c0c0c0;"></i>
                </div>
                <h3 class="mb-1"><%= wallet ? wallet.silverBalance.toLocaleString() : 0 %></h3>
                <p class="text-muted mb-2">银币</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    冻结: <%= wallet ? wallet.frozenSilver.toLocaleString() : 0 %>
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card border-0 shadow-sm h-100">
            <div class="card-body text-center">
                <div class="mb-3">
                    <i class="fas fa-coins fa-3x" style="color: #2d5016;"></i>
                </div>
                <h3 class="mb-1"><%= wallet ? wallet.copperBalance.toLocaleString() : 0 %></h3>
                <p class="text-muted mb-2">铜币</p>
                <small class="text-success">
                    <i class="fas fa-lock me-1"></i>
                    冻结: <%= wallet ? wallet.frozenCopper.toLocaleString() : 0 %>
                </small>
            </div>
        </div>
    </div>
</div>



<!-- 操作区域 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    钱包操作
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-success<%= !canCheckin ? ' disabled' : '' %>" id="dailyCheckinBtn" <%= !canCheckin ? 'disabled' : '' %>>
                                <i class="fas fa-calendar-check me-2"></i>
                                <%= canCheckin ? '每日签到' : '已签到' %>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            每日可获得100金币
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-warning" id="exchangeBtn">
                                <i class="fas fa-exchange-alt me-2"></i>
                                货币兑换
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            不同货币间兑换
                        </small>
                    </div>
                    <div class="col-md-4">
                        <div class="d-grid">
                            <button class="btn btn-info" id="transferBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                转账
                            </button>
                        </div>
                        <small class="text-muted d-block mt-1 text-center">
                            向其他用户转账
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 交易历史 -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-history me-2"></i>
                    交易历史
                </h5>
            </div>
            <div class="card-body">
                <div id="transactionsList">
                    <%
                    // 模拟更多交易记录数据用于分页演示
                    const allTransactions = [
                        {
                            type: 'income',
                            description: '每日签到奖励',
                            amount: 100,
                            currency: 'gold',
                            date: '2024-01-15 09:00:00'
                        },
                        {
                            type: 'income',
                            description: '完成任务：实现用户登录功能',
                            amount: 150,
                            currency: 'gold',
                            date: '2024-01-14 15:30:00'
                        },
                        {
                            type: 'expense',
                            description: '发布任务：优化数据库性能',
                            amount: 200,
                            currency: 'gold',
                            date: '2024-01-13 10:15:00'
                        },
                        {
                            type: 'income',
                            description: '完成任务：修复登录Bug',
                            amount: 80,
                            currency: 'gold',
                            date: '2024-01-12 16:45:00'
                        },
                        {
                            type: 'expense',
                            description: '发布任务：前端界面优化',
                            amount: 120,
                            currency: 'gold',
                            date: '2024-01-11 11:20:00'
                        },
                        {
                            type: 'income',
                            description: '每日签到奖励',
                            amount: 100,
                            currency: 'gold',
                            date: '2024-01-10 09:00:00'
                        },
                        {
                            type: 'income',
                            description: '完成任务：API接口开发',
                            amount: 180,
                            currency: 'gold',
                            date: '2024-01-09 14:30:00'
                        },
                        {
                            type: 'expense',
                            description: '发布任务：数据库设计',
                            amount: 250,
                            currency: 'gold',
                            date: '2024-01-08 10:15:00'
                        },
                        {
                            type: 'income',
                            description: '完成任务：系统架构设计',
                            amount: 300,
                            currency: 'gold',
                            date: '2024-01-07 17:00:00'
                        },
                        {
                            type: 'income',
                            description: '每日签到奖励',
                            amount: 100,
                            currency: 'gold',
                            date: '2024-01-06 09:00:00'
                        },
                        {
                            type: 'expense',
                            description: '发布任务：测试用例编写',
                            amount: 150,
                            currency: 'gold',
                            date: '2024-01-05 13:30:00'
                        },
                        {
                            type: 'income',
                            description: '完成任务：代码重构',
                            amount: 200,
                            currency: 'gold',
                            date: '2024-01-04 16:15:00'
                        },
                        {
                            type: 'income',
                            description: '完成任务：项目文档编写',
                            amount: 120,
                            currency: 'gold',
                            date: '2024-01-02 14:20:00'
                        },
                        {
                            type: 'expense',
                            description: '发布任务：移动端适配',
                            amount: 180,
                            currency: 'gold',
                            date: '2024-01-01 16:30:00'
                        }
                    ];

                    // 分页参数（从路由传递）
                    const page = typeof currentPage !== 'undefined' ? currentPage : 1;
                    const size = typeof pageSize !== 'undefined' ? pageSize : 8;
                    const totalTransactions = allTransactions.length;
                    const totalPages = Math.ceil(totalTransactions / size);

                    // 计算当前页的数据
                    const startIndex = (page - 1) * size;
                    const endIndex = startIndex + size;
                    const sampleTransactions = allTransactions.slice(startIndex, endIndex);
                    %>

                    <% if (sampleTransactions.length > 0) { %>
                        <div class="list-group list-group-flush">
                            <% sampleTransactions.forEach(transaction => { %>
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <h6 class="mb-1"><%= transaction.description %></h6>
                                            <small class="text-muted"><%= transaction.date %></small>
                                        </div>
                                        <div class="text-end">
                                            <div class="<%= transaction.type === 'income' ? 'text-success' : 'text-danger' %> fw-bold">
                                                <i class="fas <%= transaction.type === 'income' ? 'fa-plus' : 'fa-minus' %> me-1"></i>
                                                <%= transaction.type === 'income' ? '+' : '-' %>
                                                <%
                                                const currencyIcons = {
                                                    diamond: '<i class="fas fa-gem" style="color: #00bcd4;"></i>',
                                                    gold: '<i class="fas fa-coins" style="color: #ffd700;"></i>',
                                                    silver: '<i class="fas fa-coins" style="color: #c0c0c0;"></i>',
                                                    copper: '<i class="fas fa-coins" style="color: #2d5016;"></i>'
                                                };
                                                %>
                                                <%- currencyIcons[transaction.currency] %> <%= transaction.amount.toLocaleString() %>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }); %>
                        </div>

                        <!-- 分页组件 -->
                        <% if (totalPages > 1) { %>
                            <div class="d-flex justify-content-between align-items-center mt-4">
                                <div class="text-muted">
                                    显示第 <%= startIndex + 1 %>-<%= Math.min(endIndex, totalTransactions) %> 条，共 <%= totalTransactions %> 条记录
                                </div>
                                <nav aria-label="交易记录分页">
                                    <ul class="pagination pagination-sm mb-0">
                                        <!-- 上一页 -->
                                        <li class="page-item <%= page === 1 ? 'disabled' : '' %>">
                                            <a class="page-link" href="/wallet?page=<%= page - 1 %>" aria-label="上一页">
                                                <span aria-hidden="true">&laquo;</span>
                                            </a>
                                        </li>

                                        <!-- 页码 -->
                                        <%
                                        // 计算显示的页码范围
                                        let startPage = Math.max(1, page - 2);
                                        let endPage = Math.min(totalPages, page + 2);

                                        // 确保显示5个页码（如果总页数足够）
                                        if (endPage - startPage < 4) {
                                            if (startPage === 1) {
                                                endPage = Math.min(totalPages, startPage + 4);
                                            } else {
                                                startPage = Math.max(1, endPage - 4);
                                            }
                                        }
                                        %>

                                        <!-- 第一页 -->
                                        <% if (startPage > 1) { %>
                                            <li class="page-item">
                                                <a class="page-link" href="/wallet?page=1">1</a>
                                            </li>
                                            <% if (startPage > 2) { %>
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            <% } %>
                                        <% } %>

                                        <!-- 中间页码 -->
                                        <% for (let i = startPage; i <= endPage; i++) { %>
                                            <li class="page-item <%= i === page ? 'active' : '' %>">
                                                <a class="page-link" href="/wallet?page=<%= i %>"><%= i %></a>
                                            </li>
                                        <% } %>

                                        <!-- 最后一页 -->
                                        <% if (endPage < totalPages) { %>
                                            <% if (endPage < totalPages - 1) { %>
                                                <li class="page-item disabled">
                                                    <span class="page-link">...</span>
                                                </li>
                                            <% } %>
                                            <li class="page-item">
                                                <a class="page-link" href="/wallet?page=<%= totalPages %>"><%= totalPages %></a>
                                            </li>
                                        <% } %>

                                        <!-- 下一页 -->
                                        <li class="page-item <%= page === totalPages ? 'disabled' : '' %>">
                                            <a class="page-link" href="/wallet?page=<%= page + 1 %>" aria-label="下一页">
                                                <span aria-hidden="true">&raquo;</span>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        <% } %>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <p class="text-muted mb-0">暂无交易记录</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 货币兑换模态框 -->
<div class="modal fade" id="exchangeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exchange-alt me-2"></i>
                    货币兑换
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="exchangeForm">
                    <div class="mb-3">
                        <label class="form-label">兑换方向</label>
                        <select class="form-select" id="exchangeDirection">
                            <option value="gold_to_silver">金币 → 银币 (1:100)</option>
                            <option value="silver_to_copper">银币 → 铜币 (1:100)</option>
                            <option value="diamond_to_gold">钻石 → 金币 (1:1000)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="exchangeAmount" class="form-label">兑换数量</label>
                        <input type="number" class="form-control" id="exchangeAmount" min="1" required>
                        <div class="form-text" id="exchangePreview"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="confirmExchange">确认兑换</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // 交易记录现在通过服务端渲染，不再需要AJAX加载

    // 每日签到
    $('#dailyCheckinBtn').click(function() {
        const btn = $(this);
        KanbanApp.setLoading(btn, true);

        $.post('/api/wallet/daily-checkin')
            .done(function(response) {
                if (response.success) {
                    KanbanApp.showAlert(response.message, 'success');
                    // 刷新页面以显示最新数据
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    KanbanApp.showAlert(response.message, 'warning');
                    KanbanApp.setLoading(btn, false);
                }
            })
            .fail(function(xhr) {
                const response = xhr.responseJSON;
                KanbanApp.showAlert(response?.message || '签到失败', 'danger');
                KanbanApp.setLoading(btn, false);
            });
    });



    // 货币兑换
    $('#exchangeBtn').click(function() {
        $('#exchangeModal').modal('show');
    });

    // 转账功能
    $('#transferBtn').click(function() {
        KanbanApp.showAlert('转账功能正在开发中...', 'info');
    });

    // 兑换预览
    $('#exchangeAmount, #exchangeDirection').on('input change', function() {
        updateExchangePreview();
    });

    // 确认兑换
    $('#confirmExchange').click(function() {
        KanbanApp.showAlert('货币兑换功能正在开发中...', 'info');
        $('#exchangeModal').modal('hide');
    });

    // 交易记录筛选功能已移除，现在使用分页展示所有记录
});

// 钱包数据和交易记录现在都通过服务端渲染，不再需要AJAX加载

// 更新兑换预览
function updateExchangePreview() {
    const direction = $('#exchangeDirection').val();
    const amount = parseInt($('#exchangeAmount').val()) || 0;

    if (amount <= 0) {
        $('#exchangePreview').text('');
        return;
    }

    let preview = '';
    switch (direction) {
        case 'gold_to_silver':
            preview = `将获得 ${(amount * 100).toLocaleString()} 银币`;
            break;
        case 'silver_to_copper':
            preview = `将获得 ${(amount * 100).toLocaleString()} 铜币`;
            break;
        case 'diamond_to_gold':
            preview = `将获得 ${(amount * 1000).toLocaleString()} 金币`;
            break;
    }

    $('#exchangePreview').text(preview);
}
</script>

<%- include('../partials/footer') %>

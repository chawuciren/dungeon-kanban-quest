<%- include('../partials/header', { title: title }) %>

<div class="row">
        <!-- ‰∏ªË¶ÅÂÜÖÂÆπ -->
        <div class="col-lg-8">
            <!-- È°πÁõÆÊ†áÈ¢òÂíåÂü∫Êú¨‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-body">
                    <!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
                    <nav aria-label="breadcrumb" class="mb-3">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/projects">È°πÁõÆÁÆ°ÁêÜÔºàÈ°πÁõÆÁÆ°ÁêÜÔºâ</a></li>
                            <% if (project.organizations && project.organizations.length > 0) { %>
                                <li class="breadcrumb-item"><%= project.organizations[0].name %></li>
                            <% } %>
                            <li class="breadcrumb-item active"><%= project.name %></li>
                        </ol>
                    </nav>

                    <!-- È°πÁõÆÊ†áÈ¢ò -->
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <div class="d-flex align-items-center mb-2">
                                <span class="badge bg-<%
                                    if (project.projectType === 'construction') { %>primary<%
                                    } else if (project.projectType === 'maintenance') { %>warning<%
                                    } else if (project.projectType === 'research') { %>info<%
                                    } else if (project.projectType === 'operation') { %>success<%
                                    } else { %>secondary<% } %> me-2">
                                    <%
                                    if (project.projectType === 'construction') { %>üèóÔ∏è<%
                                    } else if (project.projectType === 'maintenance') { %>üîß<%
                                    } else if (project.projectType === 'research') { %>üî¨<%
                                    } else if (project.projectType === 'operation') { %>‚öôÔ∏è<%
                                    } else { %>üìã<% } %>
                                </span>
                                <h6 class="mb-0 text-muted"><%= project.key %></h6>
                            </div>
                            <h2 class="mb-0"><%= project.name %></h2>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-<%
                                if (project.status === 'planning') { %>secondary<%
                                } else if (project.status === 'active') { %>success<%
                                } else if (project.status === 'completed') { %>dark<%
                                } else if (project.status === 'archived') { %>muted<%
                                } else { %>secondary<% } %> fs-6 mb-2">
                                <%
                                if (project.status === 'planning') { %>ËßÑÂàí‰∏≠<%
                                } else if (project.status === 'active') { %>ËøõË°å‰∏≠<%
                                } else if (project.status === 'completed') { %>Â∑≤ÂÆåÊàê<%
                                } else if (project.status === 'archived') { %>Â∑≤ÂΩíÊ°£<%
                                } else { %><%= project.status %><% } %>
                            </span>
                            <div>
                                <span class="badge bg-warning">
                                    <%= '‚≠ê'.repeat(project.starLevel) %>
                                </span>
                            </div>
                        </div>
                    </div>

                    <!-- È°πÁõÆÊèèËø∞ -->
                    <% if (project.description) { %>
                        <div class="mb-4">
                            <h5>È°πÁõÆÊèèËø∞</h5>
                            <div class="border rounded p-3 bg-light">
                                <%= project.description %>
                            </div>
                        </div>
                    <% } %>

                    <!-- È°πÁõÆÁªüËÆ° -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0"><%= stats.total %></h3>
                                    <small>ÊÄª‰ªªÂä°Êï∞</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0"><%= stats.published %></h3>
                                    <small>ÂèØÊé•Âçï</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0"><%= stats.assigned %></h3>
                                    <small>ËøõË°å‰∏≠</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-dark text-white">
                                <div class="card-body text-center">
                                    <h3 class="mb-0"><%= stats.completed %></h3>
                                    <small>Â∑≤ÂÆåÊàê</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Âø´ÈÄüÊìç‰Ωú -->
                    <div class="d-flex gap-2 flex-wrap">
                        <a href="/tasks/create?project=<%= project.id %>" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>ÂàõÂª∫‰ªªÂä°
                        </a>
                        <a href="/tasks?projectId=<%= project.id %>" class="btn btn-outline-primary">
                            <i class="fas fa-tasks me-2"></i>Êü•Áúã‰ªªÂä°
                        </a>
                        <a href="/tasks/tree?projectId=<%= project.id %>" class="btn btn-outline-secondary">
                            <i class="fas fa-sitemap me-2"></i>‰ªªÂä°Ê†ë
                        </a>
                        <a href="/tasks/kanban?projectId=<%= project.id %>" class="btn btn-outline-info">
                            <i class="fas fa-columns me-2"></i>ÁúãÊùø
                        </a>
                        <% if (user && (user.id === project.ownerId || user.id === project.leaderId || user.role === 'admin')) { %>
                            <a href="/projects/<%= project.id %>/edit" class="btn btn-outline-warning">
                                <i class="fas fa-edit me-2"></i>ÁºñËæëÈ°πÁõÆ
                            </a>
                            <a href="/projects/<%= project.id %>/members" class="btn btn-outline-info">
                                <i class="fas fa-users me-2"></i>ÊàêÂëòÁÆ°ÁêÜ
                            </a>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- ÊúÄËøë‰ªªÂä° -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>ÊúÄËøë‰ªªÂä°
                    </h5>
                </div>
                <div class="card-body">
                    <% if (recentTasks && recentTasks.length > 0) { %>
                        <div class="list-group list-group-flush">
                            <% recentTasks.forEach(task => { %>
                                <div class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h6 class="mb-1">
                                                <a href="/tasks/<%= task.id %>" class="text-decoration-none">
                                                    <%= task.title %>
                                                </a>
                                            </h6>
                                            <p class="mb-1 text-muted">
                                                <%= task.description ? (task.description.length > 100 ?
                                                    task.description.substring(0, 100) + '...' :
                                                    task.description) : 'ÊöÇÊó†ÊèèËø∞' %>
                                            </p>
                                            <small class="text-muted">
                                                ÂèëÂ∏ÉËÄÖÔºö<%= task.publisher ? (task.publisher.firstName + ' ' + task.publisher.lastName) : 'Êú™Áü•' %>
                                                <% if (task.assignee) { %>
                                                    | Êé•ÂçïËÄÖÔºö<%= task.assignee.firstName + ' ' + task.assignee.lastName %>
                                                <% } %>
                                            </small>
                                        </div>
                                        <div class="text-end">
                                            <div class="mb-1">
                                                <span class="badge bg-warning">
                                                    <%= '‚≠ê'.repeat(task.starLevel) %>
                                                </span>
                                            </div>
                                            <div class="mb-1">
                                                <span class="badge bg-<%
                                                    if (task.status === 'published') { %>success<%
                                                    } else if (task.status === 'assigned') { %>primary<%
                                                    } else if (task.status === 'completed') { %>dark<%
                                                    } else { %>secondary<% } %>">
                                                    <%
                                                    if (task.status === 'published') { %>ÂèØÊé•Âçï<%
                                                    } else if (task.status === 'assigned') { %>ËøõË°å‰∏≠<%
                                                    } else if (task.status === 'completed') { %>Â∑≤ÂÆåÊàê<%
                                                    } else { %><%= task.status %><% } %>
                                                </span>
                                            </div>
                                            <small class="text-muted">
                                                <% if (task.rewardCurrency === 'diamond') { %>üíé
                                                <% } else if (task.rewardCurrency === 'gold') { %>ü•á
                                                <% } else if (task.rewardCurrency === 'silver') { %>ü•à
                                                <% } else { %>ü•â<% } %>
                                                <%= task.totalBudget %>
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                        <div class="text-center mt-3">
                            <a href="/tasks?project=<%= project.id %>" class="btn btn-outline-primary">
                                Êü•ÁúãÂÖ®ÈÉ®‰ªªÂä°
                            </a>
                        </div>
                    <% } else { %>
                        <div class="text-center py-4">
                            <i class="fas fa-tasks fa-2x text-muted mb-3"></i>
                            <h6 class="text-muted">ÊöÇÊó†‰ªªÂä°</h6>
                            <p class="text-muted mb-3">ËøòÊ≤°ÊúâÂàõÂª∫‰ªª‰Ωï‰ªªÂä°</p>
                            <a href="/tasks/create?project=<%= project.id %>" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>ÂàõÂª∫Á¨¨‰∏Ä‰∏™‰ªªÂä°
                            </a>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>

        <!-- ‰æßËæπÊ†è -->
        <div class="col-lg-4">
            <!-- È°πÁõÆ‰ø°ÊÅØ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>È°πÁõÆ‰ø°ÊÅØ
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <strong>È°πÁõÆÊ†áËØÜÔºö</strong>
                            <span class="ms-2"><%= project.key %></span>
                        </div>
                        <div class="col-12">
                            <strong>È°πÁõÆÁ±ªÂûãÔºö</strong>
                            <span class="ms-2">
                                <%
                                if (project.projectType === 'construction') { %>üèóÔ∏è Âª∫ËÆæÈ°πÁõÆ<%
                                } else if (project.projectType === 'maintenance') { %>üîß Áª¥Êä§È°πÁõÆ<%
                                } else if (project.projectType === 'research') { %>üî¨ Á†îÂèëÈ°πÁõÆ<%
                                } else if (project.projectType === 'operation') { %>‚öôÔ∏è ËøêËê•È°πÁõÆ<%
                                } else { %>üìã ÂÖ∂‰ªñÈ°πÁõÆ<% } %>
                            </span>
                        </div>
                        <div class="col-12">
                            <strong>Ë¥üË¥£‰∫∫Ôºö</strong>
                            <span class="ms-2">
                                <%= project.leader ? (project.leader.firstName + ' ' + project.leader.lastName) : 'Êú™ÊåáÂÆö' %>
                            </span>
                        </div>
                        <div class="col-12">
                            <strong>ÂèëËµ∑‰∫∫Ôºö</strong>
                            <span class="ms-2">
                                <%= project.owner ? (project.owner.firstName + ' ' + project.owner.lastName) : 'Êú™Áü•' %>
                            </span>
                        </div>
                        <% if (project.startDate) { %>
                            <div class="col-12">
                                <strong>ÂºÄÂßãÊó∂Èó¥Ôºö</strong>
                                <span class="ms-2"><%= new Date(project.startDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <% if (project.endDate) { %>
                            <div class="col-12">
                                <strong>ÁªìÊùüÊó∂Èó¥Ôºö</strong>
                                <span class="ms-2"><%= new Date(project.endDate).toLocaleDateString('zh-CN') %></span>
                            </div>
                        <% } %>
                        <div class="col-12">
                            <strong>ÂàõÂª∫Êó∂Èó¥Ôºö</strong>
                            <span class="ms-2"><%= new Date(project.createdAt).toLocaleDateString('zh-CN') %></span>
                        </div>
                        <div class="col-12">
                            <strong>ÂèØËßÅÊÄßÔºö</strong>
                            <span class="ms-2">
                                <% if (project.visibility === 'public') { %>
                                    <span class="badge bg-success">ÂÖ¨ÂºÄ</span>
                                <% } else { %>
                                    <span class="badge bg-secondary">ÁßÅÊúâ</span>
                                <% } %>
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÂÖ≥ËÅîÁªÑÁªá -->
            <% if (project.organizations && project.organizations.length > 0) { %>
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>ÂÖ≥ËÅîÁªÑÁªá
                        </h5>
                    </div>
                    <div class="card-body">
                        <% project.organizations.forEach(org => { %>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <h6 class="mb-0"><%= org.name %></h6>
                                    <small class="text-muted">
                                        <% if (org.ProjectOrganization && org.ProjectOrganization.relationshipType === 'primary') { %>
                                            <span class="badge bg-primary">‰∏ªË¶ÅÁªÑÁªá</span>
                                        <% } else { %>
                                            <span class="badge bg-secondary">Âçè‰ΩúÁªÑÁªá</span>
                                        <% } %>
                                    </small>
                                </div>
                                <a href="/organizations/<%= org.id %>" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-external-link-alt me-1"></i>Êü•Áúã
                                </a>
                            </div>
                        <% }); %>
                    </div>
                </div>
            <% } %>

            <!-- È°πÁõÆÊàêÂëò -->
            <% if (project.members && project.members.length > 0) { %>
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>ÊàêÂëòÂõ¢Èòü
                        </h5>
                        <% if (user && (user.id === project.ownerId || user.id === project.leaderId || user.role === 'admin')) { %>
                            <a href="/projects/<%= project.id %>/members" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-cog me-1"></i>ÁÆ°ÁêÜ
                            </a>
                        <% } %>
                    </div>
                    <div class="card-body">
                        <% project.members.slice(0, 5).forEach(member => { %>
                            <div class="d-flex align-items-center mb-2">
                                <% if (member.avatar) { %>
                                    <img src="<%= member.avatar %>" alt="<%= member.firstName %> <%= member.lastName %>"
                                         class="rounded-circle me-2" style="width: 32px; height: 32px; object-fit: cover;">
                                <% } else { %>
                                    <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center me-2"
                                         style="width: 32px; height: 32px;">
                                        <i class="fas fa-user text-white small"></i>
                                    </div>
                                <% } %>
                                <div class="flex-grow-1">
                                    <div class="fw-bold small"><%= member.firstName %> <%= member.lastName %></div>
                                    <% if (member.membership && member.membership.roles) { %>
                                        <div class="small text-muted">
                                            <% member.membership.roles.slice(0, 2).forEach(role => { %>
                                                <%
                                                    const roleNames = {
                                                        'admin': 'ÁÆ°ÁêÜÂëò',
                                                        'product_manager': '‰∫ßÂìÅÁªèÁêÜ',
                                                        'developer': 'ÂºÄÂèëÂ∑•Á®ãÂ∏à',
                                                        'tester': 'ÊµãËØïÂ∑•Á®ãÂ∏à',
                                                        'ui_designer': 'UIÂ∑•Á®ãÂ∏à',
                                                        'devops': 'ËøêÁª¥Â∑•Á®ãÂ∏à',
                                                        'client': 'ÂÆ¢Êà∑'
                                                    };
                                                %>
                                                <span class="badge bg-light text-dark me-1" style="font-size: 0.7rem;">
                                                    <%= roleNames[role] || role %>
                                                </span>
                                            <% }); %>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        <% }); %>
                        <% if (project.members.length > 5) { %>
                            <div class="text-center mt-2">
                                <small class="text-muted">ËøòÊúâ <%= project.members.length - 5 %> ‰ΩçÊàêÂëò...</small>
                            </div>
                        <% } %>
                    </div>
                </div>
            <% } %>
        </div>
</div>

<%- include('../partials/footer') %>

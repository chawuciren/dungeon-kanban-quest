<!-- ä»»åŠ¡ç®¡ç†å¤´éƒ¨ -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="mb-1">
            <i class="fas fa-tasks me-2 text-primary"></i>
            <%= pageTitle || 'ä»»åŠ¡ç®¡ç†' %>
        </h2>
        <p class="text-muted mb-0">ç®¡ç†å’Œè·Ÿè¸ªé¡¹ç›®ä»»åŠ¡è¿›åº¦</p>
    </div>
    <div class="d-flex gap-2">
        <a href="/tasks/create" class="btn btn-primary">
            <i class="fas fa-plus me-2"></i>åˆ›å»ºä»»åŠ¡
        </a>
        <div class="btn-group" role="group">
            <a href="/tasks/list" class="btn btn-outline-secondary <%= (typeof currentView !== 'undefined' && currentView === 'list') ? 'active' : '' %>">
                <i class="fas fa-list me-1"></i>åˆ—è¡¨
            </a>
            <a href="/tasks/tree" class="btn btn-outline-secondary <%= (typeof currentView !== 'undefined' && currentView === 'tree') ? 'active' : '' %>">
                <i class="fas fa-sitemap me-1"></i>æ ‘å½¢
            </a>
            <a href="/tasks/kanban" class="btn btn-outline-secondary <%= (typeof currentView !== 'undefined' && currentView === 'kanban') ? 'active' : '' %>">
                <i class="fas fa-columns me-1"></i>çœ‹æ¿
            </a>
            <a href="/tasks/gantt" class="btn btn-outline-secondary <%= (typeof currentView !== 'undefined' && currentView === 'gantt') ? 'active' : '' %>">
                <i class="fas fa-chart-gantt me-1"></i>ç”˜ç‰¹å›¾
            </a>
        </div>
    </div>
</div>

<!-- ç»Ÿä¸€ç­›é€‰å™¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="GET" action="<%= (typeof currentPath !== 'undefined') ? currentPath : '/tasks' %>" id="filterForm">
                    <!-- ç¬¬ä¸€è¡Œç­›é€‰å™¨ -->
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label">æ˜Ÿçº§éš¾åº¦</label>
                            <select class="form-select" name="starLevel">
                                <option value="">å…¨éƒ¨æ˜Ÿçº§</option>
                                <option value="1" <%= (filters && filters.starLevel == '1') ? 'selected' : '' %>>â­ ä¸€æ˜Ÿ</option>
                                <option value="2" <%= (filters && filters.starLevel == '2') ? 'selected' : '' %>>â­â­ äºŒæ˜Ÿ</option>
                                <option value="3" <%= (filters && filters.starLevel == '3') ? 'selected' : '' %>>â­â­â­ ä¸‰æ˜Ÿ</option>
                                <option value="4" <%= (filters && filters.starLevel == '4') ? 'selected' : '' %>>â­â­â­â­ å››æ˜Ÿ</option>
                                <option value="5" <%= (filters && filters.starLevel == '5') ? 'selected' : '' %>>â­â­â­â­â­ äº”æ˜Ÿ</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">ç´§æ€¥ç¨‹åº¦</label>
                            <select class="form-select" name="urgencyLevel">
                                <option value="">å…¨éƒ¨ç¨‹åº¦</option>
                                <option value="urgent" <%= (filters && filters.urgencyLevel == 'urgent') ? 'selected' : '' %>>ğŸ”¥ ç´§æ€¥</option>
                                <option value="important" <%= (filters && filters.urgencyLevel == 'important') ? 'selected' : '' %>>âš¡ é‡è¦</option>
                                <option value="normal" <%= (filters && filters.urgencyLevel == 'normal') ? 'selected' : '' %>>ğŸ“… æ™®é€š</option>
                                <option value="delayed" <%= (filters && filters.urgencyLevel == 'delayed') ? 'selected' : '' %>>ğŸ• å»¶å</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">ä»»åŠ¡çŠ¶æ€</label>
                            <select class="form-select" name="status">
                                <option value="">å…¨éƒ¨çŠ¶æ€</option>
                                <option value="draft" <%= (filters && filters.status == 'draft') ? 'selected' : '' %>>è‰ç¨¿</option>
                                <option value="published" <%= (filters && filters.status == 'published') ? 'selected' : '' %>>å·²å‘å¸ƒ</option>
                                <option value="in_progress" <%= (filters && filters.status == 'in_progress') ? 'selected' : '' %>>è¿›è¡Œä¸­</option>
                                <option value="review" <%= (filters && filters.status == 'review') ? 'selected' : '' %>>å¾…å®¡æ ¸</option>
                                <option value="completed" <%= (filters && filters.status == 'completed') ? 'selected' : '' %>>å·²å®Œæˆ</option>
                                <option value="cancelled" <%= (filters && filters.status == 'cancelled') ? 'selected' : '' %>>å·²å–æ¶ˆ</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">ä»»åŠ¡ç±»å‹</label>
                            <select class="form-select" name="taskType">
                                <option value="">å…¨éƒ¨ç±»å‹</option>
                                <option value="epic" <%= (filters && filters.taskType == 'epic') ? 'selected' : '' %>>ğŸ° å²è¯—</option>
                                <option value="story" <%= (filters && filters.taskType == 'story') ? 'selected' : '' %>>ğŸ“– æ•…äº‹</option>
                                <option value="requirement" <%= (filters && filters.taskType == 'requirement') ? 'selected' : '' %>>ğŸ“‹ éœ€æ±‚</option>
                                <option value="dev_task" <%= (filters && filters.taskType == 'dev_task') ? 'selected' : '' %>>âš”ï¸ å¼€å‘</option>
                                <option value="design_task" <%= (filters && filters.taskType == 'design_task') ? 'selected' : '' %>>ğŸ¨ è®¾è®¡</option>
                                <option value="test_task" <%= (filters && filters.taskType == 'test_task') ? 'selected' : '' %>>ğŸ¹ æµ‹è¯•</option>
                                <option value="devops_task" <%= (filters && filters.taskType == 'devops_task') ? 'selected' : '' %>>âš™ï¸ è¿ç»´</option>
                                <option value="task" <%= (filters && filters.taskType == 'task') ? 'selected' : '' %>>ğŸ“ ä»»åŠ¡</option>
                                <option value="bug" <%= (filters && filters.taskType == 'bug') ? 'selected' : '' %>>ğŸ› ç¼ºé™·</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">æˆ‘çš„ä»»åŠ¡</label>
                            <select class="form-select" name="myTasks">
                                <option value="">å…¨éƒ¨ä»»åŠ¡</option>
                                <option value="assigned" <%= (filters && filters.myTasks == 'assigned') ? 'selected' : '' %>>æˆ‘è´Ÿè´£çš„</option>
                                <option value="created" <%= (filters && filters.myTasks == 'created') ? 'selected' : '' %>>æˆ‘åˆ›å»ºçš„</option>
                                <option value="participated" <%= (filters && filters.myTasks == 'participated') ? 'selected' : '' %>>æˆ‘å‚ä¸çš„</option>
                                <option value="reviewed" <%= (filters && filters.myTasks == 'reviewed') ? 'selected' : '' %>>æˆ‘å®¡æ ¸çš„</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">å½’æ¡£çŠ¶æ€</label>
                            <select class="form-select" name="archived">
                                <option value="false" <%= (!filters || !filters.archived || filters.archived == 'false') ? 'selected' : '' %>>æœªå½’æ¡£</option>
                                <option value="true" <%= (filters && filters.archived == 'true') ? 'selected' : '' %>>å·²å½’æ¡£</option>
                                <option value="all" <%= (filters && filters.archived == 'all') ? 'selected' : '' %>>å…¨éƒ¨</option>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">è´Ÿè´£äºº</label>
                            <select class="form-select" name="assigneeId">
                                <option value="">å…¨éƒ¨è´Ÿè´£äºº</option>
                                <% if (typeof projectMembers !== 'undefined' && projectMembers && projectMembers.length > 0) { %>
                                    <% projectMembers.forEach(function(member) { %>
                                        <option value="<%= member.id %>" <%= (filters && filters.assigneeId == member.id) ? 'selected' : '' %>>
                                            <%= (member.firstName + ' ' + member.lastName).trim() || member.username %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>

                        <div class="col-md-2">
                            <label class="form-label">æ‰€å±è¿­ä»£</label>
                            <select class="form-select" name="sprintId">
                                <option value="">å…¨éƒ¨è¿­ä»£</option>
                                <option value="none" <%= (filters && filters.sprintId == 'none') ? 'selected' : '' %>>æœªåˆ†é…è¿­ä»£</option>
                                <% if (typeof sprints !== 'undefined' && sprints && sprints.length > 0) { %>
                                    <% sprints.forEach(function(sprint) { %>
                                        <option value="<%= sprint.id %>" <%= (filters && filters.sprintId == sprint.id) ? 'selected' : '' %>>
                                            <%= sprint.name %>
                                            <% if (sprint.status === 'active') { %>
                                                (è¿›è¡Œä¸­)
                                            <% } else if (sprint.status === 'planning') { %>
                                                (è®¡åˆ’ä¸­)
                                            <% } else if (sprint.status === 'completed') { %>
                                                (å·²å®Œæˆ)
                                            <% } %>
                                        </option>
                                    <% }); %>
                                <% } %>
                            </select>
                        </div>
                    </div>

                    <!-- ç¬¬äºŒè¡Œç­›é€‰å™¨ -->
                    <div class="row mt-3 g-3">
                        <div class="col-md-4">
                            <label class="form-label">æœç´¢å…³é”®è¯</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="search" value="<%= (filters && filters.search) || '' %>" placeholder="æœç´¢ä»»åŠ¡æ ‡é¢˜æˆ–æè¿°...">
                                <button class="btn btn-outline-secondary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">æ’åºæ–¹å¼</label>
                            <div class="btn-group w-100" role="group">
                                <%
                                    function buildQueryString(params) {
                                        const queryParts = [];
                                        Object.keys(params).forEach(key => {
                                            if (params[key] && params[key] !== '') {
                                                queryParts.push(encodeURIComponent(key) + '=' + encodeURIComponent(params[key]));
                                            }
                                        });
                                        return queryParts.join('&');
                                    }

                                    const sortParams = filters ? {...filters} : {};
                                    delete sortParams.sort;
                                %>
                                <a href="?<%= buildQueryString({...sortParams, sort: 'created'}) %>"
                                   class="btn btn-outline-primary <%= (!filters || !filters.sort || filters.sort === '' || filters.sort === 'created') ? 'active' : '' %>">
                                    <i class="fas fa-clock me-1"></i>æœ€æ–°
                                </a>
                                <a href="?<%= buildQueryString({...sortParams, sort: 'deadline'}) %>"
                                   class="btn btn-outline-primary <%= (filters && filters.sort === 'deadline') ? 'active' : '' %>">
                                    <i class="fas fa-calendar me-1"></i>æˆªæ­¢
                                </a>
                                <a href="?<%= buildQueryString({...sortParams, sort: 'priority'}) %>"
                                   class="btn btn-outline-primary <%= (filters && filters.sort === 'priority') ? 'active' : '' %>">
                                    <i class="fas fa-star me-1"></i>ä¼˜å…ˆçº§
                                </a>
                            </div>
                        </div>

                        <div class="col-md-4 d-flex align-items-end">
                            <div class="btn-group w-100" role="group">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-filter me-1"></i>åº”ç”¨ç­›é€‰
                                </button>
                                <a href="<%= (typeof currentPath !== 'undefined') ? currentPath : '/tasks' %>" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>æ¸…é™¤ç­›é€‰
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- æ ‘å½¢è§†å›¾ç‰¹æœ‰çš„å±•å¼€/æŠ˜å æŒ‰é’® -->
                    <% if (typeof currentView !== 'undefined' && currentView === 'tree') { %>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-info btn-sm" id="expandAll">
                                        <i class="fas fa-expand-arrows-alt me-1"></i>å…¨éƒ¨å±•å¼€
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" id="collapseAll">
                                        <i class="fas fa-compress-arrows-alt me-1"></i>å…¨éƒ¨æŠ˜å 
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% } %>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* ç­›é€‰å™¨æ ·å¼ */
.form-label {
    font-weight: 500;
    font-size: 0.875rem;
    margin-bottom: 0.25rem;
}

.form-select {
    font-size: 0.875rem;
}

.btn-group .btn {
    font-size: 0.875rem;
}

.card {
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid rgba(0, 0, 0, 0.125);
}
</style>

<script>
// ç­›é€‰å™¨è‡ªåŠ¨æäº¤åŠŸèƒ½
$(document).ready(function() {
    // å»¶è¿Ÿåˆå§‹åŒ–ç­›é€‰å™¨çš„ Select2ï¼Œç¡®ä¿æ‰€æœ‰ä¾èµ–éƒ½å·²åŠ è½½
    setTimeout(function() {
        initFilterSelect2();
    }, 200);

    // ç­›é€‰è¡¨å•è‡ªåŠ¨æäº¤ï¼ˆå½“é€‰æ‹©æ¡†æ”¹å˜æ—¶ï¼‰
    $('#filterForm select').change(function() {
        $('#filterForm').submit();
    });

    // ç»‘å®š Select2 çš„ change äº‹ä»¶
    $('#filterForm select').on('select2:select select2:unselect select2:clear', function(e) {
        $('#filterForm').submit();
    });
});

// åˆå§‹åŒ–ç­›é€‰å™¨çš„ Select2 ç»„ä»¶
function initFilterSelect2() {
    console.log('å¼€å§‹åˆå§‹åŒ–ç­›é€‰å™¨ Select2 ç»„ä»¶');

    // è·å–é¡¹ç›®æˆå‘˜æ•°æ®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    const projectMembers = window.projectMembers || [];
    console.log('ç­›é€‰å™¨é¡¹ç›®æˆå‘˜æ•°æ®:', projectMembers);

    // åˆå§‹åŒ–æ‰€æœ‰ç­›é€‰å™¨ä¸‹æ‹‰æ¡†
    $('#filterForm select').each(function() {
        const $select = $(this);
        const fieldName = $select.attr('name');

        console.log('åˆå§‹åŒ–ç­›é€‰å™¨å­—æ®µ:', fieldName);

        // æ ¹æ®å­—æ®µç±»å‹è®¾ç½®ä¸åŒçš„é…ç½®
        let config = {
            placeholder: 'è¯·é€‰æ‹©...',
            allowClear: true,
            width: '100%',
            minimumResultsForSearch: Infinity // å¤§éƒ¨åˆ†ç­›é€‰å™¨ä¸éœ€è¦æœç´¢
        };

        // ç‰¹æ®Šå­—æ®µçš„é…ç½®
        switch(fieldName) {
            case 'assigneeId':
            case 'creatorId':
            case 'reviewerId':
                // ç”¨æˆ·ç›¸å…³å­—æ®µæ”¯æŒæ‹¼éŸ³æœç´¢
                config.minimumResultsForSearch = 0;

                // å¦‚æœæ˜¯ç”¨æˆ·é€‰æ‹©å™¨ä¸”æœ‰é¡¹ç›®æˆå‘˜æ•°æ®ï¼Œä¸ºé€‰é¡¹æ·»åŠ æ‹¼éŸ³ä¿¡æ¯
                if (projectMembers.length > 0) {
                    console.log('ä¸ºç”¨æˆ·é€‰æ‹©å™¨æ·»åŠ æ‹¼éŸ³ä¿¡æ¯:', fieldName);

                    // ä¿®æ”¹ç°æœ‰é€‰é¡¹çš„æ–‡æœ¬ï¼Œæ·»åŠ æ‹¼éŸ³ä¿¡æ¯
                    $select.find('option[value!=""]').each(function() {
                        const $option = $(this);
                        const userId = $option.val();
                        const currentText = $option.text().trim();

                        // æŸ¥æ‰¾å¯¹åº”çš„é¡¹ç›®æˆå‘˜
                        const member = projectMembers.find(m => m.id === userId);
                        if (member) {
                            // å»é™¤å§“åä¹‹é—´çš„ç©ºæ ¼
                            const fullName = `${member.firstName || ''}${member.lastName || ''}`.trim() || member.username || '';

                            // ç”ŸæˆåŒ…å«æ‹¼éŸ³çš„æ˜¾ç¤ºæ–‡æœ¬
                            if (window.Select2Pinyin && window.Select2Pinyin.generatePinyinText) {
                                const displayText = window.Select2Pinyin.generatePinyinText(fullName);
                                $option.text(displayText);
                                console.log('æ›´æ–°é€‰é¡¹æ–‡æœ¬:', currentText, '->', displayText);
                            }
                        }
                    });
                }
                break;
            case 'sprintId':
                // è¿­ä»£å­—æ®µæ”¯æŒæœç´¢
                config.minimumResultsForSearch = 0;
                break;
        }

        // æ™®é€š Select2 åˆå§‹åŒ–
        try {
            if (typeof Select2Pinyin !== 'undefined' && Select2Pinyin.init) {
                Select2Pinyin.init($select, config);
            } else {
                $select.select2(config);
            }
            console.log('æ™®é€š Select2 åˆå§‹åŒ–æˆåŠŸ:', fieldName);
        } catch (error) {
            console.error('Select2 åˆå§‹åŒ–å¤±è´¥:', fieldName, error);
        }
    });

    console.log('ç­›é€‰å™¨ Select2 åˆå§‹åŒ–å®Œæˆ');
}
</script>

<%- include('../partials/header', { title: title }) %>
<%- include('../helpers/roleHelper') %>

<!-- é¡µé¢æ ‡é¢˜ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>
                    <i class="fas fa-edit me-2 text-primary"></i>
                    ç¼–è¾‘ä¸ªäººèµ„æ–™
                </h2>
                <p class="text-muted mb-0">æ›´æ–°æ‚¨çš„ä¸ªäººä¿¡æ¯å’Œåå¥½è®¾ç½®</p>
            </div>
            <div>
                <a href="/profile" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    è¿”å›
                </a>
            </div>
        </div>
    </div>
</div>

<!-- é”™è¯¯æç¤º -->
<% if (typeof errorMessage !== 'undefined' && errorMessage) { %>
<div class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="fas fa-exclamation-circle me-2"></i>
    <%= errorMessage %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<% } %>

<!-- æˆåŠŸæç¤º -->
<% if (typeof successMessage !== 'undefined' && successMessage) { %>
<div class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="fas fa-check-circle me-2"></i>
    <%= successMessage %>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
<% } %>

<form action="/profile/edit" method="POST" enctype="multipart/form-data">
    <div class="row">
        <!-- åŸºæœ¬ä¿¡æ¯ -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-id-card me-2"></i>
                        åŸºæœ¬ä¿¡æ¯
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="username" class="form-label">ç”¨æˆ·å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="username" name="username"
                                   value="<%= user.username %>" required readonly>
                            <div class="form-text">ç”¨æˆ·åä¸å¯ä¿®æ”¹</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">é‚®ç®± <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" id="email" name="email"
                                   value="<%= user.email %>" required>
                            <% if (user.emailVerifiedAt) { %>
                                <div class="form-text text-success">
                                    <i class="fas fa-check-circle me-1"></i>é‚®ç®±å·²éªŒè¯
                                </div>
                            <% } else { %>
                                <div class="form-text text-warning">
                                    <i class="fas fa-exclamation-circle me-1"></i>é‚®ç®±æœªéªŒè¯
                                </div>
                            <% } %>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="firstName" class="form-label">å <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="firstName" name="firstName"
                                   value="<%= user.firstName %>" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="lastName" class="form-label">å§“ <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="lastName" name="lastName"
                                   value="<%= user.lastName %>" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">ç”µè¯</label>
                            <input type="tel" class="form-control" id="phone" name="phone"
                                   value="<%= user.phone || '' %>">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted">é»˜è®¤èŒä¸š</label>
                            <div class="fw-bold">
                                <%
                                    const currentRole = roles.find(r => r.value === user.role) || { icon: 'â“', alias: 'æœªçŸ¥', name: 'æœªçŸ¥èŒä¸š' };
                                %>
                                <%= currentRole.icon %> <%= currentRole.alias %> (<%= currentRole.name %>)
                            </div>
                            <div class="form-text text-muted">èŒä¸šç”±ç®¡ç†å‘˜åœ¨é¡¹ç›®çº§åˆ«ç®¡ç†ï¼Œæ— æ³•è‡ªè¡Œä¿®æ”¹</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åå¥½è®¾ç½® -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cog me-2"></i>
                        åå¥½è®¾ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="timezone" class="form-label">æ—¶åŒº</label>
                            <select class="form-select" id="timezone" name="timezone">
                                <option value="Asia/Shanghai" <%= user.timezone === 'Asia/Shanghai' ? 'selected' : '' %>>
                                    Asia/Shanghai (ä¸­å›½æ ‡å‡†æ—¶é—´)
                                </option>
                                <option value="Asia/Tokyo" <%= user.timezone === 'Asia/Tokyo' ? 'selected' : '' %>>
                                    Asia/Tokyo (æ—¥æœ¬æ ‡å‡†æ—¶é—´)
                                </option>
                                <option value="Asia/Seoul" <%= user.timezone === 'Asia/Seoul' ? 'selected' : '' %>>
                                    Asia/Seoul (éŸ©å›½æ ‡å‡†æ—¶é—´)
                                </option>
                                <option value="UTC" <%= user.timezone === 'UTC' ? 'selected' : '' %>>
                                    UTC (åè°ƒä¸–ç•Œæ—¶)
                                </option>
                                <option value="America/New_York" <%= user.timezone === 'America/New_York' ? 'selected' : '' %>>
                                    America/New_York (ç¾å›½ä¸œéƒ¨æ—¶é—´)
                                </option>
                                <option value="America/Los_Angeles" <%= user.timezone === 'America/Los_Angeles' ? 'selected' : '' %>>
                                    America/Los_Angeles (ç¾å›½è¥¿éƒ¨æ—¶é—´)
                                </option>
                                <option value="Europe/London" <%= user.timezone === 'Europe/London' ? 'selected' : '' %>>
                                    Europe/London (è‹±å›½æ—¶é—´)
                                </option>
                                <option value="Europe/Paris" <%= user.timezone === 'Europe/Paris' ? 'selected' : '' %>>
                                    Europe/Paris (æ¬§æ´²ä¸­éƒ¨æ—¶é—´)
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="language" class="form-label">è¯­è¨€</label>
                            <select class="form-select" id="language" name="language">
                                <option value="zh-CN" <%= user.language === 'zh-CN' ? 'selected' : '' %>>
                                    ç®€ä½“ä¸­æ–‡
                                </option>
                                <option value="en-US" <%= user.language === 'en-US' ? 'selected' : '' %>>
                                    English (US)
                                </option>
                                <option value="ja-JP" <%= user.language === 'ja-JP' ? 'selected' : '' %>>
                                    æ—¥æœ¬èª
                                </option>
                                <option value="ko-KR" <%= user.language === 'ko-KR' ? 'selected' : '' %>>
                                    í•œêµ­ì–´
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-muted">æŠ€èƒ½ç­‰çº§</label>
                            <div class="fw-bold">
                                <%
                                    const skillLevelConfig = {
                                        'novice': { name: 'æ–°æ‰‹', icon: 'ğŸ”°', color: 'secondary' },
                                        'bronze': { name: 'é“œç‰Œ', icon: 'ğŸ¥‰', color: 'warning' },
                                        'silver': { name: 'é“¶ç‰Œ', icon: 'ğŸ¥ˆ', color: 'info' },
                                        'gold': { name: 'é‡‘ç‰Œ', icon: 'ğŸ¥‡', color: 'warning' },
                                        'diamond': { name: 'é’»çŸ³', icon: 'ğŸ’', color: 'primary' }
                                    };
                                    const currentSkill = skillLevelConfig[user.skillLevel] || { name: 'æœªçŸ¥', icon: 'â“', color: 'secondary' };
                                %>
                                <span class="badge bg-<%= currentSkill.color %> fs-6">
                                    <%= currentSkill.icon %> <%= currentSkill.name %>
                                </span>
                            </div>
                            <div class="form-text text-muted">æŠ€èƒ½ç­‰çº§æ ¹æ®ä»»åŠ¡å®Œæˆæƒ…å†µè‡ªåŠ¨æå‡ï¼Œæ— æ³•æ‰‹åŠ¨ä¿®æ”¹</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- å¯†ç ä¿®æ”¹ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-lock me-2"></i>
                        å¯†ç ä¿®æ”¹
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        å¦‚æœä¸éœ€è¦ä¿®æ”¹å¯†ç ï¼Œè¯·ç•™ç©ºä»¥ä¸‹å­—æ®µ
                    </div>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="currentPassword" class="form-label">å½“å‰å¯†ç </label>
                            <input type="password" class="form-control" id="currentPassword" name="currentPassword">
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newPassword" class="form-label">æ–°å¯†ç </label>
                            <input type="password" class="form-control" id="newPassword" name="newPassword">
                            <div class="form-text">å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦</div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="confirmPassword" class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                            <input type="password" class="form-control" id="confirmPassword" name="confirmPassword">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å¤´åƒå’Œæ“ä½œ -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-image me-2"></i>
                        å¤´åƒè®¾ç½®
                    </h5>
                </div>
                <div class="card-body text-center">
                    <!-- å½“å‰å¤´åƒ -->
                    <div class="mb-3">
                        <% if (user.avatar) { %>
                            <img src="<%= user.avatar %>" alt="å¤´åƒ" class="rounded-circle" width="120" height="120" id="avatarPreview">
                        <% } else { %>
                            <div class="bg-primary rounded-circle d-inline-flex align-items-center justify-content-center"
                                 style="width: 120px; height: 120px;" id="avatarPreview">
                                <i class="fas fa-user fa-3x text-white"></i>
                            </div>
                        <% } %>
                    </div>

                    <!-- å¤´åƒä¸Šä¼  -->
                    <div class="mb-3">
                        <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                        <div class="form-text">æ”¯æŒ JPGã€PNG æ ¼å¼ï¼Œæœ€å¤§ 2MB</div>
                    </div>

                    <!-- ç§»é™¤å¤´åƒ -->
                    <% if (user.avatar) { %>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="removeAvatar" name="removeAvatar" value="1">
                        <label class="form-check-label" for="removeAvatar">
                            ç§»é™¤å½“å‰å¤´åƒ
                        </label>
                    </div>
                    <% } %>
                </div>
            </div>

            <!-- æ“ä½œæŒ‰é’® -->
            <div class="card">
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary" id="saveButton">
                            <i class="fas fa-save me-1"></i>
                            ä¿å­˜ä¿®æ”¹
                        </button>
                        <a href="/profile" class="btn btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>
                            å–æ¶ˆ
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</form>

<!-- å¤´åƒé¢„è§ˆå’Œè¡¨å•éªŒè¯è„šæœ¬ -->
<script>
// å¤´åƒé¢„è§ˆ
document.getElementById('avatar').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (file) {
        // æ£€æŸ¥æ–‡ä»¶å¤§å°
        if (file.size > 2 * 1024 * 1024) {
            alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2MB');
            this.value = '';
            return;
        }

        // æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if (!file.type.startsWith('image/')) {
            alert('åªèƒ½ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶');
            this.value = '';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('avatarPreview');
            preview.innerHTML = `<img src="${e.target.result}" alt="å¤´åƒé¢„è§ˆ" class="rounded-circle" width="120" height="120">`;
        };
        reader.readAsDataURL(file);
    }
});

// å¯†ç ç¡®è®¤éªŒè¯
document.getElementById('confirmPassword').addEventListener('input', function() {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = this.value;

    if (newPassword && confirmPassword && newPassword !== confirmPassword) {
        this.setCustomValidity('å¯†ç ä¸åŒ¹é…');
        this.classList.add('is-invalid');
    } else {
        this.setCustomValidity('');
        this.classList.remove('is-invalid');
    }
});

// æ–°å¯†ç è¾“å…¥æ—¶ä¹Ÿè¦æ£€æŸ¥ç¡®è®¤å¯†ç 
document.getElementById('newPassword').addEventListener('input', function() {
    const confirmPassword = document.getElementById('confirmPassword');
    if (confirmPassword.value) {
        confirmPassword.dispatchEvent(new Event('input'));
    }
});

// è¡¨å•æäº¤ç¡®è®¤
document.querySelector('form').addEventListener('submit', function(e) {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;

    // å¦‚æœå¡«å†™äº†ä»»ä½•å¯†ç å­—æ®µï¼Œæ£€æŸ¥æ˜¯å¦å®Œæ•´
    if (currentPassword || newPassword || confirmPassword) {
        if (!currentPassword || !newPassword || !confirmPassword) {
            e.preventDefault();
            alert('ä¿®æ”¹å¯†ç æ—¶ï¼Œè¯·å¡«å†™å®Œæ•´çš„å¯†ç ä¿¡æ¯');
            return;
        }

        if (newPassword !== confirmPassword) {
            e.preventDefault();
            alert('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸åŒ¹é…');
            return;
        }

        if (newPassword.length < 6) {
            e.preventDefault();
            alert('æ–°å¯†ç é•¿åº¦è‡³å°‘6ä¸ªå­—ç¬¦');
            return;
        }

        // ç¡®è®¤å¯†ç ä¿®æ”¹
        if (!confirm('æ‚¨ç¡®å®šè¦ä¿®æ”¹å¯†ç å—ï¼Ÿ')) {
            e.preventDefault();
            return;
        }
    }

    // ç¡®è®¤ä¿å­˜ä¿®æ”¹
    if (!confirm('ç¡®å®šè¦ä¿å­˜è¿™äº›ä¿®æ”¹å—ï¼Ÿ')) {
        e.preventDefault();
        return;
    }
});

// ç§»é™¤å¤´åƒç¡®è®¤
document.getElementById('removeAvatar')?.addEventListener('change', function() {
    if (this.checked) {
        if (!confirm('ç¡®å®šè¦ç§»é™¤å½“å‰å¤´åƒå—ï¼Ÿ')) {
            this.checked = false;
        }
    }
});
</script>

<%- include('../partials/footer') %>
